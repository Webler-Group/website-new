import { ChangeEvent, useEffect, useState } from "react";
import { Container, Row, Col, Card, Form, Button, InputGroup } from "react-bootstrap";
import { FaPlus } from "react-icons/fa6";
import { useNavigate, useSearchParams } from "react-router-dom";
import { useAuth } from "../../auth/context/authContext";
import { TagSearch, WeblerBadge } from "../../../components/InputTags";
import { useApi } from "../../../context/apiCommunication";
import { PaginationControl } from "react-bootstrap-pagination-control";
import IChallenge, { challenge_diff_t, IChallengeFilter } from "../IChallenge";
import allowedUrls from "../../../data/discussAllowedUrls";
import MarkdownRenderer from "../../../components/MarkdownRenderer";
import { SelectFormField } from "../../../components/FormField";
import { EllipsisLoaderPlaceholder } from "../../../components/Loader";
import useListView from "../../../components/hooks/useListView";


const ChallengeList = () => {

    const {
        items,
        setItems
    } = useListView<IChallenge>();

    const { sendJsonRequest } = useApi();
    const { userInfo } = useAuth();
    const navigate = useNavigate();
    const [challenges, setChallenges] = useState<any[]>([]);
    const challengesPerPage = 10;
    const [currentPage, setCurrentPage] = useState(1);
    const [challengeCount, setChallengeCount] = useState(0);
    const [loading, setLoading] = useState(false);
    const [filter, setFilter] = useState(1);
    const [searchQuery, setSearchQuery] = useState("");
    const [searchParams, setSearchParams] = useSearchParams();

    useEffect(() => {
        getChallenges();
    }, [searchParams]);


    useEffect(() => {
        handlePageChange(1);
    }, [filter, searchQuery]);

    useEffect(() => {
        if (searchParams.has("page")) {
            setCurrentPage(Number(searchParams.get("page")))
        }
        if (searchParams.has("filter")) {
            setFilter(Number(searchParams.get("filter")))
        }
        if (searchParams.has("query")) {
            setSearchQuery(searchParams.get("query")!)
        }
    }, []);

    const handlePageChange = (page: number) => {
        if (currentPage === page) {
            return
        }
        searchParams.set("page", page.toString());
        setSearchParams(searchParams, { replace: true })
        setCurrentPage(page);
    }

    const handleSearch = (value: string) => {
        searchParams.set("query", value);
        setSearchParams(searchParams, { replace: true });
        setSearchQuery(value);
    }
    
    const getChallenges = async () => {
        setLoading(true);
        const page = searchParams.has("page") ? Number(searchParams.get("page")) : 1;
        const searchQuery = searchParams.has("query") ? searchParams.get("query")! : "";
        const result = await sendJsonRequest(`/Challenge`, "POST", {
            page,
            count: challengesPerPage,
            filter,
            searchQuery,
        });

        if (result && result.challenges) {
            setChallenges(result.challenges);
            setChallengeCount(result.count);
        }

        setLoading(false);
    }

    const handleFilterSelect = (e: ChangeEvent) => {
        const value = Number((e.target as HTMLSelectElement).selectedOptions[0].value)
        searchParams.set("filter", value.toString())
        setSearchParams(searchParams, { replace: true })
        setFilter(value)
    }


    return (
        <Container className="py-4 position-relative">
            <TagSearch
                placeholder="Search by tags or title..."
                maxWidthPx={360}
                query={searchQuery}
                handleSearch={handleSearch}
            />

            <div className="mt-2 d-flex justify-content-between">
                {/* <SelectFormField options={diffOptions} onChange={handleDifficultySelect} value={""} />
                <Form.Select style={{ width: "140px" }} size='sm'  onChange={handleSolvedSelect}>
                    <option value="solved">Solved</option>
                    <option value="unsolved" selected>Unsolved</option>
                </Form.Select> */}
            </div>

            <div className="mt-2">
                {
                    loading ?
                        <EllipsisLoaderPlaceholder />
                        :
                        challengeCount == 0 ?
                            <div className="wb-discuss-empty-questions">
                                <h3>Nothing to show</h3>
                            </div>
                            :
                            <Row className="mt-3">
                                {challenges.map((c, idx) => (
                                <Col md={6} lg={4} key={idx} className="mb-3">
                                    <Card className="shadow-sm h-100">
                                    <Card.Body onClick={() => { navigate("./" + c._id) }} style={{cursor:"pointer"}}>
                                        <Card.Title>{c.title}</Card.Title>
                                        <Card.Text>
                                            <MarkdownRenderer content={(c.description as string).substring(0, 30)} allowedUrls={allowedUrls} />
                                        </Card.Text>
                                        <div className="d-flex flex-wrap gap-2">
                                            <span className="bg-success-subtle text-success p-1 rounded">{c.difficulty}</span>
                                            <span className="bg-success-subtle text-success p-1 rounded">{c.xp}</span>
                                        </div>
                                    </Card.Body>
                                    </Card>
                                </Col>
                                ))}
                            </Row>

                }
            </div>

            <div className='my-3'>
                <PaginationControl
                    page={currentPage}
                    between={3}
                    total={challengeCount}
                    limit={challengesPerPage}
                    changePage={handlePageChange}
                    ellipsis={1}
                />
            </div>

            {
                userInfo && userInfo.roles.some(role => ["Admin", "Creator"].includes(role)) &&
                <Button
                    variant="success"
                    className="position-fixed bottom-0 end-0 m-4 rounded-pill d-flex align-items-center"
                    style={{ zIndex: 1050 }}
                    onClick = {() => { navigate("./Create") }}
                >
                    <span className="d-none d-md-inline">+ Create Challenge</span>
                    <FaPlus className="d-inline d-md-none" size={24} />
                </Button>
            }
        
        </Container>
    );
};

export default ChallengeList;
