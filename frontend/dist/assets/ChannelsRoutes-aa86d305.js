import{R as U,j as e,P as ee,D as Ge,u as te,r as n,a as ye,b as Ee,C as Re,c as se,B as T,F as rs,d as we,N as V,A as ke,L as be,_ as Be,f as as,e as He,T as is,g as Ve,h as ls,i as os,k as Le,l as Ue,m as q,n as cs,o as Pe,p as $e,q as Je,I as ds,s as us,t as ms,v as hs,w as xe,x as fs,y as xs,z as gs,E as vs,G as ps,H as js,J as Cs,K as Ns,M as ws,O as bs,Q as ge,S as ys,U as Es,V as Ms}from"./index-6cb5912a.js";import{r as Ss}from"./roles-68ed67e6.js";import{t as De}from"./StringUtils-91be14c5.js";import{M as A}from"./Modal-5235d110.js";import{T as $}from"./Tab-beec5ddd.js";import{P as Is,U as As,L as le}from"./UserSearch-213e907f.js";import{T as Ts}from"./ToggleSwitch-a4142d66.js";const _e=U.forwardRef(({channel:s,onClick:r,selected:a},t)=>{let i=e.jsxs("div",{className:`d-flex align-items-center gap-2 p-2 border-bottom cursor-pointer ${a?"border border-2 border-dark":"border-bottom"}`,onClick:r,style:{cursor:"pointer"},children:[s.type==2?e.jsx("img",{src:"/resources/images/group.svg",alt:"channel avatar",className:"me-2 rounded-circle",width:32,height:32}):e.jsx(ee,{size:32,avatarImage:s.coverImage}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"fw-bold",children:s.title}),e.jsx("div",{className:"small text-muted",children:Ge.format2(new Date(s.updatedAt))})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"small",children:s.lastMessage!=null&&(s.lastMessage.type===1?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"text-primary",children:[s.lastMessage.userName,": "]}),s.lastMessage.deleted?e.jsx("i",{className:"text-muted",children:"Message was deleted"}):e.jsx("span",{className:"text-muted",children:De(s.lastMessage.content,20)})]}):e.jsx("span",{className:"text-muted",children:De(s.lastMessage.content.replace("{action_user}",s.lastMessage.userName),20)}))}),e.jsx("div",{children:s.unreadCount>0&&e.jsx("span",{className:"badge "+(s.muted?"bg-secondary":"bg-danger"),style:{fontSize:"0.7rem"},children:s.unreadCount>99?"99+":s.unreadCount})})]})]})]});return t?e.jsx("div",{ref:t,children:i}):e.jsx("div",{children:i})}),Rs=(s,r,a)=>{const{sendJsonRequest:t}=te(),[i,l]=n.useState([]),[d,m]=n.useState(!1),[u,g]=n.useState(""),[h,C]=n.useState(!1),{socket:y}=ye(),M=n.useRef([]),{userInfo:_}=Ee(),o=n.useRef(a);return n.useEffect(()=>{o.current=a},[a]),n.useEffect(()=>{M.current=i},[i]),n.useEffect(()=>{(async()=>{m(!0),g("");const p=await t("/Channels","POST",{fromDate:r,count:s});p&&p.channels?(l(R=>[...R,...p.channels]),C(p.channels.length===s)):g((p==null?void 0:p.error[0].message)??"Something went wrong"),m(!1)})()},[r]),n.useEffect(()=>{if(!y)return;const N=async w=>{var b;const S=M.current.find(j=>j.id===w.channelId);if(w.type===3&&w.userId===(_==null?void 0:_.id)){l(j=>j.filter(P=>P.id!==w.channelId)),(b=o.current)==null||b.call(o,w.channelId);return}if(S)l(j=>{const P=j.map(x=>x.id===w.channelId?{...x,updatedAt:w.createdAt,unreadCount:x.unreadCount+1,lastMessage:w,title:w.type==4?w.channelTitle:x.title}:x),D=P.find(x=>x.id===w.channelId),G=P.filter(x=>x.id!==w.channelId);return D?[D,...G]:P});else{const j=await t("/Channels/GetChannel","POST",{channelId:w.channelId});j&&j.channel&&l(P=>[{...j.channel,lastMessage:w},...P])}},p=w=>{l(S=>S.map(b=>b.id===w.channelId?{...b,lastMessage:b.lastMessage?{...b.lastMessage,viewed:!0}:void 0,unreadCount:0}:b))},R=w=>{var S;l(b=>b.filter(j=>j.id!==w.channelId)),(S=o.current)==null||S.call(o,w.channelId)},O=w=>{l(S=>S.map(b=>b.id===w.channelId?{...b,lastMessage:b.lastMessage&&b.lastMessage.id==w.messageId?{...b.lastMessage,deleted:!0,content:""}:void 0}:b))},L=w=>{l(S=>S.map(b=>b.id===w.channelId?{...b,lastMessage:b.lastMessage&&b.lastMessage.id==w.messageId?{...b.lastMessage,content:w.content}:void 0}:b))};return y.on("channels:new_message",N),y.on("channels:messages_seen",p),y.on("channels:channel_deleted",R),y.on("channels:message_deleted",O),y.on("channels:message_edited",L),()=>{y.off("channels:new_message",N),y.off("channels:messages_seen",p),y.off("channels:channel_deleted",R),y.off("channels:message_deleted",O),y.off("channels:message_edited",L)}},[y]),{isLoading:d,error:u,results:i,hasNextPage:h,addChannel:N=>{l(p=>[N,...p])}}},ks=(s,r)=>{const{sendJsonRequest:a}=te(),[t,i]=n.useState([]),[l,d]=n.useState(0),[m,u]=n.useState(!1),[g,h]=n.useState(""),[C,y]=n.useState(!1),{socket:M}=ye();return n.useEffect(()=>{(async()=>{u(!0),h("");const N=await a("/Channels/Invites","POST",{fromDate:r,count:s});N&&N.invites?(i(p=>[...p,...N.invites]),d(N.count),y(N.invites.length===s)):h((N==null?void 0:N.error[0].message)??"Something went wrong"),u(!1)})()},[r]),n.useEffect(()=>{if(!M)return;const E=p=>{i(R=>[p,...R]),d(R=>R+1)},N=p=>{i(R=>R.filter(O=>O.id!==p.inviteId)),d(R=>R-1)};return M.on("channels:new_invite",E),M.on("channels:invite_canceled",N),()=>{M.off("channels:new_invite",E),M.off("channels:invite_canceled",N)}},[M]),{isLoading:m,error:g,results:t,totalCount:l,hasNextPage:C,add:E=>{i(N=>[E,...N])},remove:E=>{i(N=>N.filter(p=>p.id!==E)),d(N=>N-1)}}},Fe=U.forwardRef(({invite:s,onAccept:r,onDecline:a},t)=>{let i=e.jsx(Re,{className:"mb-3",children:e.jsxs(Re.Body,{className:"d-flex align-items-center gap-2",children:[e.jsx(ee,{avatarImage:s.authorAvatar,size:42}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("div",{children:e.jsx("strong",{children:s.channelTitle})}),e.jsxs("div",{className:"text-muted small",children:["Invited by ",e.jsx(se,{userId:s.authorId,userName:s.authorName})]})]}),e.jsxs("div",{className:"d-flex flex-column gap-2 ms-3",children:[e.jsx(T,{variant:"success",size:"sm",onClick:()=>r(s.id),children:"Accept"}),e.jsx(T,{variant:"outline-danger",size:"sm",onClick:()=>a(s.id),children:"Decline"})]})]})});return t?e.jsx("div",{ref:t,children:i}):e.jsx("div",{children:i})}),Ls=({onChannelSelect:s,currentChannelId:r,onExit:a})=>{const[t,i]=n.useState("channels"),[l,d]=n.useState(""),[m,u]=n.useState(),[g,h]=n.useState(!1),{sendJsonRequest:C}=te(),[y,M]=n.useState(null),_=n.useCallback(x=>{r===x&&a()},[r]),o=Rs(10,y,_),[E,N]=n.useState(null),p=ks(10,E),R=n.useRef(),O=n.useCallback(x=>{o.isLoading||(R.current&&R.current.disconnect(),R.current=new IntersectionObserver(I=>{I[0].isIntersecting&&o.hasNextPage&&M(()=>new Date(o.results[o.results.length-1].updatedAt))}),x&&R.current.observe(x))},[o.isLoading,o.hasNextPage,o.results]),L=n.useRef(),w=n.useCallback(x=>{p.isLoading||(L.current&&L.current.disconnect(),L.current=new IntersectionObserver(I=>{I[0].isIntersecting&&p.hasNextPage&&N(()=>new Date(p.results[p.results.length-1].createdAt))}),x&&L.current.observe(x))},[p.isLoading,p.hasNextPage,p.results]),S=async()=>{const x=await C("/Channels/CreateGroup","POST",{title:l});x&&x.channel?(o.addChannel(x.channel),b(),d("")):u(x.error)},b=()=>{d(""),u(void 0),h(!1)},j=async x=>{const I=await C("/Channels/AcceptInvite","POST",{inviteId:x,accepted:!0});I&&I.success&&(p.remove(x),i("channels"))},P=async x=>{const I=await C("/Channels/AcceptInvite","POST",{inviteId:x,accepted:!1});I&&I.success&&p.remove(x)},D=o.results.map((x,I)=>{const B=x.id===r;return e.jsx("div",{children:o.results.length===I+1?e.jsx(_e,{ref:O,channel:x,onClick:()=>s(x.id),selected:B}):e.jsx(_e,{channel:x,onClick:()=>s(x.id),selected:B})},x.id)}),G=p.results.map((x,I)=>e.jsx("div",{className:"mt-2",children:o.results.length===I+1?e.jsx(Fe,{ref:w,invite:x,onAccept:j,onDecline:P}):e.jsx(Fe,{invite:x,onAccept:j,onDecline:P})},x.id));return e.jsxs(e.Fragment,{children:[e.jsxs(A,{show:g,onHide:b,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Create group"})}),e.jsxs(A.Body,{children:[e.jsx("p",{children:"How would you like to name your group?"}),e.jsx(rs,{className:"my-2",type:"text",placeholder:"Group title",value:l,onChange:x=>d(x.target.value)}),e.jsx(we,{errors:m})]}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:b,children:"Cancel"}),e.jsx(T,{variant:"primary",onClick:S,disabled:l.length<3,children:"Create"})]})]}),e.jsxs("div",{className:"d-flex flex-column p-2",children:[e.jsx("div",{className:"mb-3",children:e.jsx(T,{variant:"primary",onClick:()=>h(!0),children:"+ Create Group"})}),e.jsxs($.Container,{activeKey:t,onSelect:x=>i(x||"channels"),children:[e.jsxs(V,{variant:"pills",className:"mb-3 gap-2",children:[e.jsx(V.Item,{className:"position-relative",children:e.jsx(V.Link,{className:"border border-primary",eventKey:"channels",children:"Channels"})}),e.jsxs(V.Item,{className:"position-relative",children:[e.jsx(V.Link,{className:"border border-primary",eventKey:"invites",children:"Invites"}),p.totalCount>0&&e.jsxs("span",{className:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",children:[p.totalCount>99?"99+":p.totalCount,e.jsx("span",{className:"visually-hidden",children:"pending invites"})]})]})]}),e.jsxs($.Content,{className:"flex-grow-1 overflow-auto pb-4",children:[e.jsxs($.Pane,{eventKey:"channels",children:[!o.isLoading&&o.error!==""?e.jsx(ke,{variant:"danger",children:o.error}):!o.isLoading&&o.results.length===0?e.jsx("div",{className:"text-center text-muted mt-5",children:"You have no channels yet. Create a group or wait for invites!"}):D,o.isLoading&&e.jsx("div",{className:"d-flex justify-content-center mt-5 text-center",children:e.jsx(be,{})})]}),e.jsxs($.Pane,{eventKey:"invites",children:[!p.isLoading&&p.error!==""?e.jsx(ke,{variant:"danger",children:p.error}):!p.isLoading&&p.results.length===0?e.jsx("div",{className:"text-center text-muted mt-5",children:"You have no pending invites."}):G,p.isLoading&&e.jsx("div",{className:"d-flex justify-content-center mt-5 text-center",children:e.jsx(be,{})})]})]})]})]})]})};var Ps=function(r,a){return r&&a&&a.split(" ").forEach(function(t){return ls(r,t)})},Ne=function(r,a){return r&&a&&a.split(" ").forEach(function(t){return os(r,t)})},Me=function(s){Be(r,s);function r(){for(var t,i=arguments.length,l=new Array(i),d=0;d<i;d++)l[d]=arguments[d];return t=s.call.apply(s,[this].concat(l))||this,t.appliedClasses={appear:{},enter:{},exit:{}},t.onEnter=function(m,u){var g=t.resolveArguments(m,u),h=g[0],C=g[1];t.removeClasses(h,"exit"),t.addClass(h,C?"appear":"enter","base"),t.props.onEnter&&t.props.onEnter(m,u)},t.onEntering=function(m,u){var g=t.resolveArguments(m,u),h=g[0],C=g[1],y=C?"appear":"enter";t.addClass(h,y,"active"),t.props.onEntering&&t.props.onEntering(m,u)},t.onEntered=function(m,u){var g=t.resolveArguments(m,u),h=g[0],C=g[1],y=C?"appear":"enter";t.removeClasses(h,y),t.addClass(h,y,"done"),t.props.onEntered&&t.props.onEntered(m,u)},t.onExit=function(m){var u=t.resolveArguments(m),g=u[0];t.removeClasses(g,"appear"),t.removeClasses(g,"enter"),t.addClass(g,"exit","base"),t.props.onExit&&t.props.onExit(m)},t.onExiting=function(m){var u=t.resolveArguments(m),g=u[0];t.addClass(g,"exit","active"),t.props.onExiting&&t.props.onExiting(m)},t.onExited=function(m){var u=t.resolveArguments(m),g=u[0];t.removeClasses(g,"exit"),t.addClass(g,"exit","done"),t.props.onExited&&t.props.onExited(m)},t.resolveArguments=function(m,u){return t.props.nodeRef?[t.props.nodeRef.current,m]:[m,u]},t.getClassNames=function(m){var u=t.props.classNames,g=typeof u=="string",h=g&&u?u+"-":"",C=g?""+h+m:u[m],y=g?C+"-active":u[m+"Active"],M=g?C+"-done":u[m+"Done"];return{baseClassName:C,activeClassName:y,doneClassName:M}},t}var a=r.prototype;return a.addClass=function(i,l,d){var m=this.getClassNames(l)[d+"ClassName"],u=this.getClassNames("enter"),g=u.doneClassName;l==="appear"&&d==="done"&&g&&(m+=" "+g),d==="active"&&i&&as(i),m&&(this.appliedClasses[l][d]=m,Ps(i,m))},a.removeClasses=function(i,l){var d=this.appliedClasses[l],m=d.base,u=d.active,g=d.done;this.appliedClasses[l]={},m&&Ne(i,m),u&&Ne(i,u),g&&Ne(i,g)},a.render=function(){var i=this.props;i.classNames;var l=He(i,["classNames"]);return U.createElement(is,Ve({},l,{onEnter:this.onEnter,onEntered:this.onEntered,onEntering:this.onEntering,onExit:this.onExit,onExiting:this.onExiting,onExited:this.onExited}))},r}(U.Component);Me.defaultProps={classNames:""};Me.propTypes={};const Ds=Me;function _s(s){if(s===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return s}function Se(s,r){var a=function(l){return r&&n.isValidElement(l)?r(l):l},t=Object.create(null);return s&&n.Children.map(s,function(i){return i}).forEach(function(i){t[i.key]=a(i)}),t}function Fs(s,r){s=s||{},r=r||{};function a(h){return h in r?r[h]:s[h]}var t=Object.create(null),i=[];for(var l in s)l in r?i.length&&(t[l]=i,i=[]):i.push(l);var d,m={};for(var u in r){if(t[u])for(d=0;d<t[u].length;d++){var g=t[u][d];m[t[u][d]]=a(g)}m[u]=a(u)}for(d=0;d<i.length;d++)m[i[d]]=a(i[d]);return m}function Y(s,r,a){return a[r]!=null?a[r]:s.props[r]}function Os(s,r){return Se(s.children,function(a){return n.cloneElement(a,{onExited:r.bind(null,a),in:!0,appear:Y(a,"appear",s),enter:Y(a,"enter",s),exit:Y(a,"exit",s)})})}function zs(s,r,a){var t=Se(s.children),i=Fs(r,t);return Object.keys(i).forEach(function(l){var d=i[l];if(n.isValidElement(d)){var m=l in r,u=l in t,g=r[l],h=n.isValidElement(g)&&!g.props.in;u&&(!m||h)?i[l]=n.cloneElement(d,{onExited:a.bind(null,d),in:!0,exit:Y(d,"exit",s),enter:Y(d,"enter",s)}):!u&&m&&!h?i[l]=n.cloneElement(d,{in:!1}):u&&m&&n.isValidElement(g)&&(i[l]=n.cloneElement(d,{onExited:a.bind(null,d),in:g.props.in,exit:Y(d,"exit",s),enter:Y(d,"enter",s)}))}}),i}var Gs=Object.values||function(s){return Object.keys(s).map(function(r){return s[r]})},Bs={component:"div",childFactory:function(r){return r}},Ie=function(s){Be(r,s);function r(t,i){var l;l=s.call(this,t,i)||this;var d=l.handleExited.bind(_s(l));return l.state={contextValue:{isMounting:!0},handleExited:d,firstRender:!0},l}var a=r.prototype;return a.componentDidMount=function(){this.mounted=!0,this.setState({contextValue:{isMounting:!1}})},a.componentWillUnmount=function(){this.mounted=!1},r.getDerivedStateFromProps=function(i,l){var d=l.children,m=l.handleExited,u=l.firstRender;return{children:u?Os(i,m):zs(i,d,m),firstRender:!1}},a.handleExited=function(i,l){var d=Se(this.props.children);i.key in d||(i.props.onExited&&i.props.onExited(l),this.mounted&&this.setState(function(m){var u=Ve({},m.children);return delete u[i.key],{children:u}}))},a.render=function(){var i=this.props,l=i.component,d=i.childFactory,m=He(i,["component","childFactory"]),u=this.state.contextValue,g=Gs(this.state.children).map(d);return delete m.appear,delete m.enter,delete m.exit,l===null?U.createElement(Le.Provider,{value:u},g):U.createElement(Le.Provider,{value:u},U.createElement(l,m,g))},r}(U.Component);Ie.propTypes={};Ie.defaultProps=Bs;const Hs=Ie,We=({message:s})=>{const[r,a]=n.useState(!1),t=n.useRef(null),i=()=>{a(!r)};return n.useEffect(()=>{r&&t.current&&setTimeout(()=>{var l;(l=t.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})},50)},[r]),e.jsx(e.Fragment,{children:e.jsxs("div",{ref:t,className:"small",children:[e.jsxs("div",{className:"d-flex gap-1 align-items-start",children:[e.jsx(Ue,{className:"flex-shrink-0"}),e.jsx(ee,{size:20,avatarImage:s.userAvatar}),e.jsx(se,{userId:s.userId,userName:"@"+s.userName}),s.deleted?e.jsx("i",{className:"text-muted",children:"Deleted"}):e.jsx("span",{className:`wb-channels-reply__text ${r?"wb-channels-reply__text--expanded":""}`,onClick:i,style:{cursor:"pointer"},children:s.content})]}),r&&!s.deleted&&e.jsx("div",{className:"wb-channels-reply__full-content",onClick:i,style:{cursor:"pointer"},children:s.content})]})})},Vs=42,Oe=U.forwardRef(({message:s,showHeader:r,onContextMenu:a},t)=>{const i=n.useRef(null),l=n.useRef(null),d=C=>{C.preventDefault(),!(s.type!==1||s.deleted)&&a(s,i.current)},m=()=>{l.current=setTimeout(()=>{s.type!==1||s.deleted||a(s,i.current)},500)},u=()=>{l.current&&clearTimeout(l.current)},g=()=>{l.current&&clearTimeout(l.current)};let h;if(s.type!==1){const C=s.content.split("{action_user}");h=e.jsx("div",{className:"d-flex justify-content-center",children:e.jsxs("div",{className:"p-2 rounded text-center wb-channels-message__body",children:[C[0],e.jsx(se,{userId:s.userId,userName:s.userName}),C[1]]})})}else h=e.jsxs("div",{className:"d-flex",children:[r&&e.jsx("div",{className:"me-2 flex-shrink-0",children:e.jsx(ee,{avatarImage:s.userAvatar,size:Vs})}),e.jsxs("div",{className:"flex-grow-1",children:[r&&e.jsxs("div",{className:"d-flex align-items-center mb-1",children:[e.jsx(se,{className:"fw-bold",userId:s.userId,userName:s.userName}),e.jsx("small",{className:"text-muted ms-2",children:Ge.format(new Date(s.createdAt))})]}),e.jsxs("div",{ref:i,className:`p-2 rounded wb-channels-message__body ${r?"":"ms-5 indented"}`,onContextMenu:d,onTouchStart:m,onTouchMove:u,onTouchEnd:g,children:[s.deleted?e.jsx("i",{className:"text-muted",children:"Message was deleted"}):s.content,!s.deleted&&new Date(s.createdAt)<new Date(s.updatedAt)&&e.jsx("small",{className:"text-muted",children:" (edited)"}),!s.deleted&&e.jsx("div",{children:s.attachments.map(C=>e.jsx("div",{className:"mt-2",children:e.jsx(Is,{data:C})},C.id))})]})]})]});return h=e.jsxs("div",{style:{maxWidth:"720px"},children:[s.repliedTo&&e.jsx("div",{className:"ms-5 indented",children:e.jsx(We,{message:s.repliedTo})}),h]}),e.jsx("div",{ref:t,className:"wb-channels-message",children:h})}),Us=({channel:s,onUserInvite:r,onUserRemove:a,onCancelInvite:t,onTitleChange:i,onRoleChange:l,onToggleNotifications:d})=>{var K,de,ae,ue,me;const[m,u]=n.useState("general"),[g,h]=n.useState(""),[C,y]=n.useState(""),[M,_]=n.useState(!0),{userInfo:o}=Ee(),{sendJsonRequest:E}=te(),[N,p]=n.useState({}),[R,O]=n.useState({}),[L,w]=n.useState(!1),[S,b]=n.useState(!1),[j,P]=n.useState(null),[D,G]=n.useState("");n.useEffect(()=>{u("general")},[s==null?void 0:s.id]),n.useEffect(()=>{p({}),O({}),m=="general"&&(y(s.title??""),_(!s.muted))},[m]);const x=(K=s.participants)==null?void 0:K.find(v=>v.userId==(o==null?void 0:o.id)),I=(x==null?void 0:x.role)==="Owner",B=I||(x==null?void 0:x.role)==="Admin",ne=()=>{w(!1)},Q=()=>{b(!1)},H=()=>{P(null),G("")},ve=async v=>{const z=await E("/Channels/GroupInviteUser","POST",{channelId:s.id,userId:v});z&&z.invite?(p({message:"Invite created successfully"}),r({...z.invite,authorId:o==null?void 0:o.id,authorName:o==null?void 0:o.name,authorAvatar:o==null?void 0:o.avatarImage})):p({errors:z==null?void 0:z.error}),h("")},oe=async()=>{if(!j)return;const v=await E("/Channels/GroupRemoveUser","POST",{channelId:s.id,userId:j});v&&v.success&&(a(j),H())},pe=async()=>{if(j&&D){const v=await E("/Channels/GroupChangeRole","POST",{channelId:s.id,userId:j,role:D});v&&v.success&&(l(v.data.userId,v.data.role),H())}},ce=async()=>{if(s.title==C.trim())return;const v=await E("/Channels/GroupRename","POST",{channelId:s.id,title:C.trim()});v&&v.success?(O({message:"Title changed successfully"}),i(v.data.title)):O({errors:v==null?void 0:v.error})},re=async()=>{await E("/Channels/LeaveChannel","POST",{channelId:s.id})},J=async()=>{await E("/Channels/DeleteChannel","POST",{channelId:s.id})},X=async v=>{const z=await E("/Channels/GroupCancelInvite","POST",{inviteId:v});z&&z.success&&t(v)},je=async v=>{const z=await E("/Channels/MuteChannel","POST",{channelId:s.id,muted:!v});z&&z.success&&(d(v),_(!z.data.muted))},W=(de=s.participants)==null?void 0:de.find(v=>v.userId==j);return e.jsxs(e.Fragment,{children:[e.jsxs(A,{show:L,onHide:ne,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Are you sure?"})}),e.jsx(A.Body,{children:"Channel will be permanently deleted."}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:ne,children:"Cancel"}),e.jsx(T,{variant:"danger",onClick:J,children:"Delete"})]})]}),e.jsxs(A,{show:S,onHide:Q,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Are you sure?"})}),e.jsx(A.Body,{children:"You won't be able to join again unless you are reinvited."}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:Q,children:"Cancel"}),e.jsx(T,{variant:"danger",onClick:re,children:"Leave"})]})]}),e.jsxs(A,{show:j!==null,onHide:H,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:W==null?void 0:W.userName})}),e.jsx(A.Body,{children:W&&e.jsxs(q.Group,{controlId:"participantRole",children:[e.jsx(q.Label,{children:"Role"}),e.jsxs(q.Select,{size:"sm",value:D||W.role,onChange:v=>G(v.target.value),disabled:!I,children:[e.jsx("option",{value:"Owner",children:"Owner"}),e.jsx("option",{value:"Admin",children:"Admin"}),e.jsx("option",{value:"Member",children:"Member"})]}),D==="Owner"&&I&&e.jsx("div",{className:"mt-2 text-sm text-warning",children:"By assigning this user as Owner, your role will be changed to Admin."})]})}),e.jsxs(A.Footer,{children:[e.jsx(T,{size:"sm",variant:"secondary",onClick:H,children:"Cancel"}),e.jsx(T,{size:"sm",variant:"danger",onClick:oe,children:"Remove"}),I&&e.jsx(T,{size:"sm",variant:"primary",onClick:pe,children:"Save"})]})]}),e.jsx($.Container,{activeKey:m,onSelect:v=>u(v||"general"),children:e.jsxs(cs,{children:[e.jsx(Pe,{sm:3,children:e.jsxs(V,{variant:"pills",className:"flex-column mb-2",children:[e.jsx(V.Item,{children:e.jsx(V.Link,{eventKey:"general",children:"General"})}),s.type==2&&e.jsx(V.Item,{children:e.jsx(V.Link,{eventKey:"members",children:"Members"})})]})}),e.jsx(Pe,{sm:9,children:e.jsxs($.Content,{children:[s.type==2&&e.jsxs($.Pane,{eventKey:"members",children:[B&&e.jsxs("div",{className:"mb-3",children:[e.jsx(q.Label,{children:"Invite user"}),e.jsx(As,{value:g,setValue:h,onSelect:v=>ve(v.id)}),e.jsx(we,{errors:N.errors,message:N.message})]}),B&&e.jsxs(e.Fragment,{children:[e.jsx("h5",{children:"Invites"}),e.jsxs(le,{children:[(ae=s.invites)==null?void 0:ae.map(v=>e.jsxs(le.Item,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"d-flex flex-column",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(ee,{avatarImage:v.invitedUserAvatar,size:36}),e.jsx(se,{userId:v.invitedUserId??"",userName:v.invitedUserName??"Unknown"})]}),e.jsxs("small",{className:"text-muted ms-5",children:["Invited by ",v.authorName]})]}),e.jsx(T,{variant:"outline-danger",size:"sm",onClick:()=>X(v.id),children:"Cancel"})]},v.id)),((ue=s.invites)==null?void 0:ue.length)===0&&e.jsx(le.Item,{className:"text-muted fst-italic",children:"No invites"})]})]}),e.jsx("h5",{children:"Members"}),e.jsx(le,{children:(me=s.participants)==null?void 0:me.map(v=>e.jsxs(le.Item,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(ee,{avatarImage:v.userAvatar,size:32}),e.jsx(se,{userId:v.userId,userName:v.userName}),e.jsx($e,{bg:"secondary",children:v.role})]}),B&&v.role!="Owner"&&v.userId!==(o==null?void 0:o.id)&&e.jsx("div",{className:"d-flex align-items-center gap-2",children:e.jsx(T,{variant:"outline-primary",size:"sm",onClick:()=>{P(v.userId),G(v.role)},children:e.jsx(Je,{})})})]},v.userId))})]}),e.jsxs($.Pane,{eventKey:"general",children:[s.type==2&&I&&e.jsxs("div",{className:"mb-3",children:[e.jsx(q.Label,{children:"Channel Name"}),e.jsxs(ds,{children:[e.jsx(q.Control,{size:"sm",value:C,onChange:v=>y(v.target.value)}),e.jsx(T,{size:"sm",onClick:ce,variant:"primary",disabled:C.trim().length<3,children:"Save"})]}),e.jsx(we,{errors:R.errors,message:R.message})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("span",{className:"me-3",children:"Notifications"}),e.jsx(Ts,{value:M,onChange:v=>je(v.target.checked)})]}),s.type==1||I?e.jsx("div",{children:e.jsx(T,{size:"sm",variant:"danger",onClick:()=>w(!0),children:"Delete Channel"})}):e.jsx("div",{children:e.jsx(T,{size:"sm",variant:"outline-danger",onClick:()=>b(!0),children:"Leave Channel"})})]})]})})]})})]})},$s=(s,r,a,t,i,l)=>{const{sendJsonRequest:d}=te(),[m,u]=n.useState([]),[g,h]=n.useState(!1),[C,y]=n.useState(""),[M,_]=n.useState(!1),{socket:o}=ye(),E=async(L,w)=>{h(!0),y("");const S=await d("/Channels/Messages","POST",{fromDate:L,count:s,channelId:r});S&&S.messages?(u(b=>w?S.messages:[...b,...S.messages]),_(S.messages.length===s)):y((S==null?void 0:S.error[0].message)??"Something went wrong"),h(!1)};n.useEffect(()=>{r&&E(null,!0)},[r]),n.useEffect(()=>{!r||a===null||E(a,!1)},[a]),n.useEffect(()=>{if(!o)return()=>{};const L=j=>{j.channelId===r&&(j.type==2?t({userId:j.userId,userName:j.userName,userAvatar:j.userAvatar,role:"Member"}):j.type==3&&i(j.userId),u(P=>[j,...P]))},w=j=>{l(j.lastActiveAt)},S=j=>{u(P=>P.map(D=>D.id==j.messageId?{...D,deleted:!0}:D))},b=j=>{u(P=>P.map(D=>D.id==j.messageId?{...D,content:j.content,attachments:j.attachments,updatedAt:j.updatedAt}:D))};return o.on("channels:new_message",L),o.on("channels:messages_seen",w),o.on("channels:message_deleted",S),o.on("channels:message_edited",b),()=>{o.off("channels:new_message",L),o.off("channels:messages_seen",w),o.off("channels:message_deleted",S),o.off("channels:message_edited",b)}},[o,r]);const N=n.useCallback(()=>{o&&o.emit("channels:messages_seen",{channelId:r})},[o,r]),p=n.useCallback((L,w)=>{o&&o.emit("channels:send_message",{channelId:r,content:L,repliedTo:w&&w.id})},[o,r]),R=n.useCallback(L=>{o&&o.emit("channels:delete_message",{channelId:r,messageId:L})},[o,r]),O=n.useCallback((L,w)=>{o&&o.emit("channels:edit_message",{channelId:r,messageId:L,content:w})},[o,r]);return{isLoading:g,error:C,results:m,hasNextPage:M,markMessagesSeen:N,sendMessage:p,deleteMessage:R,editMessage:O}},Z=8,Js=({visible:s,onClose:r,onCopy:a,onEdit:t,onDelete:i,onReply:l,isOwn:d,anchorRef:m})=>{const u=n.useRef(null),[g,h]=n.useState({top:0,left:0}),C=()=>{if(!u.current||!m.current)return;const y=u.current,{offsetWidth:M,offsetHeight:_}=y,o=m.current.getBoundingClientRect();let E=o.bottom,N=o.left;E+_>window.innerHeight-Z&&(E=o.top-_),N+M>window.innerWidth-Z&&(N=o.right-M),E=Math.min(Math.max(Z,E),window.innerHeight-_-Z),N=Math.min(Math.max(Z,N),window.innerWidth-M-Z),h({top:E,left:N})};return n.useLayoutEffect(()=>{s&&C()},[s]),n.useEffect(()=>{if(!s)return;let y=!0;const M=setTimeout(()=>{y=!1},250),_=p=>{u.current&&!u.current.contains(p.target)&&r()},o=p=>{p.key==="Escape"&&r()},E=()=>C(),N=()=>{y?C():r()};return document.addEventListener("mousedown",_),document.addEventListener("keydown",o),window.addEventListener("resize",E),window.addEventListener("scroll",N,!0),()=>{clearTimeout(M),document.removeEventListener("mousedown",_),document.removeEventListener("keydown",o),window.removeEventListener("resize",E),window.removeEventListener("scroll",N,!0)}},[s,r]),s?e.jsxs("div",{ref:u,role:"menu",className:"position-fixed bg-white border rounded shadow-sm fs-6",style:{top:g.top,left:g.left,zIndex:2e3,minWidth:160},children:[e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none",onClick:a,children:[e.jsx(us,{className:"me-1 text-muted"})," Copy text"]}),e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none",onClick:l,children:[e.jsx(Ue,{className:"me-1 text-muted"})," Reply to"]}),d&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none",onClick:t,children:[e.jsx(ms,{className:"me-1 text-muted"})," Edit"]}),e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none text-danger",onClick:i,children:[e.jsx(hs,{className:"me-1"})," Delete"]})]})]}):null},Ws=5,Ks=({channelId:s,onExit:r})=>{const[a,t]=n.useState(null),[i,l]=n.useState(null),{userInfo:d}=Ee(),h=$s(50,s,i,c=>{t(f=>f?{...f,participants:[...f.participants,c],invites:f.invites.filter(k=>k.invitedUserId!=c.userId)}:null)},c=>{t(f=>f?{...f,participants:f.participants.filter(k=>k.userId!=c)}:null)},c=>{t(f=>f?{...f,lastActiveAt:c}:null)}),[C,y]=n.useState(""),M=n.useRef(null),[_,o]=n.useState(!1),{sendJsonRequest:E}=te(),N=n.useRef(null),[p,R]=n.useState(!1),[O,L]=n.useState(!1),[w,S]=n.useState(!1),[b,j]=n.useState(0),P=n.useRef(!0),D=n.useRef(null),[G,x]=n.useState(null),[I,B]=n.useState(null),ne=n.useRef(null),[Q,H]=n.useState(null),[ve,oe]=n.useState(!0),[pe,ce]=n.useState(!1),[re,J]=n.useState(null);n.useEffect(()=>{de(),l(null),L(!0),o(!1),oe(!0)},[s]),n.useEffect(()=>{a&&!a.lastActiveAt&&h.markMessagesSeen()},[a==null?void 0:a.id]),n.useEffect(()=>{const c=M.current;if(!c)return;c.rows=1;const f=parseInt(window.getComputedStyle(c).lineHeight,10),k=Math.ceil(c.scrollHeight/f)-1;c.rows=Math.min(k,Ws)},[C]),n.useEffect(()=>{var c,f;I?(y(I.content),(c=M.current)==null||c.focus()):(y(""),(f=M.current)==null||f.blur())},[I]);const X=n.useRef(),je=n.useCallback(c=>{h.isLoading||(X.current&&X.current.disconnect(),X.current=new IntersectionObserver(f=>{f[0].isIntersecting&&h.hasNextPage&&l(()=>new Date(h.results[h.results.length-1].createdAt))}),c&&X.current.observe(c))},[h.isLoading,h.hasNextPage,h.results.length]);n.useEffect(()=>{const c=N.current;if(!c)return;const f=()=>{const k=c.scrollTop,F=Math.abs(k)<5;P.current=F,S(!F),F&&b>0&&j(0),F&&h.results.length>0&&(a!=null&&a.lastActiveAt)&&new Date(a.lastActiveAt)<new Date(h.results[0].createdAt)&&(t(ie=>ie?{...ie,lastActiveAt:h.results[0].createdAt}:null),h.markMessagesSeen())};return f(),c.addEventListener("scroll",f),()=>c.removeEventListener("scroll",f)},[h.results.length,a==null?void 0:a.id,b]),n.useEffect(()=>{if(h.results.length>0){const c=new Date(h.results[0].createdAt);if(D.current&&c>D.current){const f=h.results.filter(k=>new Date(k.createdAt)>D.current).length;P.current?K("smooth"):j(k=>k+f)}D.current=c}},[h.results.length]),n.useEffect(()=>{h.results.length>0&&h.results[0].userId==(d==null?void 0:d.id)&&R((a==null?void 0:a.lastActiveAt)!=null&&new Date(a.lastActiveAt)<new Date(h.results[0].createdAt))},[h.results.length,a==null?void 0:a.id,d]),n.useEffect(()=>{p&&K("smooth"),R(!1)},[p]),n.useEffect(()=>{O&&!h.isLoading&&h.results.length>0&&(K("auto"),L(!1),oe(!1))},[O,h.isLoading,h.results]);const W=()=>/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent),K=(c="smooth")=>{setTimeout(()=>{const f=N.current;f&&f.scrollTo({top:0,behavior:c})},50)},de=async()=>{ce(!0);const c=await E("/Channels/GetChannel","POST",{channelId:s,includeParticipants:!0,includeInvites:!0});c&&c.channel&&t(c.channel),ce(!1)},ae=async()=>{C.trim().length!==0&&(I?(h.editMessage(I.id,C),B(null)):h.sendMessage(C,re),y(""),J(null))},ue=c=>{W()||c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),ae())},me=()=>{o(c=>!c)},v=c=>{t(f=>f?{...f,participants:f.participants.filter(k=>k.userId!=c)}:null)},z=c=>{t(f=>f?{...f,invites:[...f.invites,c]}:null)},Ke=c=>{t(f=>f?{...f,invites:f.invites.filter(k=>k.id!=c)}:null)},qe=c=>{t(f=>f?{...f,title:c}:null)},Ye=(c,f)=>{t(k=>k?{...k,participants:k.participants.map(F=>F.userId==c?{...F,role:f}:F.userId==(d==null?void 0:d.id)&&f==="Owner"?{...F,role:"Admin"}:F)}:null)},Qe=c=>{t(f=>f?{...f,muted:!c}:null)},Ae=(c,f)=>{!f||c.type!==1||c.deleted||(x(c),ne.current=f)},Ce=()=>{H(null)},Xe=()=>{Q&&h.deleteMessage(Q),H(null),Ce()},Ze=()=>{B(null)},es=()=>{G&&navigator.clipboard.writeText(G.content),x(null)},ss=()=>{B(null),J(null),x(c=>(c&&H(c.id),null))},ts=()=>{H(null),J(null),x(c=>(c&&B(c),null))},ns=()=>{H(null),B(null),x(c=>{var f;return c&&(J(c),(f=M.current)==null||f.focus()),null})};let he;const fe=h.results.filter(c=>p||(a==null?void 0:a.lastActiveAt)&&new Date(a.lastActiveAt)>=new Date(c.createdAt));return e.jsxs("div",{className:"d-flex flex-column",style:{height:"100dvh"},children:[a!==null?e.jsxs(e.Fragment,{children:[e.jsxs(A,{show:Q!==null,onHide:Ce,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Are you sure?"})}),e.jsx(A.Body,{children:"Selected message will be deleted."}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:Ce,children:"Cancel"}),e.jsx(T,{variant:"danger",onClick:Xe,children:"Delete"})]})]}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between p-3 border-bottom z-3 bg-white",style:{height:"44px"},children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(T,{variant:"link",className:"text-secondary",onClick:r,children:e.jsx(xe,{})}),e.jsx("h5",{className:"mb-0",children:a.title})]}),e.jsx(T,{variant:"secondary",size:"sm",onClick:me,children:_?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"me-1"})," Settings"]}):e.jsxs(e.Fragment,{children:[e.jsx(fs,{className:"me-1"})," Settings"]})})]}),e.jsxs("div",{className:"d-flex flex-column flex-grow-1 overflow-hidden",children:[e.jsx("div",{className:"wb-channels-settings bg-light p-3 z-2 "+(_?"":" wb-channels-settings__closed"),children:e.jsx(Us,{channel:a,onUserRemove:v,onUserInvite:z,onCancelInvite:Ke,onTitleChange:qe,onRoleChange:Ye,onToggleNotifications:Qe})}),e.jsx("div",{className:"d-flex flex-column-reverse flex-grow-1 overflow-y-auto p-3 ms-lg-5",ref:N,children:e.jsx(Hs,{component:null,children:fe.map((c,f)=>{const k=f<fe.length-1?fe[f+1]:null;let F=!1;if(!k)F=!0;else if(k.userId!==c.userId||k.type!==1)F=!0,he=new Date(k.createdAt).getTime();else{const ie=new Date(c.createdAt).getTime();f===0&&(he=ie);const Te=new Date(k.createdAt).getTime();Math.abs(Te-he)>2*60*1e3&&(F=!0,he=Te)}return e.jsx(Ds,{timeout:300,classNames:ve?"":"wb-channels-message",children:e.jsx("div",{className:"mt-2",children:f===fe.length-1?e.jsx(Oe,{ref:je,message:c,showHeader:F||c.repliedTo!=null,onContextMenu:Ae}):e.jsx(Oe,{message:c,showHeader:F||c.repliedTo!=null,onContextMenu:Ae})})},c.id)})})}),e.jsxs("div",{className:"position-relative p-2 border-top",children:[I&&e.jsx("div",{className:"small",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"fw-bold text-info",children:[e.jsx(Je,{})," Edit message"]}),e.jsx(T,{size:"sm",variant:"link",className:"text-muted",onClick:Ze,children:e.jsx(xe,{})})]})}),re&&e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"flex-grow-1",style:{minWidth:0},children:e.jsx(We,{message:re})}),e.jsx(T,{size:"sm",variant:"link",className:"text-muted ms-2 p-0 flex-shrink-0",onClick:()=>J(null),children:e.jsx(xe,{})})]}),e.jsxs("div",{className:"d-flex align-items-center",children:[w&&e.jsxs(T,{size:"sm",variant:"secondary",className:"position-absolute end-0 me-3 mt-1 z-1",style:{top:"-50px"},onClick:()=>{K("smooth"),j(0)},children:[b>0&&e.jsx($e,{bg:"info",className:"me-2",children:b+" new message"+(b>1?"s":"")}),e.jsx(xs,{})]}),e.jsx(q.Control,{ref:M,as:"textarea",rows:1,placeholder:"Type your message...",value:C,onChange:c=>y(c.target.value),onKeyDown:ue,className:"me-2 border-0",maxLength:1024,style:{resize:"none",boxShadow:"none"}}),C.trim().length>0&&e.jsx(T,{variant:"primary",onClick:ae,children:I?e.jsx(gs,{}):e.jsx(vs,{})})]})]})]})]}):e.jsx("div",{className:"flex-grow-1 d-flex flex-column justify-content-center align-items-center text-center",children:pe?e.jsx(be,{}):e.jsxs("div",{children:[e.jsx("h4",{children:"Channel not found"}),e.jsxs(T,{onClick:r,variant:"primary",children:[e.jsx(ps,{}),"Back to Channels"]})]})}),e.jsx(Js,{visible:G!==null,onClose:()=>x(null),onCopy:es,onEdit:ts,onDelete:ss,onReply:ns,isOwn:(G==null?void 0:G.userId)===(d==null?void 0:d.id),anchorRef:ne})]})},ze=()=>{const{channelId:s}=js(),r=Cs();Ns("Channels | Webler Codes");const a=i=>{r(`/Channels/${i}`)},t=()=>{r("/Channels")};return e.jsxs(e.Fragment,{children:[e.jsx(A,{show:s!=null,onHide:t,fullscreen:!0,className:"p-0 m-0",contentClassName:"h-100",children:e.jsx(A.Body,{className:"p-0 m-0 d-flex flex-column",children:s&&e.jsx(Ks,{channelId:s,onExit:t})})}),e.jsx(ws,{fluid:!0,children:e.jsx("div",{className:"wb-channels-container",children:e.jsx(Ls,{onChannelSelect:a,currentChannelId:s??null,onExit:t})})})]})};const tt=()=>e.jsx(bs,{children:e.jsx(ge,{element:e.jsx(ys,{Header:e.jsx(Es,{variant:"light",hideChannelsButton:!0}),Footer:null}),children:e.jsxs(ge,{element:e.jsx(Ms,{allowedRoles:Ss}),children:[e.jsx(ge,{index:!0,element:e.jsx(ze,{})}),e.jsx(ge,{path:":channelId",element:e.jsx(ze,{})})]})})});export{tt as default};
