import{aR as Me,r as n,aS as Le,j as e,aT as Oe,aU as ze,aV as $e,W as ie,aW as Be,X as oe,aX as He,aY as Ue,b as le,J as ce,u as D,aa as De,v as Pe,P as We,c as Ge,aw as Je,D as qe,R as Xe,B as L,m as Ye,aZ as Ze,ab as Ke,ac as Qe}from"./index-58cdf152.js";import{P as es,a as ss}from"./PostAttachmentSelect-5ed188cc.js";import{p as ts,R as ns,P as as}from"./ReactionsList-42eaa2fe.js";import{M as B}from"./Modal-8c57f9e2.js";var Z=Math.pow(2,31)-1;function de(s,a,l){var r=l-Date.now();s.current=r<=Z?setTimeout(a,r):setTimeout(function(){return de(s,a,l)},Z)}function rs(){var s=Me(),a=n.useRef();return Le(function(){return clearTimeout(a.current)}),n.useMemo(function(){var l=function(){return clearTimeout(a.current)};function r(u,i){i===void 0&&(i=0),s()&&(l(),i<=Z?a.current=setTimeout(u,i):de(a,u,Date.now()+i))}return{set:r,clear:l}},[])}const is={[ze]:"showing",[$e]:"showing show"},ue=n.forwardRef((s,a)=>e.jsx(Oe,{...s,ref:a,transitionClasses:is}));ue.displayName="ToastFade";const os=ue,ls=n.createContext({onClose(){}}),me=ls,he=n.forwardRef(({bsPrefix:s,closeLabel:a="Close",closeVariant:l,closeButton:r=!0,className:u,children:i,...I},p)=>{s=ie(s,"toast-header");const d=n.useContext(me),S=Be(C=>{d==null||d.onClose==null||d.onClose(C)});return e.jsxs("div",{ref:p,...I,className:oe(s,u),children:[i,r&&e.jsx(He,{"aria-label":a,variant:l,onClick:S,"data-dismiss":"toast"})]})});he.displayName="ToastHeader";const cs=he,ds=Ue("toast-body"),fe=n.forwardRef(({bsPrefix:s,className:a,transition:l=os,show:r=!0,animation:u=!0,delay:i=5e3,autohide:I=!1,onClose:p,bg:d,...S},C)=>{s=ie(s,"toast");const v=n.useRef(i),m=n.useRef(p);n.useEffect(()=>{v.current=i,m.current=p},[i,p]);const N=rs(),x=!!(I&&r),h=n.useCallback(()=>{x&&(m.current==null||m.current())},[x]);n.useEffect(()=>{N.set(h,v.current)},[N,h]);const V=n.useMemo(()=>({onClose:p}),[p]),F=!!(l&&u),g=e.jsx("div",{...S,ref:C,className:oe(s,a,d&&`bg-${d}`,!F&&(r?"show":"hide")),role:"alert","aria-live":"assertive","aria-atomic":"true"});return e.jsx(me.Provider,{value:V,children:F&&l?e.jsx(l,{in:r,unmountOnExit:!0,children:g}):g})});fe.displayName="Toast";const ae=Object.assign(fe,{Body:ds,Header:cs}),re=({comment:s,repliesVisible:a,handleToggleReplies:l,handleReply:r,handleEdit:u,handleDelete:i,handleShowVotes:I,isHighlighted:p,onVote:d})=>{const{userInfo:S}=le(),C=ce(),{sendJsonRequest:v}=D(),m=async()=>{if(!S){C("/Users/Login");return}const N=s.isUpvoted?0:1,x=await v("/Discussion/VotePost","POST",{postId:s.id,vote:N});x.success&&x.vote===N?d(s.id,x.vote):d(s.id,0,x.error)};return e.jsxs("div",{className:"d-flex position-relative gap-2",children:[e.jsx("div",{className:"wb-comments__options",children:e.jsx("div",{className:"d-flex gap-2",children:S&&S.id===s.userId&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"wb-comments__options__item",onClick:u,children:e.jsx(De,{})}),e.jsx("span",{className:"wb-comments__options__item",onClick:i,children:e.jsx(Pe,{})})]})})}),e.jsx("div",{children:e.jsx(We,{size:32,avatarImage:s.userAvatar??null})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"rounded border p-2 mb-1",style:{background:p?"beige":"white"},children:[e.jsx("div",{children:e.jsx(Ge,{userId:s.userId,userName:s.userName})}),e.jsx("div",{className:"wb-comments__message mt-2",children:ts(s.message)}),e.jsx("div",{className:"mt-2",children:s.attachments.map(N=>e.jsx("div",{className:"mt-1",children:e.jsx(es,{data:N})},N.id))})]}),e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"d-flex gap-2 align-items-center",children:[e.jsxs("div",{className:"small",children:[e.jsx("span",{className:"wb-icon-button"+(s.isUpvoted?" text-black":""),onClick:m,children:e.jsx(Je,{})}),s.votes>0?e.jsx("span",{className:"ms-1",style:{cursor:"pointer"},onClick:I,children:s.votes}):e.jsx("span",{className:"ms-1",children:s.votes})]}),e.jsx("button",{className:"small wb-comments__footer__reply-btn",onClick:r,children:"Reply"}),s.parentId===null&&s.answers>0&&e.jsx(e.Fragment,{children:e.jsxs("button",{className:"small wb-comments__footer__replies "+(a?"text-secondary":"text-black"),onClick:l,children:[s.answers," replies"]})})]}),e.jsx("div",{children:e.jsx("div",{children:e.jsx("small",{className:"text-secondary",children:qe.format2(new Date(s.date),!0)})})})]})]})]})},us=(s,a,l,r,u)=>{const[i,I]=n.useState({firstIndex:r&&r.length>0?r[0].index:0,lastIndex:r&&r.length>0?r[r.length-1].index:0,direction:"dont load"}),[p,d]=n.useState(r||[]),[S,C]=n.useState(!1),[v,m]=n.useState(r!==null&&r.length==u),{sendJsonRequest:N}=D();return n.useEffect(()=>{(async()=>{if(i.direction==="dont load"||!a)return;C(!0);const j=await N(`/${s.section}/GetComments`,"POST",{...s.params,parentId:l,findPostId:null,count:i.direction==="from start"?Math.min(i.firstIndex,u):u,index:i.direction==="from start"?Math.max(0,i.firstIndex-u):i.lastIndex,filter:2});j&&j.posts&&(d(R=>{const k=j.posts.filter(f=>!R.some(w=>w.id===f.id));return i.direction==="from start"?[...k,...R]:[...R,...k]}),i.direction==="from end"&&m(j.posts.length===u)),C(!1)})()},[i]),n.useEffect(()=>{a&&I(g=>({...g,direction:r!==null?"dont load":"from end"}))},[s,l,r,a]),{results:p,setState:I,loading:S,hasNextPage:v,createReply:g=>{d(j=>[g,...j])},editReply:(g,j)=>{d(R=>R.map(k=>k.id==g?j(k):k))},deleteReply:g=>{d(j=>{const R=[];let k=!1;for(let f of j)f.id===g?k=!0:R.push({...f,index:k?f.index-1:f.index});return R})},getFirstValidCommentIndex:()=>{const g=p.find(j=>j.index>=0);return g?g.index:0}}},ms=Xe.forwardRef(({options:s,comment:a,defaultReplies:l,onDelete:r,onEdit:u,onReply:i,onShowVotes:I,highlightedCommentId:p,onVote:d},S)=>{const[C,v]=n.useState(l!==null),{results:m,setState:N,loading:x,hasNextPage:h,getFirstValidCommentIndex:V,createReply:F,editReply:g,deleteReply:j}=us(s,C,a.id,l,10),R=n.useRef(),k=n.useCallback(c=>{x||(R.current&&R.current.disconnect(),R.current=new IntersectionObserver(b=>{b[0].isIntersecting&&h&&m.length>0&&N(O=>({...O,lastIndex:m[m.length-1].index+1,direction:"from end"}))}),c&&R.current.observe(c))},[x,h,m]);n.useEffect(()=>{a.answers==0&&v(!1)},[a.answers]);const f=()=>{N(c=>({...c,firstIndex:V(),direction:"from start"}))},w=()=>{v(!0),i(a.id,c=>{F(c)})},E=()=>{u(a)},_=()=>{r(a)},y=()=>{v(c=>!c)},A=c=>{u(c,g)},z=c=>{v(!0),i(a.id,b=>{F(b)},`[user id="${c.userId}"]${c.userName}[/user] `)},P=c=>{r(c,b=>{j(b)})},$=(c,b)=>{g(c,O=>({...O,votes:O.votes+2*b-1,isUpvoted:b==1}))};return e.jsxs("div",{className:"mb-3",ref:S,children:[e.jsx(re,{comment:a,repliesVisible:C,handleDelete:_,handleEdit:E,handleReply:w,handleToggleReplies:y,handleShowVotes:()=>I(a.id),isHighlighted:p===a.id,onVote:d}),C&&e.jsxs("div",{className:"ms-5 mt-2",children:[m.length>0&&V()>0&&e.jsx(L,{variant:"primary",size:"sm",className:"mb-2 w-100",onClick:f,disabled:x,children:"Load Previous"}),m.map((c,b)=>e.jsx("div",{className:"mb-2",ref:m.length-1==b?k:void 0,children:e.jsx(re,{comment:c,handleDelete:()=>P(c),handleEdit:()=>A(c),handleReply:()=>z(c),handleShowVotes:()=>I(c.id),isHighlighted:p===c.id,onVote:$})},c.id))]})]})}),hs=(s,a,l,r,u)=>{const[i,I]=n.useState({firstIndex:0,lastIndex:0,direction:"dont load"}),[p,d]=n.useState([]),[S,C]=n.useState(!1),[v,m]=n.useState(!1),[N,x]=n.useState(!1),[h,V]=n.useState([]),{sendJsonRequest:F}=D();return n.useEffect(()=>{(async()=>{if(i.direction==="dont load")return;V([]),C(!0);const w=await F(`/${s.section}/GetComments`,"POST",{...s.params,parentId:null,findPostId:N?null:a,count:i.direction==="from start"?Math.min(i.firstIndex,r):r,index:i.direction==="from start"?Math.max(0,i.firstIndex-r):i.lastIndex,filter:l});w&&w.posts?(d(E=>{const _=w.posts.filter(y=>!E.some(A=>A.id===y.id));return i.direction==="from start"?[..._,...E]:[...E,..._]}),i.direction==="from end"&&m(w.posts.length===r),x(!0)):V(w.error),C(!1)})()},[i]),n.useEffect(()=>{d([]),I({firstIndex:0,lastIndex:0,direction:"from end"})},[s,l,u]),{results:p,setState:I,loading:S,createComment:f=>{d(w=>[f,...w])},editComment:(f,w)=>{d(E=>E.map(_=>_.id==f?w(_):_))},deleteComment:f=>{d(w=>{const E=[];let _=!1;for(let y of w)y.id===f?_=!0:E.push({...y,index:_?y.index-1:y.index});return E})},hasNextPage:v,getFirstValidCommentIndex:()=>{const f=p.find(w=>w.index>=0);return f?f.index:0},error:h}};const vs=({findPost:s,options:a,setCommentCount:l})=>{var te;const[r,u]=n.useState(!(s!=null&&s.isReply)),[i,I]=n.useState(s?2:1),[p,d]=n.useState(!1),[S,C]=n.useState(!1),[v,m]=n.useState(""),[N,x]=n.useState(!1),[h,V]=n.useState(null),[F,g]=n.useState(null),j=n.useRef(null),[R,k]=n.useState(),[f,w]=n.useState(),[E,_]=n.useState(),[y,A]=n.useState({success:!0}),[z,P]=n.useState((s==null?void 0:s.id)||null),$=n.useRef(null),c=n.useRef(null),{userInfo:b}=le(),{sendJsonRequest:O}=D(),{results:M,setState:K,loading:W,createComment:xe,editComment:H,deleteComment:pe,hasNextPage:Q,getFirstValidCommentIndex:ee,error:G}=hs(a,s?s.id:null,i,10,r),[ge,se]=n.useState(!1),[ve,je]=n.useState({parentId:""}),we=ce();n.useEffect(()=>{if(z){const t=setTimeout(()=>{P(null)},3e3);return()=>clearTimeout(t)}},[z]),n.useEffect(()=>{G&&A({success:!1,errors:G})},[G]);const U=n.useRef(),Ce=n.useCallback(t=>{W||(U.current&&U.current.disconnect(),U.current=new IntersectionObserver(o=>{o[0].isIntersecting&&Q&&M.length>0&&K(T=>({...T,lastIndex:M[M.length-1].index+1,direction:"from end"}))}),t&&U.current.observe(t))},[W,Q,M]),Re=t=>{I(Number(t.target.value))},be=()=>{u(!0)},J=(t,o,T="")=>{b||we("/Users/Login"),m(T),V(t),g(o),C(!0),setTimeout(()=>{c.current&&c.current.focus()})},q=()=>{C(!1),m(""),V(null)},Ne=async()=>{if(!b)return;x(!0);const t=await O(`/${a.section}/CreateComment`,"POST",{...a.params,parentId:F,message:v});if(t&&t.post){const o={...t.post,index:-1,userName:b.name,userAvatar:b.avatarImage};F?(R==null||R(o),H(F,T=>({...T,answers:T.answers+1})),setTimeout(()=>{j.current&&j.current.scrollIntoView({behavior:"smooth",block:"start"})})):(xe(o),setTimeout(()=>{$.current&&$.current.scrollTo({top:0,behavior:"smooth"})})),l==null||l(T=>T+1),A({success:!0,message:F?"Reply posted successfully":"Comment posted successfully"}),q()}else A({success:!1,errors:t==null?void 0:t.error});x(!1)},ye=async()=>{if(h){x(!0);const t=await O(`/${a.section}/EditComment`,"PUT",{message:v,id:h.id});t&&t.success?(h.parentId?f==null||f(t.data.id,o=>({...o,message:t.data.message,attachments:t.data.attachments})):H(t.data.id,o=>({...o,message:t.data.message,attachments:t.data.attachments})),A({success:!0,message:h.parentId?"Reply edited successfully":"Comment edited successfully"}),q()):A({success:!1,errors:t==null?void 0:t.error}),x(!1)}},Ie=async()=>{if(h){x(!0);const t=await O(`/${a.section}/DeleteComment`,"DELETE",{id:h.id});t&&t.success?(h.parentId?(E==null||E(h.id),H(h.parentId,o=>({...o,answers:o.answers-1}))):pe(h.id),l==null||l(o=>o-h.answers-1),A({success:!0,message:h.parentId?"Reply deleted successfully":"Comment deleted successfully"})):A({success:!1,errors:t==null?void 0:t.error}),x(!1),X()}},X=()=>{d(!1),V(null)},Se=()=>{se(!1)},Te=()=>{K(t=>({...t,firstIndex:ee(),direction:"from start"}))},Fe=(t,o,T)=>{k(()=>o),J(null,t,T)},ke=(t,o)=>{w(()=>o),J(t,t.parentId,t.message)},Ee=(t,o)=>{_(()=>o),V(t),d(!0)},Ve=(t,o,T)=>{T?A({success:!1,errors:T}):H(t,ne=>({...ne,votes:ne.votes+2*o-1,isUpvoted:o==1}))},_e=t=>{je({parentId:t}),se(!0)},Ae=t=>{m(o=>(o.trim().length==0||o.endsWith(`
`)?o:o+`
`)+t.join(`
`)+`
`)};let Y=N||W;return e.jsxs(e.Fragment,{children:[e.jsxs(B,{style:{zIndex:1070},backdropClassName:"wb-reactions-modal__backdrop",size:"sm",show:p,onHide:X,centered:!0,children:[e.jsx(B.Header,{closeButton:!0,children:e.jsx(B.Title,{children:"Are you sure?"})}),e.jsx(B.Body,{children:"Your answer will be permanently deleted."}),e.jsxs(B.Footer,{children:[e.jsx(L,{variant:"secondary",onClick:X,children:"Cancel"}),e.jsx(L,{variant:"danger",onClick:Ie,children:"Delete"})]})]}),e.jsx(ns,{title:"Likes",options:ve,visible:ge,onClose:Se,showReactions:!0,countPerPage:10}),e.jsx("div",{className:"d-flex justify-content-between",children:r?e.jsx("div",{className:"col-6 col-sm-4",children:e.jsxs(Ye.Select,{size:"sm",value:i,onChange:Re,children:[e.jsx("option",{value:"1",children:"Most Popular"}),e.jsx("option",{value:"2",children:"Oldest"}),e.jsx("option",{value:"3",children:"Most recent"})]})}):e.jsxs(L,{onClick:be,variant:"link",size:"sm",children:[e.jsx(Ze,{}),"Back to all comments"]})}),e.jsxs("div",{className:"mt-1 pe-1 flex-grow-1 overflow-auto",ref:$,children:[M.length>0&&ee()>0&&r&&e.jsx(L,{variant:"primary",size:"sm",className:"mb-2 w-100",onClick:Te,disabled:Y,children:"Load Previous"}),(r?M:M.slice(0,1)).map((t,o)=>{let T=e.jsx(ms,{ref:o===M.length-1?Ce:void 0,options:a,comment:t,defaultReplies:s!=null&&s.isReply&&!r?M.slice(1):null,onDelete:Ee,onEdit:ke,onReply:Fe,onShowVotes:_e,highlightedCommentId:z,onVote:Ve});return t.id==F?e.jsx("div",{ref:j,children:T},t.id):e.jsx("div",{children:T},t.id)})]}),e.jsx(ae,{className:"position-absolute",style:{zIndex:"999",bottom:"68px",width:"90%"},bg:y.success?"success":"danger",onClose:()=>A(t=>({success:t.success})),show:y.errors&&y.errors.length>0||!!y.message,delay:2500,autohide:!0,children:e.jsx(ae.Body,{className:"text-white",children:e.jsx("b",{children:y.success?y.message:y.errors?(te=y.errors[0])==null?void 0:te.message:""})})}),e.jsxs("div",{className:"py-2 border-top",children:[e.jsx(L,{hidden:S,size:"sm",variant:"primary",className:"ms-2",onClick:()=>J(null,null),children:"Write comment"}),e.jsxs("div",{hidden:!S,children:[e.jsxs(Ke,{children:[e.jsx(Qe,{children:e.jsx("b",{children:b==null?void 0:b.name})}),e.jsx(as,{ref:c,size:"sm",value:v,setValue:m,placeholder:"Write your comment here...",rows:5})]}),e.jsxs("div",{className:"d-flex justify-content-end mt-2",children:[e.jsx(ss,{onSubmit:Ae}),e.jsx(L,{size:"sm",variant:"secondary",className:"ms-2",onClick:q,children:"Cancel"}),h===null?e.jsx(L,{size:"sm",className:"ms-2",variant:"primary",onClick:Ne,disabled:Y||v.length===0,children:F?"Post Reply":"Post Comment"}):e.jsx(L,{size:"sm",variant:"primary",className:"ms-2",onClick:ye,disabled:Y||v.length===0,children:"Save changes"})]})]})]})]})};export{vs as C,ae as T};
