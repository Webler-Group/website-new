import{e as re,f as ie,d as H,j as e,al as Se,a6 as Fe,K as ke,S as Ve,az as _e,M as Ae,r as n,J as Me,B as E,h as Te,aT as Le,am as Ee,q as ze}from"./index-80db11cf.js";import{P as Oe}from"./PostAttachment-c1c636f2.js";import{p as Pe,P as Ue}from"./PostTextareaControl-3c30086b.js";import{R as $e}from"./ReactionsList-1ba1f18d.js";import{P as Be}from"./PostAttachmentSelect-8cd57bbf.js";import{M as U}from"./Modal-19ce6b28.js";import{T as ne}from"./Toast-6154fa82.js";const ae=({comment:t,repliesVisible:o,handleToggleReplies:j,handleReply:i,handleEdit:C,handleDelete:l,handleShowVotes:V,isHighlighted:_,onVote:h})=>{const{userInfo:A}=re(),R=ie(),{sendJsonRequest:b}=H(),x=async()=>{if(!A){R("/Users/Login");return}const I=t.isUpvoted?0:1,f=await b("/Discussion/VotePost","POST",{postId:t.id,vote:I});f.success&&f.vote===I?h(t.id,f.vote):h(t.id,0,f.error)};return e.jsxs("div",{className:"d-flex position-relative gap-2",children:[e.jsx("div",{className:"wb-comments__options",children:e.jsx("div",{className:"d-flex gap-2",children:A&&A.id===t.userId&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"wb-comments__options__item",onClick:C,children:e.jsx(Se,{})}),e.jsx("span",{className:"wb-comments__options__item",onClick:l,children:e.jsx(Fe,{})})]})})}),e.jsx("div",{children:e.jsx(ke,{size:32,avatarImage:t.userAvatar??null})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"rounded border p-2 mb-1",style:{background:_?"beige":"white"},children:[e.jsx("div",{children:e.jsx(Ve,{userId:t.userId,userName:t.userName})}),e.jsx("div",{className:"wb-comments__message mt-2",children:Pe(t.message)}),e.jsx("div",{className:"mt-2",children:t.attachments.map(I=>e.jsx("div",{className:"mt-1",children:e.jsx(Oe,{data:I})},I.id))})]}),e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"d-flex gap-2 align-items-center",children:[e.jsxs("div",{className:"small",children:[e.jsx("span",{className:"wb-icon-button"+(t.isUpvoted?" text-black":""),onClick:x,children:e.jsx(_e,{})}),t.votes>0?e.jsx("span",{className:"ms-1",style:{cursor:"pointer"},onClick:V,children:t.votes}):e.jsx("span",{className:"ms-1",children:t.votes})]}),e.jsx("button",{className:"small wb-comments__footer__reply-btn",onClick:i,children:"Reply"}),t.parentId===null&&t.answers>0&&e.jsx(e.Fragment,{children:e.jsxs("button",{className:"small wb-comments__footer__replies "+(o?"text-secondary":"text-black"),onClick:j,children:[t.answers," replies"]})})]}),e.jsx("div",{children:e.jsx("div",{children:e.jsx("small",{className:"text-secondary",children:Ae.format2(new Date(t.date),!0)})})})]})]})]})},He=(t,o,j,i,C)=>{const[l,V]=n.useState({firstIndex:i&&i.length>0?i[0].index:0,lastIndex:i&&i.length>0?i[i.length-1].index:0,direction:"dont load"}),[_,h]=n.useState(i||[]),[A,R]=n.useState(!1),[b,x]=n.useState(i!==null&&i.length==C),{sendJsonRequest:I}=H();return n.useEffect(()=>{(async()=>{if(l.direction==="dont load"||!o)return;R(!0);const m=await I(`/${t.section}/GetComments`,"POST",{...t.params,parentId:j,findPostId:null,count:l.direction==="from start"?Math.min(l.firstIndex,C):C,index:l.direction==="from start"?Math.max(0,l.firstIndex-C):l.lastIndex,filter:2});m&&m.posts&&(h(p=>{const N=m.posts.filter(c=>!p.some(u=>u.id===c.id));return l.direction==="from start"?[...N,...p]:[...p,...N]}),l.direction==="from end"&&x(m.posts.length===C)),R(!1)})()},[l]),n.useEffect(()=>{o&&V(v=>({...v,direction:i!==null?"dont load":"from end"}))},[t,j,i,o]),{results:_,setState:V,loading:A,hasNextPage:b,createReply:v=>{h(m=>[v,...m])},editReply:(v,m)=>{h(p=>p.map(N=>N.id==v?m(N):N))},deleteReply:v=>{h(m=>{const p=[];let N=!1;for(let c of m)c.id===v?N=!0:p.push({...c,index:N?c.index-1:c.index});return p})},getFirstValidCommentIndex:()=>{const v=_.find(m=>m.index>=0);return v?v.index:0}}},qe=Me.forwardRef(({options:t,comment:o,defaultReplies:j,onDelete:i,onEdit:C,onReply:l,onShowVotes:V,highlightedCommentId:_,onVote:h},A)=>{const[R,b]=n.useState(j!==null),{results:x,setState:I,loading:f,hasNextPage:d,getFirstValidCommentIndex:T,createReply:M,editReply:v,deleteReply:m}=He(t,R,o.id,j,10),p=n.useRef(),N=n.useCallback(r=>{f||(p.current&&p.current.disconnect(),p.current=new IntersectionObserver(g=>{g[0].isIntersecting&&d&&x.length>0&&I(z=>({...z,lastIndex:x[x.length-1].index+1,direction:"from end"}))}),r&&p.current.observe(r))},[f,d,x]);n.useEffect(()=>{o.answers==0&&b(!1)},[o.answers]);const c=()=>{I(r=>({...r,firstIndex:T(),direction:"from start"}))},u=()=>{b(!0),l(o.id,r=>{M(r)})},S=()=>{C(o)},F=()=>{i(o)},w=()=>{b(r=>!r)},k=r=>{C(r,v)},O=r=>{b(!0),l(o.id,g=>{M(g)},`[user id="${r.userId}"]${r.userName}[/user] `)},q=r=>{i(r,g=>{m(g)})},P=(r,g)=>{v(r,z=>({...z,votes:z.votes+2*g-1,isUpvoted:g==1}))};return e.jsxs("div",{className:"mb-3",ref:A,children:[e.jsx(ae,{comment:o,repliesVisible:R,handleDelete:F,handleEdit:S,handleReply:u,handleToggleReplies:w,handleShowVotes:()=>V(o.id),isHighlighted:_===o.id,onVote:h}),R&&e.jsxs("div",{className:"ms-5 mt-2",children:[x.length>0&&T()>0&&e.jsx(E,{variant:"primary",size:"sm",className:"mb-2 w-100",onClick:c,disabled:f,children:"Load Previous"}),x.map((r,g)=>e.jsx("div",{className:"mb-2",ref:x.length-1==g?N:void 0,children:e.jsx(ae,{comment:r,handleDelete:()=>q(r),handleEdit:()=>k(r),handleReply:()=>O(r),handleShowVotes:()=>V(r.id),isHighlighted:_===r.id,onVote:P})},r.id))]})]})}),De=(t,o,j,i,C)=>{const[l,V]=n.useState({firstIndex:0,lastIndex:0,direction:"dont load"}),[_,h]=n.useState([]),[A,R]=n.useState(!1),[b,x]=n.useState(!1),[I,f]=n.useState(!1),[d,T]=n.useState([]),{sendJsonRequest:M}=H();return n.useEffect(()=>{(async()=>{if(l.direction==="dont load")return;T([]),R(!0);const u=await M(`/${t.section}/GetComments`,"POST",{...t.params,parentId:null,findPostId:I?null:o,count:l.direction==="from start"?Math.min(l.firstIndex,i):i,index:l.direction==="from start"?Math.max(0,l.firstIndex-i):l.lastIndex,filter:j});u&&u.posts?(h(S=>{const F=u.posts.filter(w=>!S.some(k=>k.id===w.id));return l.direction==="from start"?[...F,...S]:[...S,...F]}),l.direction==="from end"&&x(u.posts.length===i),f(!0)):T(u.error),R(!1)})()},[l]),n.useEffect(()=>{h([]),V({firstIndex:0,lastIndex:0,direction:"from end"})},[t,j,C]),{results:_,setState:V,loading:A,createComment:c=>{h(u=>[c,...u])},editComment:(c,u)=>{h(S=>S.map(F=>F.id==c?u(F):F))},deleteComment:c=>{h(u=>{const S=[];let F=!1;for(let w of u)w.id===c?F=!0:S.push({...w,index:F?w.index-1:w.index});return S})},hasNextPage:b,getFirstValidCommentIndex:()=>{const c=_.find(u=>u.index>=0);return c?c.index:0},error:d}};const Ze=({findPost:t,options:o,setCommentCount:j})=>{var se;const[i,C]=n.useState(!(t!=null&&t.isReply)),[l,V]=n.useState(t?2:1),[_,h]=n.useState(!1),[A,R]=n.useState(!1),[b,x]=n.useState(""),[I,f]=n.useState(!1),[d,T]=n.useState(null),[M,v]=n.useState(null),m=n.useRef(null),[p,N]=n.useState(),[c,u]=n.useState(),[S,F]=n.useState(),[w,k]=n.useState({success:!0}),[O,q]=n.useState((t==null?void 0:t.id)||null),P=n.useRef(null),r=n.useRef(null),{userInfo:g}=re(),{sendJsonRequest:z}=H(),{results:L,setState:Q,loading:D,createComment:le,editComment:$,deleteComment:oe,hasNextPage:X,getFirstValidCommentIndex:Z,error:J}=De(o,t?t.id:null,l,10,i),[ce,ee]=n.useState(!1),[de,me]=n.useState({parentId:""}),ue=ie();n.useEffect(()=>{if(O){const s=setTimeout(()=>{q(null)},3e3);return()=>clearTimeout(s)}},[O]),n.useEffect(()=>{J&&k({success:!1,errors:J})},[J]);const B=n.useRef(),he=n.useCallback(s=>{D||(B.current&&B.current.disconnect(),B.current=new IntersectionObserver(a=>{a[0].isIntersecting&&X&&L.length>0&&Q(y=>({...y,lastIndex:L[L.length-1].index+1,direction:"from end"}))}),s&&B.current.observe(s))},[D,X,L]),xe=s=>{V(Number(s.target.value))},fe=()=>{C(!0)},G=(s,a,y="")=>{g||ue("/Users/Login"),x(y),T(s),v(a),R(!0),setTimeout(()=>{r.current&&r.current.focus()})},W=()=>{R(!1),x(""),T(null)},pe=async()=>{if(!g)return;f(!0);const s=await z(`/${o.section}/CreateComment`,"POST",{...o.params,parentId:M,message:b});if(s&&s.post){const a={...s.post,index:-1,userName:g.name,userAvatar:g.avatarImage};M?(p==null||p(a),$(M,y=>({...y,answers:y.answers+1})),setTimeout(()=>{m.current&&m.current.scrollIntoView({behavior:"smooth",block:"start"})})):(le(a),setTimeout(()=>{P.current&&P.current.scrollTo({top:0,behavior:"smooth"})})),j==null||j(y=>y+1),k({success:!0,message:M?"Reply posted successfully":"Comment posted successfully"}),W()}else k({success:!1,errors:s==null?void 0:s.error});f(!1)},ge=async()=>{if(d){f(!0);const s=await z(`/${o.section}/EditComment`,"PUT",{message:b,id:d.id});s&&s.success?(d.parentId?c==null||c(s.data.id,a=>({...a,message:s.data.message,attachments:s.data.attachments})):$(s.data.id,a=>({...a,message:s.data.message,attachments:s.data.attachments})),k({success:!0,message:d.parentId?"Reply edited successfully":"Comment edited successfully"}),W()):k({success:!1,errors:s==null?void 0:s.error}),f(!1)}},je=async()=>{if(d){f(!0);const s=await z(`/${o.section}/DeleteComment`,"DELETE",{id:d.id});s&&s.success?(d.parentId?(S==null||S(d.id),$(d.parentId,a=>({...a,answers:a.answers-1}))):oe(d.id),j==null||j(a=>a-d.answers-1),k({success:!0,message:d.parentId?"Reply deleted successfully":"Comment deleted successfully"})):k({success:!1,errors:s==null?void 0:s.error}),f(!1),K()}},K=()=>{h(!1),T(null)},ve=()=>{ee(!1)},we=()=>{Q(s=>({...s,firstIndex:Z(),direction:"from start"}))},be=(s,a,y)=>{N(()=>a),G(null,s,y)},ye=(s,a)=>{u(()=>a),G(s,s.parentId,s.message)},Ce=(s,a)=>{F(()=>a),T(s),h(!0)},Re=(s,a,y)=>{y?k({success:!1,errors:y}):$(s,te=>({...te,votes:te.votes+2*a-1,isUpvoted:a==1}))},Ie=s=>{me({parentId:s}),ee(!0)},Ne=s=>{x(a=>(a.trim().length==0||a.endsWith(`
`)?a:a+`
`)+s.join(`
`)+`
`)};let Y=I||D;return e.jsxs(e.Fragment,{children:[e.jsxs(U,{style:{zIndex:1070},backdropClassName:"wb-reactions-modal__backdrop",size:"sm",show:_,onHide:K,centered:!0,children:[e.jsx(U.Header,{closeButton:!0,children:e.jsx(U.Title,{children:"Are you sure?"})}),e.jsx(U.Body,{children:"Your answer will be permanently deleted."}),e.jsxs(U.Footer,{children:[e.jsx(E,{variant:"secondary",onClick:K,children:"Cancel"}),e.jsx(E,{variant:"danger",onClick:je,children:"Delete"})]})]}),e.jsx($e,{title:"Likes",options:de,visible:ce,onClose:ve,showReactions:!0,countPerPage:10}),e.jsx("div",{className:"d-flex justify-content-between",children:i?e.jsx("div",{className:"col-6 col-sm-4",children:e.jsxs(Te.Select,{size:"sm",value:l,onChange:xe,children:[e.jsx("option",{value:"1",children:"Most Popular"}),e.jsx("option",{value:"2",children:"Oldest"}),e.jsx("option",{value:"3",children:"Most recent"})]})}):e.jsxs(E,{onClick:fe,variant:"link",size:"sm",children:[e.jsx(Le,{}),"Back to all comments"]})}),e.jsxs("div",{className:"mt-1 pe-1 flex-grow-1 overflow-auto",ref:P,children:[L.length>0&&Z()>0&&i&&e.jsx(E,{variant:"primary",size:"sm",className:"mb-2 w-100",onClick:we,disabled:Y,children:"Load Previous"}),(i?L:L.slice(0,1)).map((s,a)=>{let y=e.jsx(qe,{ref:a===L.length-1?he:void 0,options:o,comment:s,defaultReplies:t!=null&&t.isReply&&!i?L.slice(1):null,onDelete:Ce,onEdit:ye,onReply:be,onShowVotes:Ie,highlightedCommentId:O,onVote:Re});return s.id==M?e.jsx("div",{ref:m,children:y},s.id):e.jsx("div",{children:y},s.id)})]}),e.jsx(ne,{className:"position-absolute",style:{zIndex:"999",bottom:"68px",width:"90%"},bg:w.success?"success":"danger",onClose:()=>k(s=>({success:s.success})),show:w.errors&&w.errors.length>0||!!w.message,delay:2500,autohide:!0,children:e.jsx(ne.Body,{className:"text-white",children:e.jsx("b",{children:w.success?w.message:w.errors?(se=w.errors[0])==null?void 0:se.message:""})})}),e.jsxs("div",{className:"py-2 border-top",children:[e.jsx(E,{hidden:A,size:"sm",variant:"primary",className:"ms-2",onClick:()=>G(null,null),children:"Write comment"}),e.jsxs("div",{hidden:!A,children:[e.jsxs(Ee,{children:[e.jsx(ze,{children:e.jsx("b",{children:g==null?void 0:g.name})}),e.jsx(Ue,{ref:r,size:"sm",value:b,setValue:x,placeholder:"Write your comment here...",rows:5})]}),e.jsxs("div",{className:"d-flex justify-content-end mt-2",children:[e.jsx(Be,{onSubmit:Ne}),e.jsx(E,{size:"sm",variant:"secondary",className:"ms-2",onClick:W,children:"Cancel"}),d===null?e.jsx(E,{size:"sm",className:"ms-2",variant:"primary",onClick:pe,disabled:Y||b.length===0,children:M?"Post Reply":"Post Comment"}):e.jsx(E,{size:"sm",variant:"primary",className:"ms-2",onClick:ge,disabled:Y||b.length===0,children:"Save changes"})]})]})]})]})};export{Ze as C};
