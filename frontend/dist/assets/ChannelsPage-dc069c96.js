import{R as $,j as e,g as te,r as n,k as be,f as ye,L as Ne,h as ts,d as ns}from"./index-b2f3d98e.js";import{D as Oe,P as ee}from"./DateUtils-6b83375c.js";import{P as se}from"./ProfileAvatar-4b9caa46.js";import{t as Te}from"./StringUtils-91be14c5.js";import{C as ke}from"./Card-f2e16d11.js";import{B as T}from"./Button-a8db19a8.js";import{R as we}from"./RequestResultAlert-53291c96.js";import{M as A}from"./Modal-d6b02714.js";import{F as rs}from"./FormControl-a036e454.js";import{T as U}from"./Tab-62b07b90.js";import{N as V}from"./Nav-faaa223c.js";import{A as Re}from"./Alert-f0171b20.js";import{P as as}from"./PostAttachment-84505555.js";import{C as ze,D as Ge,E as is,v as ls,G as os,H as cs,I as ds}from"./index.esm-4a619d62.js";import{g as us,c as xe,h as ms,i as hs}from"./index.esm-cb18ecd9.js";import{T as fs}from"./ToggleSwitch-1582e500.js";import{U as xs,L as le}from"./UserSearch-78852d36.js";import{F as q}from"./Form-4647d33b.js";import{R as gs}from"./Row-6d073b7a.js";import{C as Pe}from"./Col-1c3a04d0.js";import{B as Be}from"./Badge-d192c51b.js";import{I as ps}from"./InputGroup-a2b32b7f.js";import{a as He,_ as Ve}from"./useMergedRefs-f5c2a768.js";import{_ as $e,f as vs,g as js,h as Le}from"./CloseButton-439f23fc.js";import{b as Cs,r as Ns}from"./AbstractModalHeader-f9d4f376.js";import{P as ws}from"./PageTitle-83c92925.js";import{C as bs}from"./Container-aded6eb3.js";import"./ThemeProvider-c318c21f.js";import"./createWithBsPrefix-c6deafcc.js";import"./divWithClassName-9b80bbe4.js";import"./CardHeaderContext-82a24767.js";import"./useWindow-763af26a.js";import"./Anchor-1fe32030.js";import"./index-11ee592c.js";import"./import-c49ebc7f.js";import"./Nav-131532f4.js";import"./DataKey-e12315fd.js";import"./NavContext-f8abb837.js";import"./NavbarContext-864acb8f.js";import"./index-19ddc0d1.js";import"./iconBase-7a454df3.js";import"./InputGroupContext-66571c02.js";function ys(s){if(s===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return s}const De=$.forwardRef(({channel:s,onClick:r,selected:a},t)=>{let i=e.jsxs("div",{className:`d-flex align-items-center gap-2 p-2 border-bottom cursor-pointer ${a?"border border-2 border-dark":"border-bottom"}`,onClick:r,style:{cursor:"pointer"},children:[s.type==2?e.jsx("img",{src:"/resources/images/group.svg",alt:"channel avatar",className:"me-2",width:32,height:32}):e.jsx(se,{size:32,avatarImage:s.coverImage}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"fw-bold",children:s.title}),e.jsx("div",{className:"small text-muted",children:Oe.format2(new Date(s.updatedAt))})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"small",children:s.lastMessage!=null&&(s.lastMessage.type===1?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"text-primary",children:[s.lastMessage.userName,": "]}),s.lastMessage.deleted?e.jsx("i",{className:"text-muted",children:"Message was deleted"}):e.jsx("span",{className:"text-muted",children:Te(s.lastMessage.content,20)})]}):e.jsx("span",{className:"text-muted",children:Te(s.lastMessage.content.replace("{action_user}",s.lastMessage.userName),20)}))}),e.jsx("div",{children:s.unreadCount>0&&e.jsx("span",{className:"badge "+(s.muted?"bg-secondary":"bg-danger"),style:{fontSize:"0.7rem"},children:s.unreadCount>99?"99+":s.unreadCount})})]})]})]});return t?e.jsx("div",{ref:t,children:i}):e.jsx("div",{children:i})}),Es=(s,r,a)=>{const{sendJsonRequest:t}=te(),[i,l]=n.useState([]),[d,m]=n.useState(!1),[u,g]=n.useState(""),[h,C]=n.useState(!1),{socket:y}=be(),M=n.useRef([]),{userInfo:_}=ye(),o=n.useRef(a);return n.useEffect(()=>{o.current=a},[a]),n.useEffect(()=>{M.current=i},[i]),n.useEffect(()=>{(async()=>{m(!0),g("");const v=await t("/Channels","POST",{fromDate:r,count:s});v&&v.channels?(l(k=>[...k,...v.channels]),C(v.channels.length===s)):g((v==null?void 0:v.error[0].message)??"Something went wrong"),m(!1)})()},[r]),n.useEffect(()=>{if(!y)return;const N=async w=>{var b;const S=M.current.find(j=>j.id===w.channelId);if(w.type===3&&w.userId===(_==null?void 0:_.id)){l(j=>j.filter(L=>L.id!==w.channelId)),(b=o.current)==null||b.call(o,w.channelId);return}if(S)l(j=>{const L=j.map(x=>x.id===w.channelId?{...x,updatedAt:w.createdAt,unreadCount:x.unreadCount+1,lastMessage:w,title:w.type==4?w.channelTitle:x.title}:x),D=L.find(x=>x.id===w.channelId),G=L.filter(x=>x.id!==w.channelId);return D?[D,...G]:L});else{const j=await t("/Channels/GetChannel","POST",{channelId:w.channelId});j&&j.channel&&l(L=>[{...j.channel,lastMessage:w},...L])}},v=w=>{l(S=>S.map(b=>b.id===w.channelId?{...b,lastMessage:b.lastMessage?{...b.lastMessage,viewed:!0}:void 0,unreadCount:0}:b))},k=w=>{var S;l(b=>b.filter(j=>j.id!==w.channelId)),(S=o.current)==null||S.call(o,w.channelId)},O=w=>{l(S=>S.map(b=>b.id===w.channelId?{...b,lastMessage:b.lastMessage&&b.lastMessage.id==w.messageId?{...b.lastMessage,deleted:!0,content:""}:void 0}:b))},P=w=>{l(S=>S.map(b=>b.id===w.channelId?{...b,lastMessage:b.lastMessage&&b.lastMessage.id==w.messageId?{...b.lastMessage,content:w.content}:void 0}:b))};return y.on("channels:new_message",N),y.on("channels:messages_seen",v),y.on("channels:channel_deleted",k),y.on("channels:message_deleted",O),y.on("channels:message_edited",P),()=>{y.off("channels:new_message",N),y.off("channels:messages_seen",v),y.off("channels:channel_deleted",k),y.off("channels:message_deleted",O),y.off("channels:message_edited",P)}},[y]),{isLoading:d,error:u,results:i,hasNextPage:h,addChannel:N=>{l(v=>[N,...v])}}},Ms=(s,r)=>{const{sendJsonRequest:a}=te(),[t,i]=n.useState([]),[l,d]=n.useState(0),[m,u]=n.useState(!1),[g,h]=n.useState(""),[C,y]=n.useState(!1),{socket:M}=be();return n.useEffect(()=>{(async()=>{u(!0),h("");const N=await a("/Channels/Invites","POST",{fromDate:r,count:s});N&&N.invites?(i(v=>[...v,...N.invites]),d(N.count),y(N.invites.length===s)):h((N==null?void 0:N.error[0].message)??"Something went wrong"),u(!1)})()},[r]),n.useEffect(()=>{if(!M)return;const E=v=>{i(k=>[v,...k]),d(k=>k+1)},N=v=>{i(k=>k.filter(O=>O.id!==v.inviteId)),d(k=>k-1)};return M.on("channels:new_invite",E),M.on("channels:invite_canceled",N),()=>{M.off("channels:new_invite",E),M.off("channels:invite_canceled",N)}},[M]),{isLoading:m,error:g,results:t,totalCount:l,hasNextPage:C,add:E=>{i(N=>[E,...N])},remove:E=>{i(N=>N.filter(v=>v.id!==E)),d(N=>N-1)}}},_e=$.forwardRef(({invite:s,onAccept:r,onDecline:a},t)=>{let i=e.jsx(ke,{className:"mb-3",children:e.jsxs(ke.Body,{className:"d-flex align-items-center gap-2",children:[e.jsx(se,{avatarImage:s.authorAvatar,size:42}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("div",{children:e.jsx("strong",{children:s.channelTitle})}),e.jsxs("div",{className:"text-muted small",children:["Invited by ",e.jsx(ee,{userId:s.authorId,userName:s.authorName})]})]}),e.jsxs("div",{className:"d-flex flex-column gap-2 ms-3",children:[e.jsx(T,{variant:"success",size:"sm",onClick:()=>r(s.id),children:"Accept"}),e.jsx(T,{variant:"outline-danger",size:"sm",onClick:()=>a(s.id),children:"Decline"})]})]})});return t?e.jsx("div",{ref:t,children:i}):e.jsx("div",{children:i})}),Ss=({onChannelSelect:s,currentChannelId:r,onExit:a})=>{const[t,i]=n.useState("channels"),[l,d]=n.useState(""),[m,u]=n.useState(),[g,h]=n.useState(!1),{sendJsonRequest:C}=te(),[y,M]=n.useState(null),_=n.useCallback(x=>{r===x&&a()},[r]),o=Es(10,y,_),[E,N]=n.useState(null),v=Ms(10,E),k=n.useRef(),O=n.useCallback(x=>{o.isLoading||(k.current&&k.current.disconnect(),k.current=new IntersectionObserver(I=>{I[0].isIntersecting&&o.hasNextPage&&M(()=>new Date(o.results[o.results.length-1].updatedAt))}),x&&k.current.observe(x))},[o.isLoading,o.hasNextPage,o.results]),P=n.useRef(),w=n.useCallback(x=>{v.isLoading||(P.current&&P.current.disconnect(),P.current=new IntersectionObserver(I=>{I[0].isIntersecting&&v.hasNextPage&&N(()=>new Date(v.results[v.results.length-1].createdAt))}),x&&P.current.observe(x))},[v.isLoading,v.hasNextPage,v.results]),S=async()=>{const x=await C("/Channels/CreateGroup","POST",{title:l});x&&x.channel?(o.addChannel(x.channel),b(),d("")):u(x.error)},b=()=>{d(""),u(void 0),h(!1)},j=async x=>{const I=await C("/Channels/AcceptInvite","POST",{inviteId:x,accepted:!0});I&&I.success&&(v.remove(x),i("channels"))},L=async x=>{const I=await C("/Channels/AcceptInvite","POST",{inviteId:x,accepted:!1});I&&I.success&&v.remove(x)},D=o.results.map((x,I)=>{const B=x.id===r;return e.jsx("div",{children:o.results.length===I+1?e.jsx(De,{ref:O,channel:x,onClick:()=>s(x.id),selected:B}):e.jsx(De,{channel:x,onClick:()=>s(x.id),selected:B})},x.id)}),G=v.results.map((x,I)=>e.jsx("div",{className:"mt-2",children:o.results.length===I+1?e.jsx(_e,{ref:w,invite:x,onAccept:j,onDecline:L}):e.jsx(_e,{invite:x,onAccept:j,onDecline:L})},x.id));return e.jsxs(e.Fragment,{children:[e.jsxs(A,{show:g,onHide:b,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Create group"})}),e.jsxs(A.Body,{children:[e.jsx("p",{children:"How would you like to name your group?"}),e.jsx(rs,{className:"my-2",type:"text",placeholder:"Group title",value:l,onChange:x=>d(x.target.value)}),e.jsx(we,{errors:m})]}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:b,children:"Cancel"}),e.jsx(T,{variant:"primary",onClick:S,disabled:l.length<3,children:"Create"})]})]}),e.jsxs("div",{className:"d-flex flex-column p-2",children:[e.jsx("div",{className:"mb-3",children:e.jsx(T,{variant:"primary",onClick:()=>h(!0),children:"+ Create Group"})}),e.jsxs(U.Container,{activeKey:t,onSelect:x=>i(x||"channels"),children:[e.jsxs(V,{variant:"pills",className:"mb-3 gap-2",children:[e.jsx(V.Item,{className:"position-relative",children:e.jsx(V.Link,{className:"border border-primary",eventKey:"channels",children:"Channels"})}),e.jsxs(V.Item,{className:"position-relative",children:[e.jsx(V.Link,{className:"border border-primary",eventKey:"invites",children:"Invites"}),v.totalCount>0&&e.jsxs("span",{className:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",children:[v.totalCount>99?"99+":v.totalCount,e.jsx("span",{className:"visually-hidden",children:"pending invites"})]})]})]}),e.jsxs(U.Content,{className:"flex-grow-1 overflow-auto pb-4",children:[e.jsxs(U.Pane,{eventKey:"channels",children:[!o.isLoading&&o.error!==""?e.jsx(Re,{variant:"danger",children:o.error}):!o.isLoading&&o.results.length===0?e.jsx("div",{className:"text-center text-muted mt-5",children:"You have no channels yet. Create a group or wait for invites!"}):D,o.isLoading&&e.jsx("div",{className:"d-flex justify-content-center mt-5 text-center",children:e.jsx(Ne,{})})]}),e.jsxs(U.Pane,{eventKey:"invites",children:[!v.isLoading&&v.error!==""?e.jsx(Re,{variant:"danger",children:v.error}):!v.isLoading&&v.results.length===0?e.jsx("div",{className:"text-center text-muted mt-5",children:"You have no pending invites."}):G,v.isLoading&&e.jsx("div",{className:"d-flex justify-content-center mt-5 text-center",children:e.jsx(Ne,{})})]})]})]})]})]})};var Is=function(r,a){return r&&a&&a.split(" ").forEach(function(t){return Cs(r,t)})},Ce=function(r,a){return r&&a&&a.split(" ").forEach(function(t){return Ns(r,t)})},Ee=function(s){$e(r,s);function r(){for(var t,i=arguments.length,l=new Array(i),d=0;d<i;d++)l[d]=arguments[d];return t=s.call.apply(s,[this].concat(l))||this,t.appliedClasses={appear:{},enter:{},exit:{}},t.onEnter=function(m,u){var g=t.resolveArguments(m,u),h=g[0],C=g[1];t.removeClasses(h,"exit"),t.addClass(h,C?"appear":"enter","base"),t.props.onEnter&&t.props.onEnter(m,u)},t.onEntering=function(m,u){var g=t.resolveArguments(m,u),h=g[0],C=g[1],y=C?"appear":"enter";t.addClass(h,y,"active"),t.props.onEntering&&t.props.onEntering(m,u)},t.onEntered=function(m,u){var g=t.resolveArguments(m,u),h=g[0],C=g[1],y=C?"appear":"enter";t.removeClasses(h,y),t.addClass(h,y,"done"),t.props.onEntered&&t.props.onEntered(m,u)},t.onExit=function(m){var u=t.resolveArguments(m),g=u[0];t.removeClasses(g,"appear"),t.removeClasses(g,"enter"),t.addClass(g,"exit","base"),t.props.onExit&&t.props.onExit(m)},t.onExiting=function(m){var u=t.resolveArguments(m),g=u[0];t.addClass(g,"exit","active"),t.props.onExiting&&t.props.onExiting(m)},t.onExited=function(m){var u=t.resolveArguments(m),g=u[0];t.removeClasses(g,"exit"),t.addClass(g,"exit","done"),t.props.onExited&&t.props.onExited(m)},t.resolveArguments=function(m,u){return t.props.nodeRef?[t.props.nodeRef.current,m]:[m,u]},t.getClassNames=function(m){var u=t.props.classNames,g=typeof u=="string",h=g&&u?u+"-":"",C=g?""+h+m:u[m],y=g?C+"-active":u[m+"Active"],M=g?C+"-done":u[m+"Done"];return{baseClassName:C,activeClassName:y,doneClassName:M}},t}var a=r.prototype;return a.addClass=function(i,l,d){var m=this.getClassNames(l)[d+"ClassName"],u=this.getClassNames("enter"),g=u.doneClassName;l==="appear"&&d==="done"&&g&&(m+=" "+g),d==="active"&&i&&vs(i),m&&(this.appliedClasses[l][d]=m,Is(i,m))},a.removeClasses=function(i,l){var d=this.appliedClasses[l],m=d.base,u=d.active,g=d.done;this.appliedClasses[l]={},m&&Ce(i,m),u&&Ce(i,u),g&&Ce(i,g)},a.render=function(){var i=this.props;i.classNames;var l=He(i,["classNames"]);return $.createElement(js,Ve({},l,{onEnter:this.onEnter,onEntered:this.onEntered,onEntering:this.onEntering,onExit:this.onExit,onExiting:this.onExiting,onExited:this.onExited}))},r}($.Component);Ee.defaultProps={classNames:""};Ee.propTypes={};const As=Ee;function Me(s,r){var a=function(l){return r&&n.isValidElement(l)?r(l):l},t=Object.create(null);return s&&n.Children.map(s,function(i){return i}).forEach(function(i){t[i.key]=a(i)}),t}function Ts(s,r){s=s||{},r=r||{};function a(h){return h in r?r[h]:s[h]}var t=Object.create(null),i=[];for(var l in s)l in r?i.length&&(t[l]=i,i=[]):i.push(l);var d,m={};for(var u in r){if(t[u])for(d=0;d<t[u].length;d++){var g=t[u][d];m[t[u][d]]=a(g)}m[u]=a(u)}for(d=0;d<i.length;d++)m[i[d]]=a(i[d]);return m}function Y(s,r,a){return a[r]!=null?a[r]:s.props[r]}function ks(s,r){return Me(s.children,function(a){return n.cloneElement(a,{onExited:r.bind(null,a),in:!0,appear:Y(a,"appear",s),enter:Y(a,"enter",s),exit:Y(a,"exit",s)})})}function Rs(s,r,a){var t=Me(s.children),i=Ts(r,t);return Object.keys(i).forEach(function(l){var d=i[l];if(n.isValidElement(d)){var m=l in r,u=l in t,g=r[l],h=n.isValidElement(g)&&!g.props.in;u&&(!m||h)?i[l]=n.cloneElement(d,{onExited:a.bind(null,d),in:!0,exit:Y(d,"exit",s),enter:Y(d,"enter",s)}):!u&&m&&!h?i[l]=n.cloneElement(d,{in:!1}):u&&m&&n.isValidElement(g)&&(i[l]=n.cloneElement(d,{onExited:a.bind(null,d),in:g.props.in,exit:Y(d,"exit",s),enter:Y(d,"enter",s)}))}}),i}var Ps=Object.values||function(s){return Object.keys(s).map(function(r){return s[r]})},Ls={component:"div",childFactory:function(r){return r}},Se=function(s){$e(r,s);function r(t,i){var l;l=s.call(this,t,i)||this;var d=l.handleExited.bind(ys(l));return l.state={contextValue:{isMounting:!0},handleExited:d,firstRender:!0},l}var a=r.prototype;return a.componentDidMount=function(){this.mounted=!0,this.setState({contextValue:{isMounting:!1}})},a.componentWillUnmount=function(){this.mounted=!1},r.getDerivedStateFromProps=function(i,l){var d=l.children,m=l.handleExited,u=l.firstRender;return{children:u?ks(i,m):Rs(i,d,m),firstRender:!1}},a.handleExited=function(i,l){var d=Me(this.props.children);i.key in d||(i.props.onExited&&i.props.onExited(l),this.mounted&&this.setState(function(m){var u=Ve({},m.children);return delete u[i.key],{children:u}}))},a.render=function(){var i=this.props,l=i.component,d=i.childFactory,m=He(i,["component","childFactory"]),u=this.state.contextValue,g=Ps(this.state.children).map(d);return delete m.appear,delete m.enter,delete m.exit,l===null?$.createElement(Le.Provider,{value:u},g):$.createElement(Le.Provider,{value:u},$.createElement(l,m,g))},r}($.Component);Se.propTypes={};Se.defaultProps=Ls;const Ds=Se,Ue=({message:s})=>{const[r,a]=n.useState(!1),t=n.useRef(null),i=()=>{a(!r)};return n.useEffect(()=>{r&&t.current&&setTimeout(()=>{var l;(l=t.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})},50)},[r]),e.jsx(e.Fragment,{children:e.jsxs("div",{ref:t,className:"small",children:[e.jsxs("div",{className:"d-flex gap-1 align-items-start",children:[e.jsx(ze,{className:"flex-shrink-0"}),e.jsx(se,{size:20,avatarImage:s.userAvatar}),e.jsx(ee,{userId:s.userId,userName:"@"+s.userName}),s.deleted?e.jsx("i",{className:"text-muted",children:"Deleted"}):e.jsx("span",{className:`wb-channels-reply__text ${r?"wb-channels-reply__text--expanded":""}`,onClick:i,style:{cursor:"pointer"},children:s.content})]}),r&&!s.deleted&&e.jsx("div",{className:"wb-channels-reply__full-content",onClick:i,style:{cursor:"pointer"},children:s.content})]})})},_s=42,Fe=$.forwardRef(({message:s,showHeader:r,onContextMenu:a},t)=>{const i=n.useRef(null),l=n.useRef(null),d=C=>{C.preventDefault(),!(s.type!==1||s.deleted)&&a(s,i.current)},m=()=>{l.current=setTimeout(()=>{s.type!==1||s.deleted||a(s,i.current)},500)},u=()=>{l.current&&clearTimeout(l.current)},g=()=>{l.current&&clearTimeout(l.current)};let h;if(s.type!==1){const C=s.content.split("{action_user}");h=e.jsx("div",{className:"d-flex justify-content-center",children:e.jsxs("div",{className:"p-2 rounded text-center wb-channels-message__body",children:[C[0],e.jsx(ee,{userId:s.userId,userName:s.userName}),C[1]]})})}else h=e.jsxs("div",{className:"d-flex",children:[r&&e.jsx("div",{className:"me-2 flex-shrink-0",children:e.jsx(se,{avatarImage:s.userAvatar,size:_s})}),e.jsxs("div",{className:"flex-grow-1",children:[r&&e.jsxs("div",{className:"d-flex align-items-center mb-1",children:[e.jsx(ee,{className:"fw-bold",userId:s.userId,userName:s.userName}),e.jsx("small",{className:"text-muted ms-2",children:Oe.format(new Date(s.createdAt))})]}),e.jsxs("div",{ref:i,className:`p-2 rounded wb-channels-message__body ${r?"":"ms-5 indented"}`,onContextMenu:d,onTouchStart:m,onTouchMove:u,onTouchEnd:g,children:[s.deleted?e.jsx("i",{className:"text-muted",children:"Message was deleted"}):s.content,!s.deleted&&new Date(s.createdAt)<new Date(s.updatedAt)&&e.jsx("small",{className:"text-muted",children:" (edited)"}),!s.deleted&&e.jsx("div",{children:s.attachments.map(C=>e.jsx("div",{className:"mt-2",children:e.jsx(as,{data:C})},C.id))})]})]})]});return h=e.jsxs("div",{style:{maxWidth:"720px"},children:[s.repliedTo&&e.jsx("div",{className:"ms-5 indented",children:e.jsx(Ue,{message:s.repliedTo})}),h]}),e.jsx("div",{ref:t,className:"wb-channels-message",children:h})}),Fs=({channel:s,onUserInvite:r,onUserRemove:a,onCancelInvite:t,onTitleChange:i,onRoleChange:l,onToggleNotifications:d})=>{var K,de,ae,ue,me;const[m,u]=n.useState("general"),[g,h]=n.useState(""),[C,y]=n.useState(""),[M,_]=n.useState(!0),{userInfo:o}=ye(),{sendJsonRequest:E}=te(),[N,v]=n.useState({}),[k,O]=n.useState({}),[P,w]=n.useState(!1),[S,b]=n.useState(!1),[j,L]=n.useState(null),[D,G]=n.useState("");n.useEffect(()=>{u("general")},[s==null?void 0:s.id]),n.useEffect(()=>{v({}),O({}),m=="general"&&(y(s.title??""),_(!s.muted))},[m]);const x=(K=s.participants)==null?void 0:K.find(p=>p.userId==(o==null?void 0:o.id)),I=(x==null?void 0:x.role)==="Owner",B=I||(x==null?void 0:x.role)==="Admin",ne=()=>{w(!1)},X=()=>{b(!1)},H=()=>{L(null),G("")},ge=async p=>{const z=await E("/Channels/GroupInviteUser","POST",{channelId:s.id,userId:p});z&&z.invite?(v({message:"Invite created successfully"}),r({...z.invite,authorId:o==null?void 0:o.id,authorName:o==null?void 0:o.name,authorAvatar:o==null?void 0:o.avatarImage})):v({errors:z==null?void 0:z.error}),h("")},oe=async()=>{if(!j)return;const p=await E("/Channels/GroupRemoveUser","POST",{channelId:s.id,userId:j});p&&p.success&&(a(j),H())},pe=async()=>{if(j&&D){const p=await E("/Channels/GroupChangeRole","POST",{channelId:s.id,userId:j,role:D});p&&p.success&&(l(p.data.userId,p.data.role),H())}},ce=async()=>{if(s.title==C.trim())return;const p=await E("/Channels/GroupRename","POST",{channelId:s.id,title:C.trim()});p&&p.success?(O({message:"Title changed successfully"}),i(p.data.title)):O({errors:p==null?void 0:p.error})},re=async()=>{await E("/Channels/LeaveChannel","POST",{channelId:s.id})},W=async()=>{await E("/Channels/DeleteChannel","POST",{channelId:s.id})},Z=async p=>{const z=await E("/Channels/GroupCancelInvite","POST",{inviteId:p});z&&z.success&&t(p)},ve=async p=>{const z=await E("/Channels/MuteChannel","POST",{channelId:s.id,muted:!p});z&&z.success&&(d(p),_(!z.data.muted))},J=(de=s.participants)==null?void 0:de.find(p=>p.userId==j);return e.jsxs(e.Fragment,{children:[e.jsxs(A,{show:P,onHide:ne,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Are you sure?"})}),e.jsx(A.Body,{children:"Channel will be permanently deleted."}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:ne,children:"Cancel"}),e.jsx(T,{variant:"danger",onClick:W,children:"Delete"})]})]}),e.jsxs(A,{show:S,onHide:X,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Are you sure?"})}),e.jsx(A.Body,{children:"You won't be able to join again unless you are reinvited."}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:X,children:"Cancel"}),e.jsx(T,{variant:"danger",onClick:re,children:"Leave"})]})]}),e.jsxs(A,{show:j!==null,onHide:H,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:J==null?void 0:J.userName})}),e.jsx(A.Body,{children:J&&e.jsxs(q.Group,{controlId:"participantRole",children:[e.jsx(q.Label,{children:"Role"}),e.jsxs(q.Select,{size:"sm",value:D||J.role,onChange:p=>G(p.target.value),disabled:!I,children:[e.jsx("option",{value:"Owner",children:"Owner"}),e.jsx("option",{value:"Admin",children:"Admin"}),e.jsx("option",{value:"Member",children:"Member"})]}),D==="Owner"&&I&&e.jsx("div",{className:"mt-2 text-sm text-warning",children:"By assigning this user as Owner, your role will be changed to Admin."})]})}),e.jsxs(A.Footer,{children:[e.jsx(T,{size:"sm",variant:"secondary",onClick:H,children:"Cancel"}),e.jsx(T,{size:"sm",variant:"danger",onClick:oe,children:"Remove"}),I&&e.jsx(T,{size:"sm",variant:"primary",onClick:pe,children:"Save"})]})]}),e.jsx(U.Container,{activeKey:m,onSelect:p=>u(p||"general"),children:e.jsxs(gs,{children:[e.jsx(Pe,{sm:3,children:e.jsxs(V,{variant:"pills",className:"flex-column mb-2",children:[e.jsx(V.Item,{children:e.jsx(V.Link,{eventKey:"general",children:"General"})}),s.type==2&&e.jsx(V.Item,{children:e.jsx(V.Link,{eventKey:"members",children:"Members"})})]})}),e.jsx(Pe,{sm:9,children:e.jsxs(U.Content,{children:[s.type==2&&e.jsxs(U.Pane,{eventKey:"members",children:[B&&e.jsxs("div",{className:"mb-3",children:[e.jsx(q.Label,{children:"Invite user"}),e.jsx(xs,{value:g,setValue:h,onSelect:p=>ge(p.id)}),e.jsx(we,{errors:N.errors,message:N.message})]}),B&&e.jsxs(e.Fragment,{children:[e.jsx("h5",{children:"Invites"}),e.jsxs(le,{children:[(ae=s.invites)==null?void 0:ae.map(p=>e.jsxs(le.Item,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"d-flex flex-column",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(se,{avatarImage:p.invitedUserAvatar,size:36}),e.jsx(ee,{userId:p.invitedUserId??"",userName:p.invitedUserName??"Unknown"})]}),e.jsxs("small",{className:"text-muted ms-5",children:["Invited by ",p.authorName]})]}),e.jsx(T,{variant:"outline-danger",size:"sm",onClick:()=>Z(p.id),children:"Cancel"})]},p.id)),((ue=s.invites)==null?void 0:ue.length)===0&&e.jsx(le.Item,{className:"text-muted fst-italic",children:"No invites"})]})]}),e.jsx("h5",{children:"Members"}),e.jsx(le,{children:(me=s.participants)==null?void 0:me.map(p=>e.jsxs(le.Item,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(se,{avatarImage:p.userAvatar,size:32}),e.jsx(ee,{userId:p.userId,userName:p.userName}),e.jsx(Be,{bg:"secondary",children:p.role})]}),B&&p.role!="Owner"&&p.userId!==(o==null?void 0:o.id)&&e.jsx("div",{className:"d-flex align-items-center gap-2",children:e.jsx(T,{variant:"outline-primary",size:"sm",onClick:()=>{L(p.userId),G(p.role)},children:e.jsx(Ge,{})})})]},p.userId))})]}),e.jsxs(U.Pane,{eventKey:"general",children:[s.type==2&&I&&e.jsxs("div",{className:"mb-3",children:[e.jsx(q.Label,{children:"Channel Name"}),e.jsxs(ps,{children:[e.jsx(q.Control,{size:"sm",value:C,onChange:p=>y(p.target.value)}),e.jsx(T,{size:"sm",onClick:ce,variant:"primary",disabled:C.trim().length<3,children:"Save"})]}),e.jsx(we,{errors:k.errors,message:k.message})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("span",{className:"me-3",children:"Notifications"}),e.jsx(fs,{value:M,onChange:p=>ve(p.target.checked)})]}),s.type==1||I?e.jsx("div",{children:e.jsx(T,{size:"sm",variant:"danger",onClick:()=>w(!0),children:"Delete Channel"})}):e.jsx("div",{children:e.jsx(T,{size:"sm",variant:"outline-danger",onClick:()=>b(!0),children:"Leave Channel"})})]})]})})]})})]})},Os=(s,r,a,t,i,l)=>{const{sendJsonRequest:d}=te(),[m,u]=n.useState([]),[g,h]=n.useState(!1),[C,y]=n.useState(""),[M,_]=n.useState(!1),{socket:o}=be(),E=async(P,w)=>{h(!0),y("");const S=await d("/Channels/Messages","POST",{fromDate:P,count:s,channelId:r});S&&S.messages?(u(b=>w?S.messages:[...b,...S.messages]),_(S.messages.length===s)):y((S==null?void 0:S.error[0].message)??"Something went wrong"),h(!1)};n.useEffect(()=>{r&&E(null,!0)},[r]),n.useEffect(()=>{!r||a===null||E(a,!1)},[a]),n.useEffect(()=>{if(!o)return()=>{};const P=j=>{j.channelId===r&&(j.type==2?t({userId:j.userId,userName:j.userName,userAvatar:j.userAvatar,role:"Member"}):j.type==3&&i(j.userId),u(L=>[j,...L]))},w=j=>{l(j.lastActiveAt)},S=j=>{u(L=>L.map(D=>D.id==j.messageId?{...D,deleted:!0}:D))},b=j=>{u(L=>L.map(D=>D.id==j.messageId?{...D,content:j.content,attachments:j.attachments,updatedAt:j.updatedAt}:D))};return o.on("channels:new_message",P),o.on("channels:messages_seen",w),o.on("channels:message_deleted",S),o.on("channels:message_edited",b),()=>{o.off("channels:new_message",P),o.off("channels:messages_seen",w),o.off("channels:message_deleted",S),o.off("channels:message_edited",b)}},[o,r]);const N=n.useCallback(()=>{o&&o.emit("channels:messages_seen",{channelId:r})},[o,r]),v=n.useCallback((P,w)=>{o&&o.emit("channels:send_message",{channelId:r,content:P,repliedTo:w&&w.id})},[o,r]),k=n.useCallback(P=>{o&&o.emit("channels:delete_message",{channelId:r,messageId:P})},[o,r]),O=n.useCallback((P,w)=>{o&&o.emit("channels:edit_message",{channelId:r,messageId:P,content:w})},[o,r]);return{isLoading:g,error:C,results:m,hasNextPage:M,markMessagesSeen:N,sendMessage:v,deleteMessage:k,editMessage:O}},Q=8,zs=({visible:s,onClose:r,onCopy:a,onEdit:t,onDelete:i,onReply:l,isOwn:d,anchorRef:m})=>{const u=n.useRef(null),[g,h]=n.useState({top:0,left:0}),C=()=>{if(!u.current||!m.current)return;const y=u.current,{offsetWidth:M,offsetHeight:_}=y,o=m.current.getBoundingClientRect();let E=o.bottom,N=o.left;E+_>window.innerHeight-Q&&(E=o.top-_),N+M>window.innerWidth-Q&&(N=o.right-M),E=Math.min(Math.max(Q,E),window.innerHeight-_-Q),N=Math.min(Math.max(Q,N),window.innerWidth-M-Q),h({top:E,left:N})};return n.useLayoutEffect(()=>{s&&C()},[s]),n.useEffect(()=>{if(!s)return;let y=!0;const M=setTimeout(()=>{y=!1},250),_=v=>{u.current&&!u.current.contains(v.target)&&r()},o=v=>{v.key==="Escape"&&r()},E=()=>C(),N=()=>{y?C():r()};return document.addEventListener("mousedown",_),document.addEventListener("keydown",o),window.addEventListener("resize",E),window.addEventListener("scroll",N,!0),()=>{clearTimeout(M),document.removeEventListener("mousedown",_),document.removeEventListener("keydown",o),window.removeEventListener("resize",E),window.removeEventListener("scroll",N,!0)}},[s,r]),s?e.jsxs("div",{ref:u,role:"menu",className:"position-fixed bg-white border rounded shadow-sm fs-6",style:{top:g.top,left:g.left,zIndex:2e3,minWidth:160},children:[e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none",onClick:a,children:[e.jsx(is,{className:"me-1 text-muted"})," Copy text"]}),e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none",onClick:l,children:[e.jsx(ze,{className:"me-1 text-muted"})," Reply to"]}),d&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none",onClick:t,children:[e.jsx(us,{className:"me-1 text-muted"})," Edit"]}),e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none text-danger",onClick:i,children:[e.jsx(ls,{className:"me-1"})," Delete"]})]})]}):null},Gs=5,Bs=({channelId:s,onExit:r})=>{const[a,t]=n.useState(null),[i,l]=n.useState(null),{userInfo:d}=ye(),h=Os(50,s,i,c=>{t(f=>f?{...f,participants:[...f.participants,c],invites:f.invites.filter(R=>R.invitedUserId!=c.userId)}:null)},c=>{t(f=>f?{...f,participants:f.participants.filter(R=>R.userId!=c)}:null)},c=>{t(f=>f?{...f,lastActiveAt:c}:null)}),[C,y]=n.useState(""),M=n.useRef(null),[_,o]=n.useState(!1),{sendJsonRequest:E}=te(),N=n.useRef(null),[v,k]=n.useState(!1),[O,P]=n.useState(!1),[w,S]=n.useState(!1),[b,j]=n.useState(0),L=n.useRef(!0),D=n.useRef(null),[G,x]=n.useState(null),[I,B]=n.useState(null),ne=n.useRef(null),[X,H]=n.useState(null),[ge,oe]=n.useState(!0),[pe,ce]=n.useState(!1),[re,W]=n.useState(null);n.useEffect(()=>{de(),l(null),P(!0),o(!1),oe(!0)},[s]),n.useEffect(()=>{a&&!a.lastActiveAt&&h.markMessagesSeen()},[a==null?void 0:a.id]),n.useEffect(()=>{const c=M.current;if(!c)return;c.rows=1;const f=parseInt(window.getComputedStyle(c).lineHeight,10),R=Math.ceil(c.scrollHeight/f)-1;c.rows=Math.min(R,Gs)},[C]),n.useEffect(()=>{var c,f;I?(y(I.content),(c=M.current)==null||c.focus()):(y(""),(f=M.current)==null||f.blur())},[I]);const Z=n.useRef(),ve=n.useCallback(c=>{h.isLoading||(Z.current&&Z.current.disconnect(),Z.current=new IntersectionObserver(f=>{f[0].isIntersecting&&h.hasNextPage&&l(()=>new Date(h.results[h.results.length-1].createdAt))}),c&&Z.current.observe(c))},[h.isLoading,h.hasNextPage,h.results.length]);n.useEffect(()=>{const c=N.current;if(!c)return;const f=()=>{const R=c.scrollTop,F=Math.abs(R)<5;L.current=F,S(!F),F&&b>0&&j(0),F&&h.results.length>0&&(a!=null&&a.lastActiveAt)&&new Date(a.lastActiveAt)<new Date(h.results[0].createdAt)&&(t(ie=>ie?{...ie,lastActiveAt:h.results[0].createdAt}:null),h.markMessagesSeen())};return f(),c.addEventListener("scroll",f),()=>c.removeEventListener("scroll",f)},[h.results.length,a==null?void 0:a.id,b]),n.useEffect(()=>{if(h.results.length>0){const c=new Date(h.results[0].createdAt);if(D.current&&c>D.current){const f=h.results.filter(R=>new Date(R.createdAt)>D.current).length;L.current?K("smooth"):j(R=>R+f)}D.current=c}},[h.results.length]),n.useEffect(()=>{h.results.length>0&&h.results[0].userId==(d==null?void 0:d.id)&&k((a==null?void 0:a.lastActiveAt)!=null&&new Date(a.lastActiveAt)<new Date(h.results[0].createdAt))},[h.results.length,a==null?void 0:a.id,d]),n.useEffect(()=>{v&&K("smooth"),k(!1)},[v]),n.useEffect(()=>{O&&!h.isLoading&&h.results.length>0&&(K("auto"),P(!1),oe(!1))},[O,h.isLoading,h.results]);const J=()=>/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent),K=(c="smooth")=>{setTimeout(()=>{const f=N.current;f&&f.scrollTo({top:0,behavior:c})},50)},de=async()=>{ce(!0);const c=await E("/Channels/GetChannel","POST",{channelId:s,includeParticipants:!0,includeInvites:!0});c&&c.channel&&t(c.channel),ce(!1)},ae=async()=>{C.trim().length!==0&&(I?(h.editMessage(I.id,C),B(null)):h.sendMessage(C,re),y(""),W(null))},ue=c=>{J()||c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),ae())},me=()=>{o(c=>!c)},p=c=>{t(f=>f?{...f,participants:f.participants.filter(R=>R.userId!=c)}:null)},z=c=>{t(f=>f?{...f,invites:[...f.invites,c]}:null)},We=c=>{t(f=>f?{...f,invites:f.invites.filter(R=>R.id!=c)}:null)},Je=c=>{t(f=>f?{...f,title:c}:null)},Ke=(c,f)=>{t(R=>R?{...R,participants:R.participants.map(F=>F.userId==c?{...F,role:f}:F.userId==(d==null?void 0:d.id)&&f==="Owner"?{...F,role:"Admin"}:F)}:null)},qe=c=>{t(f=>f?{...f,muted:!c}:null)},Ie=(c,f)=>{!f||c.type!==1||c.deleted||(x(c),ne.current=f)},je=()=>{H(null)},Ye=()=>{X&&h.deleteMessage(X),H(null),je()},Xe=()=>{B(null)},Ze=()=>{G&&navigator.clipboard.writeText(G.content),x(null)},Qe=()=>{B(null),W(null),x(c=>(c&&H(c.id),null))},es=()=>{H(null),W(null),x(c=>(c&&B(c),null))},ss=()=>{H(null),B(null),x(c=>{var f;return c&&(W(c),(f=M.current)==null||f.focus()),null})};let he;const fe=h.results.filter(c=>v||(a==null?void 0:a.lastActiveAt)&&new Date(a.lastActiveAt)>=new Date(c.createdAt));return e.jsxs("div",{className:"d-flex flex-column",style:{height:"100dvh"},children:[a!==null?e.jsxs(e.Fragment,{children:[e.jsxs(A,{show:X!==null,onHide:je,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Are you sure?"})}),e.jsx(A.Body,{children:"Selected message will be deleted."}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:je,children:"Cancel"}),e.jsx(T,{variant:"danger",onClick:Ye,children:"Delete"})]})]}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between p-3 border-bottom z-3 bg-white",style:{height:"44px"},children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(T,{variant:"link",className:"text-secondary",onClick:r,children:e.jsx(xe,{})}),e.jsx("h5",{className:"mb-0",children:a.title})]}),e.jsx(T,{variant:"secondary",size:"sm",onClick:me,children:_?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"me-1"})," Settings"]}):e.jsxs(e.Fragment,{children:[e.jsx(ms,{className:"me-1"})," Settings"]})})]}),e.jsxs("div",{className:"d-flex flex-column flex-grow-1 overflow-hidden",children:[e.jsx("div",{className:"wb-channels-settings bg-light p-3 z-2 "+(_?"":" wb-channels-settings__closed"),children:e.jsx(Fs,{channel:a,onUserRemove:p,onUserInvite:z,onCancelInvite:We,onTitleChange:Je,onRoleChange:Ke,onToggleNotifications:qe})}),e.jsx("div",{className:"d-flex flex-column-reverse flex-grow-1 overflow-y-auto p-3 ms-lg-5",ref:N,children:e.jsx(Ds,{component:null,children:fe.map((c,f)=>{const R=f<fe.length-1?fe[f+1]:null;let F=!1;if(!R)F=!0;else if(R.userId!==c.userId||R.type!==1)F=!0,he=new Date(R.createdAt).getTime();else{const ie=new Date(c.createdAt).getTime();f===0&&(he=ie);const Ae=new Date(R.createdAt).getTime();Math.abs(Ae-he)>2*60*1e3&&(F=!0,he=Ae)}return e.jsx(As,{timeout:300,classNames:ge?"":"wb-channels-message",children:e.jsx("div",{className:"mt-2",children:f===fe.length-1?e.jsx(Fe,{ref:ve,message:c,showHeader:F||c.repliedTo!=null,onContextMenu:Ie}):e.jsx(Fe,{message:c,showHeader:F||c.repliedTo!=null,onContextMenu:Ie})})},c.id)})})}),e.jsxs("div",{className:"position-relative p-2 border-top",children:[I&&e.jsx("div",{className:"small",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"fw-bold text-info",children:[e.jsx(Ge,{})," Edit message"]}),e.jsx(T,{size:"sm",variant:"link",className:"text-muted",onClick:Xe,children:e.jsx(xe,{})})]})}),re&&e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"flex-grow-1",style:{minWidth:0},children:e.jsx(Ue,{message:re})}),e.jsx(T,{size:"sm",variant:"link",className:"text-muted ms-2 p-0 flex-shrink-0",onClick:()=>W(null),children:e.jsx(xe,{})})]}),e.jsxs("div",{className:"d-flex align-items-center",children:[w&&e.jsxs(T,{size:"sm",variant:"secondary",className:"position-absolute end-0 me-3 mt-1 z-1",style:{top:"-50px"},onClick:()=>{K("smooth"),j(0)},children:[b>0&&e.jsx(Be,{bg:"info",className:"me-2",children:b+" new message"+(b>1?"s":"")}),e.jsx(hs,{})]}),e.jsx(q.Control,{ref:M,as:"textarea",rows:1,placeholder:"Type your message...",value:C,onChange:c=>y(c.target.value),onKeyDown:ue,className:"me-2 border-0",maxLength:1024,style:{resize:"none",boxShadow:"none"}}),C.trim().length>0&&e.jsx(T,{variant:"primary",onClick:ae,children:I?e.jsx(os,{}):e.jsx(cs,{})})]})]})]})]}):e.jsx("div",{className:"flex-grow-1 d-flex flex-column justify-content-center align-items-center text-center",children:pe?e.jsx(Ne,{}):e.jsxs("div",{children:[e.jsx("h4",{children:"Channel not found"}),e.jsxs(T,{onClick:r,variant:"primary",children:[e.jsx(ds,{}),"Back to Channels"]})]})}),e.jsx(zs,{visible:G!==null,onClose:()=>x(null),onCopy:Ze,onEdit:es,onDelete:Qe,onReply:ss,isOwn:(G==null?void 0:G.userId)===(d==null?void 0:d.id),anchorRef:ne})]})},Tt=()=>{const{channelId:s}=ts(),r=ns();ws("Channels | Webler Codes");const a=i=>{r(`/Channels/${i}`)},t=()=>{r("/Channels")};return e.jsxs(e.Fragment,{children:[e.jsx(A,{show:s!=null,onHide:t,fullscreen:!0,className:"p-0 m-0",contentClassName:"h-100",children:e.jsx(A.Body,{className:"p-0 m-0 d-flex flex-column",children:s&&e.jsx(Bs,{channelId:s,onExit:t})})}),e.jsx(bs,{fluid:!0,children:e.jsx("div",{className:"wb-channels-container",children:e.jsx(Ss,{onChannelSelect:a,currentChannelId:s??null,onExit:t})})})]})};export{Tt as default};
