import{Q as $,j as e,S as ee,T as Ge,d as te,r as n,U as ye,e as Ee,V as ke,W as se,B as T,i as rs,X as we,Y as V,A as Re,L as be,_ as Be,Z as is,$ as He,a0 as ls,a1 as Ve,a2 as os,a3 as cs,a4 as Pe,a5 as $e,h as q,R as ds,a as Le,l as Ue,a6 as We,I as us,a7 as ms,a8 as hs,a9 as fs,m as xe,aa as xs,ab as gs,ac as vs,ad as ps,ae as js,n as Cs,f as Ns,P as ws,C as bs,J as ys,K as ge,af as Es,M as Ms,N as Ss}from"./index-1922281e.js";import{r as Is}from"./roles-68ed67e6.js";import{t as _e}from"./StringUtils-91be14c5.js";import{M as A}from"./Modal-442d5674.js";import{T as U}from"./Tab-176005a2.js";import{P as As}from"./PostAttachment-1d743a29.js";import{T as Ts}from"./ToggleSwitch-202c0159.js";import{U as ks,L as le,P as Rs}from"./PostAttachmentSelect-f9fc497b.js";import"./CodeList-8f1e181f.js";import"./react-bootstrap-pagination-control.esm-b0e6d4f5.js";import"./Code-110af2d1.js";function Ps(s){if(s===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return s}const De=$.forwardRef(({channel:s,onClick:a,selected:r},t)=>{let i=e.jsxs("div",{className:`d-flex align-items-center gap-2 p-2 border-bottom cursor-pointer ${r?"border border-2 border-dark":"border-bottom"}`,onClick:a,style:{cursor:"pointer"},children:[s.type==2?e.jsx("img",{src:"/resources/images/group.svg",alt:"channel avatar",className:"me-2 rounded-circle",width:32,height:32}):e.jsx(ee,{size:32,avatarImage:s.coverImage}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"fw-bold",children:s.title}),e.jsx("div",{className:"small text-muted",children:Ge.format2(new Date(s.updatedAt))})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"small",children:s.lastMessage!=null&&(s.lastMessage.type===1?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"text-primary",children:[s.lastMessage.userName,": "]}),s.lastMessage.deleted?e.jsx("i",{className:"text-muted",children:"Message was deleted"}):e.jsx("span",{className:"text-muted",children:_e(s.lastMessage.content,20)})]}):e.jsx("span",{className:"text-muted",children:_e(s.lastMessage.content.replace("{action_user}",s.lastMessage.userName),20)}))}),e.jsx("div",{children:s.unreadCount>0&&e.jsx("span",{className:"badge "+(s.muted?"bg-secondary":"bg-danger"),style:{fontSize:"0.7rem"},children:s.unreadCount>99?"99+":s.unreadCount})})]})]})]});return t?e.jsx("div",{ref:t,children:i}):e.jsx("div",{children:i})}),Ls=(s,a,r)=>{const{sendJsonRequest:t}=te(),[i,l]=n.useState([]),[d,m]=n.useState(!1),[u,g]=n.useState(""),[h,C]=n.useState(!1),{socket:y}=ye(),M=n.useRef([]),{userInfo:D}=Ee(),c=n.useRef(r);return n.useEffect(()=>{c.current=r},[r]),n.useEffect(()=>{M.current=i},[i]),n.useEffect(()=>{(async()=>{m(!0),g("");const p=await t("/Channels","POST",{fromDate:a,count:s});p&&p.channels?(l(k=>[...k,...p.channels]),C(p.channels.length===s)):g((p==null?void 0:p.error[0].message)??"Something went wrong"),m(!1)})()},[a]),n.useEffect(()=>{if(!y)return;const N=async w=>{var b;const S=M.current.find(j=>j.id===w.channelId);if(w.type===3&&w.userId===(D==null?void 0:D.id)){l(j=>j.filter(L=>L.id!==w.channelId)),(b=c.current)==null||b.call(c,w.channelId);return}if(S)l(j=>{const L=j.map(x=>x.id===w.channelId?{...x,updatedAt:w.createdAt,unreadCount:x.unreadCount+1,lastMessage:w,title:w.type==4?w.channelTitle:x.title}:x),_=L.find(x=>x.id===w.channelId),G=L.filter(x=>x.id!==w.channelId);return _?[_,...G]:L});else{const j=await t("/Channels/GetChannel","POST",{channelId:w.channelId});j&&j.channel&&l(L=>[{...j.channel,lastMessage:w},...L])}},p=w=>{l(S=>S.map(b=>b.id===w.channelId?{...b,lastMessage:b.lastMessage?{...b.lastMessage,viewed:!0}:void 0,unreadCount:0}:b))},k=w=>{var S;l(b=>b.filter(j=>j.id!==w.channelId)),(S=c.current)==null||S.call(c,w.channelId)},O=w=>{l(S=>S.map(b=>b.id===w.channelId?{...b,lastMessage:b.lastMessage&&b.lastMessage.id==w.messageId?{...b.lastMessage,deleted:!0,content:""}:void 0}:b))},P=w=>{l(S=>S.map(b=>b.id===w.channelId?{...b,lastMessage:b.lastMessage&&b.lastMessage.id==w.messageId?{...b.lastMessage,content:w.content}:void 0}:b))};return y.on("channels:new_message",N),y.on("channels:messages_seen",p),y.on("channels:channel_deleted",k),y.on("channels:message_deleted",O),y.on("channels:message_edited",P),()=>{y.off("channels:new_message",N),y.off("channels:messages_seen",p),y.off("channels:channel_deleted",k),y.off("channels:message_deleted",O),y.off("channels:message_edited",P)}},[y]),{isLoading:d,error:u,results:i,hasNextPage:h,addChannel:N=>{l(p=>[N,...p])}}},_s=(s,a)=>{const{sendJsonRequest:r}=te(),[t,i]=n.useState([]),[l,d]=n.useState(0),[m,u]=n.useState(!1),[g,h]=n.useState(""),[C,y]=n.useState(!1),{socket:M}=ye();return n.useEffect(()=>{(async()=>{u(!0),h("");const N=await r("/Channels/Invites","POST",{fromDate:a,count:s});N&&N.invites?(i(p=>[...p,...N.invites]),d(N.count),y(N.invites.length===s)):h((N==null?void 0:N.error[0].message)??"Something went wrong"),u(!1)})()},[a]),n.useEffect(()=>{if(!M)return;const E=p=>{i(k=>[p,...k]),d(k=>k+1)},N=p=>{i(k=>k.filter(O=>O.id!==p.inviteId)),d(k=>k-1)};return M.on("channels:new_invite",E),M.on("channels:invite_canceled",N),()=>{M.off("channels:new_invite",E),M.off("channels:invite_canceled",N)}},[M]),{isLoading:m,error:g,results:t,totalCount:l,hasNextPage:C,add:E=>{i(N=>[E,...N])},remove:E=>{i(N=>N.filter(p=>p.id!==E)),d(N=>N-1)}}},Fe=$.forwardRef(({invite:s,onAccept:a,onDecline:r},t)=>{let i=e.jsx(ke,{className:"mb-3",children:e.jsxs(ke.Body,{className:"d-flex align-items-center gap-2",children:[e.jsx(ee,{avatarImage:s.authorAvatar,size:42}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("div",{children:e.jsx("strong",{children:s.channelTitle})}),e.jsxs("div",{className:"text-muted small",children:["Invited by ",e.jsx(se,{userId:s.authorId,userName:s.authorName})]})]}),e.jsxs("div",{className:"d-flex flex-column gap-2 ms-3",children:[e.jsx(T,{variant:"success",size:"sm",onClick:()=>a(s.id),children:"Accept"}),e.jsx(T,{variant:"outline-danger",size:"sm",onClick:()=>r(s.id),children:"Decline"})]})]})});return t?e.jsx("div",{ref:t,children:i}):e.jsx("div",{children:i})}),Ds=({onChannelSelect:s,currentChannelId:a,onExit:r})=>{const[t,i]=n.useState("channels"),[l,d]=n.useState(""),[m,u]=n.useState(),[g,h]=n.useState(!1),{sendJsonRequest:C}=te(),[y,M]=n.useState(null),D=n.useCallback(x=>{a===x&&r()},[a]),c=Ls(10,y,D),[E,N]=n.useState(null),p=_s(10,E),k=n.useRef(),O=n.useCallback(x=>{c.isLoading||(k.current&&k.current.disconnect(),k.current=new IntersectionObserver(I=>{I[0].isIntersecting&&c.hasNextPage&&M(()=>new Date(c.results[c.results.length-1].updatedAt))}),x&&k.current.observe(x))},[c.isLoading,c.hasNextPage,c.results]),P=n.useRef(),w=n.useCallback(x=>{p.isLoading||(P.current&&P.current.disconnect(),P.current=new IntersectionObserver(I=>{I[0].isIntersecting&&p.hasNextPage&&N(()=>new Date(p.results[p.results.length-1].createdAt))}),x&&P.current.observe(x))},[p.isLoading,p.hasNextPage,p.results]),S=async()=>{const x=await C("/Channels/CreateGroup","POST",{title:l});x&&x.channel?(c.addChannel(x.channel),b(),d("")):u(x.error)},b=()=>{d(""),u(void 0),h(!1)},j=async x=>{const I=await C("/Channels/AcceptInvite","POST",{inviteId:x,accepted:!0});I&&I.success&&(p.remove(x),i("channels"))},L=async x=>{const I=await C("/Channels/AcceptInvite","POST",{inviteId:x,accepted:!1});I&&I.success&&p.remove(x)},_=c.results.map((x,I)=>{const B=x.id===a;return e.jsx("div",{children:c.results.length===I+1?e.jsx(De,{ref:O,channel:x,onClick:()=>s(x.id),selected:B}):e.jsx(De,{channel:x,onClick:()=>s(x.id),selected:B})},x.id)}),G=p.results.map((x,I)=>e.jsx("div",{className:"mt-2",children:c.results.length===I+1?e.jsx(Fe,{ref:w,invite:x,onAccept:j,onDecline:L}):e.jsx(Fe,{invite:x,onAccept:j,onDecline:L})},x.id));return e.jsxs(e.Fragment,{children:[e.jsxs(A,{show:g,onHide:b,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Create group"})}),e.jsxs(A.Body,{children:[e.jsx("p",{children:"How would you like to name your group?"}),e.jsx(rs,{className:"my-2",type:"text",placeholder:"Group title",value:l,onChange:x=>d(x.target.value)}),e.jsx(we,{errors:m})]}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:b,children:"Cancel"}),e.jsx(T,{variant:"primary",onClick:S,disabled:l.length<3,children:"Create"})]})]}),e.jsxs("div",{className:"d-flex flex-column p-2",children:[e.jsx("div",{className:"mb-3",children:e.jsx(T,{variant:"primary",onClick:()=>h(!0),children:"+ Create Group"})}),e.jsxs(U.Container,{activeKey:t,onSelect:x=>i(x||"channels"),children:[e.jsxs(V,{variant:"pills",className:"mb-3 gap-2",children:[e.jsx(V.Item,{className:"position-relative",children:e.jsx(V.Link,{className:"border border-primary",eventKey:"channels",children:"Channels"})}),e.jsxs(V.Item,{className:"position-relative",children:[e.jsx(V.Link,{className:"border border-primary",eventKey:"invites",children:"Invites"}),p.totalCount>0&&e.jsxs("span",{className:"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger",children:[p.totalCount>99?"99+":p.totalCount,e.jsx("span",{className:"visually-hidden",children:"pending invites"})]})]})]}),e.jsxs(U.Content,{className:"flex-grow-1 overflow-auto pb-4",children:[e.jsxs(U.Pane,{eventKey:"channels",children:[!c.isLoading&&c.error!==""?e.jsx(Re,{variant:"danger",children:c.error}):!c.isLoading&&c.results.length===0?e.jsx("div",{className:"text-center text-muted mt-5",children:"You have no channels yet. Create a group or wait for invites!"}):_,c.isLoading&&e.jsx("div",{className:"d-flex justify-content-center mt-5 text-center",children:e.jsx(be,{})})]}),e.jsxs(U.Pane,{eventKey:"invites",children:[!p.isLoading&&p.error!==""?e.jsx(Re,{variant:"danger",children:p.error}):!p.isLoading&&p.results.length===0?e.jsx("div",{className:"text-center text-muted mt-5",children:"You have no pending invites."}):G,p.isLoading&&e.jsx("div",{className:"d-flex justify-content-center mt-5 text-center",children:e.jsx(be,{})})]})]})]})]})]})};var Fs=function(a,r){return a&&r&&r.split(" ").forEach(function(t){return os(a,t)})},Ne=function(a,r){return a&&r&&r.split(" ").forEach(function(t){return cs(a,t)})},Me=function(s){Be(a,s);function a(){for(var t,i=arguments.length,l=new Array(i),d=0;d<i;d++)l[d]=arguments[d];return t=s.call.apply(s,[this].concat(l))||this,t.appliedClasses={appear:{},enter:{},exit:{}},t.onEnter=function(m,u){var g=t.resolveArguments(m,u),h=g[0],C=g[1];t.removeClasses(h,"exit"),t.addClass(h,C?"appear":"enter","base"),t.props.onEnter&&t.props.onEnter(m,u)},t.onEntering=function(m,u){var g=t.resolveArguments(m,u),h=g[0],C=g[1],y=C?"appear":"enter";t.addClass(h,y,"active"),t.props.onEntering&&t.props.onEntering(m,u)},t.onEntered=function(m,u){var g=t.resolveArguments(m,u),h=g[0],C=g[1],y=C?"appear":"enter";t.removeClasses(h,y),t.addClass(h,y,"done"),t.props.onEntered&&t.props.onEntered(m,u)},t.onExit=function(m){var u=t.resolveArguments(m),g=u[0];t.removeClasses(g,"appear"),t.removeClasses(g,"enter"),t.addClass(g,"exit","base"),t.props.onExit&&t.props.onExit(m)},t.onExiting=function(m){var u=t.resolveArguments(m),g=u[0];t.addClass(g,"exit","active"),t.props.onExiting&&t.props.onExiting(m)},t.onExited=function(m){var u=t.resolveArguments(m),g=u[0];t.removeClasses(g,"exit"),t.addClass(g,"exit","done"),t.props.onExited&&t.props.onExited(m)},t.resolveArguments=function(m,u){return t.props.nodeRef?[t.props.nodeRef.current,m]:[m,u]},t.getClassNames=function(m){var u=t.props.classNames,g=typeof u=="string",h=g&&u?u+"-":"",C=g?""+h+m:u[m],y=g?C+"-active":u[m+"Active"],M=g?C+"-done":u[m+"Done"];return{baseClassName:C,activeClassName:y,doneClassName:M}},t}var r=a.prototype;return r.addClass=function(i,l,d){var m=this.getClassNames(l)[d+"ClassName"],u=this.getClassNames("enter"),g=u.doneClassName;l==="appear"&&d==="done"&&g&&(m+=" "+g),d==="active"&&i&&is(i),m&&(this.appliedClasses[l][d]=m,Fs(i,m))},r.removeClasses=function(i,l){var d=this.appliedClasses[l],m=d.base,u=d.active,g=d.done;this.appliedClasses[l]={},m&&Ne(i,m),u&&Ne(i,u),g&&Ne(i,g)},r.render=function(){var i=this.props;i.classNames;var l=He(i,["classNames"]);return $.createElement(ls,Ve({},l,{onEnter:this.onEnter,onEntered:this.onEntered,onEntering:this.onEntering,onExit:this.onExit,onExiting:this.onExiting,onExited:this.onExited}))},a}($.Component);Me.defaultProps={classNames:""};Me.propTypes={};const Os=Me;function Se(s,a){var r=function(l){return a&&n.isValidElement(l)?a(l):l},t=Object.create(null);return s&&n.Children.map(s,function(i){return i}).forEach(function(i){t[i.key]=r(i)}),t}function zs(s,a){s=s||{},a=a||{};function r(h){return h in a?a[h]:s[h]}var t=Object.create(null),i=[];for(var l in s)l in a?i.length&&(t[l]=i,i=[]):i.push(l);var d,m={};for(var u in a){if(t[u])for(d=0;d<t[u].length;d++){var g=t[u][d];m[t[u][d]]=r(g)}m[u]=r(u)}for(d=0;d<i.length;d++)m[i[d]]=r(i[d]);return m}function Y(s,a,r){return r[a]!=null?r[a]:s.props[a]}function Gs(s,a){return Se(s.children,function(r){return n.cloneElement(r,{onExited:a.bind(null,r),in:!0,appear:Y(r,"appear",s),enter:Y(r,"enter",s),exit:Y(r,"exit",s)})})}function Bs(s,a,r){var t=Se(s.children),i=zs(a,t);return Object.keys(i).forEach(function(l){var d=i[l];if(n.isValidElement(d)){var m=l in a,u=l in t,g=a[l],h=n.isValidElement(g)&&!g.props.in;u&&(!m||h)?i[l]=n.cloneElement(d,{onExited:r.bind(null,d),in:!0,exit:Y(d,"exit",s),enter:Y(d,"enter",s)}):!u&&m&&!h?i[l]=n.cloneElement(d,{in:!1}):u&&m&&n.isValidElement(g)&&(i[l]=n.cloneElement(d,{onExited:r.bind(null,d),in:g.props.in,exit:Y(d,"exit",s),enter:Y(d,"enter",s)}))}}),i}var Hs=Object.values||function(s){return Object.keys(s).map(function(a){return s[a]})},Vs={component:"div",childFactory:function(a){return a}},Ie=function(s){Be(a,s);function a(t,i){var l;l=s.call(this,t,i)||this;var d=l.handleExited.bind(Ps(l));return l.state={contextValue:{isMounting:!0},handleExited:d,firstRender:!0},l}var r=a.prototype;return r.componentDidMount=function(){this.mounted=!0,this.setState({contextValue:{isMounting:!1}})},r.componentWillUnmount=function(){this.mounted=!1},a.getDerivedStateFromProps=function(i,l){var d=l.children,m=l.handleExited,u=l.firstRender;return{children:u?Gs(i,m):Bs(i,d,m),firstRender:!1}},r.handleExited=function(i,l){var d=Se(this.props.children);i.key in d||(i.props.onExited&&i.props.onExited(l),this.mounted&&this.setState(function(m){var u=Ve({},m.children);return delete u[i.key],{children:u}}))},r.render=function(){var i=this.props,l=i.component,d=i.childFactory,m=He(i,["component","childFactory"]),u=this.state.contextValue,g=Hs(this.state.children).map(d);return delete m.appear,delete m.enter,delete m.exit,l===null?$.createElement(Pe.Provider,{value:u},g):$.createElement(Pe.Provider,{value:u},$.createElement(l,m,g))},a}($.Component);Ie.propTypes={};Ie.defaultProps=Vs;const $s=Ie,Je=({message:s})=>{const[a,r]=n.useState(!1),t=n.useRef(null),i=()=>{r(!a)};return n.useEffect(()=>{a&&t.current&&setTimeout(()=>{var l;(l=t.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})},50)},[a]),e.jsx(e.Fragment,{children:e.jsxs("div",{ref:t,className:"small",children:[e.jsxs("div",{className:"d-flex gap-1 align-items-start",children:[e.jsx($e,{className:"flex-shrink-0"}),e.jsx(ee,{size:20,avatarImage:s.userAvatar}),e.jsx(se,{userId:s.userId,userName:"@"+s.userName}),s.deleted?e.jsx("i",{className:"text-muted",children:"Deleted"}):e.jsx("span",{className:`wb-channels-reply__text ${a?"wb-channels-reply__text--expanded":""}`,onClick:i,style:{cursor:"pointer"},children:s.content})]}),a&&!s.deleted&&e.jsx("div",{className:"wb-channels-reply__full-content",onClick:i,style:{cursor:"pointer"},children:s.content})]})})},Us=42,Oe=$.forwardRef(({message:s,showHeader:a,onContextMenu:r},t)=>{const i=n.useRef(null),l=n.useRef(null),d=C=>{C.preventDefault(),!(s.type!==1||s.deleted)&&r(s,i.current)},m=()=>{l.current=setTimeout(()=>{s.type!==1||s.deleted||r(s,i.current)},500)},u=()=>{l.current&&clearTimeout(l.current)},g=()=>{l.current&&clearTimeout(l.current)};let h;if(s.type!==1){const C=s.content.split("{action_user}");h=e.jsx("div",{className:"d-flex justify-content-center",children:e.jsxs("div",{className:"p-2 rounded text-center wb-channels-message__body",children:[C[0],e.jsx(se,{userId:s.userId,userName:s.userName}),C[1]]})})}else h=e.jsxs("div",{className:"d-flex",children:[a&&e.jsx("div",{className:"me-2 flex-shrink-0",children:e.jsx(ee,{avatarImage:s.userAvatar,size:Us})}),e.jsxs("div",{className:"flex-grow-1",children:[a&&e.jsxs("div",{className:"d-flex align-items-center mb-1",children:[e.jsx(se,{className:"fw-bold",userId:s.userId,userName:s.userName}),e.jsx("small",{className:"text-muted ms-2",children:Ge.format(new Date(s.createdAt))})]}),e.jsxs("div",{ref:i,className:`p-2 rounded wb-channels-message__body ${a?"":"ms-5 indented"}`,onContextMenu:d,onTouchStart:m,onTouchMove:u,onTouchEnd:g,children:[s.deleted?e.jsx("i",{className:"text-muted",children:"Message was deleted"}):s.content,!s.deleted&&new Date(s.createdAt)<new Date(s.updatedAt)&&e.jsx("small",{className:"text-muted",children:" (edited)"}),!s.deleted&&e.jsx("div",{children:s.attachments.map(C=>e.jsx("div",{className:"mt-2",children:e.jsx(As,{data:C})},C.id))})]})]})]});return h=e.jsxs("div",{style:{maxWidth:"720px"},children:[s.repliedTo&&e.jsx("div",{className:"ms-5 indented",children:e.jsx(Je,{message:s.repliedTo})}),h]}),e.jsx("div",{ref:t,className:"wb-channels-message",children:h})}),Ws=({channel:s,onUserInvite:a,onUserRemove:r,onCancelInvite:t,onTitleChange:i,onRoleChange:l,onToggleNotifications:d})=>{var K,de,re,ue,me;const[m,u]=n.useState("general"),[g,h]=n.useState(""),[C,y]=n.useState(""),[M,D]=n.useState(!0),{userInfo:c}=Ee(),{sendJsonRequest:E}=te(),[N,p]=n.useState({}),[k,O]=n.useState({}),[P,w]=n.useState(!1),[S,b]=n.useState(!1),[j,L]=n.useState(null),[_,G]=n.useState("");n.useEffect(()=>{u("general")},[s==null?void 0:s.id]),n.useEffect(()=>{p({}),O({}),m=="general"&&(y(s.title??""),D(!s.muted))},[m]);const x=(K=s.participants)==null?void 0:K.find(v=>v.userId==(c==null?void 0:c.id)),I=(x==null?void 0:x.role)==="Owner",B=I||(x==null?void 0:x.role)==="Admin",ne=()=>{w(!1)},X=()=>{b(!1)},H=()=>{L(null),G("")},ve=async v=>{const z=await E("/Channels/GroupInviteUser","POST",{channelId:s.id,userId:v});z&&z.invite?(p({message:"Invite created successfully"}),a({...z.invite,authorId:c==null?void 0:c.id,authorName:c==null?void 0:c.name,authorAvatar:c==null?void 0:c.avatarImage})):p({errors:z==null?void 0:z.error}),h("")},oe=async()=>{if(!j)return;const v=await E("/Channels/GroupRemoveUser","POST",{channelId:s.id,userId:j});v&&v.success&&(r(j),H())},pe=async()=>{if(j&&_){const v=await E("/Channels/GroupChangeRole","POST",{channelId:s.id,userId:j,role:_});v&&v.success&&(l(v.data.userId,v.data.role),H())}},ce=async()=>{if(s.title==C.trim())return;const v=await E("/Channels/GroupRename","POST",{channelId:s.id,title:C.trim()});v&&v.success?(O({message:"Title changed successfully"}),i(v.data.title)):O({errors:v==null?void 0:v.error})},ae=async()=>{await E("/Channels/LeaveChannel","POST",{channelId:s.id})},W=async()=>{await E("/Channels/DeleteChannel","POST",{channelId:s.id})},Z=async v=>{const z=await E("/Channels/GroupCancelInvite","POST",{inviteId:v});z&&z.success&&t(v)},je=async v=>{const z=await E("/Channels/MuteChannel","POST",{channelId:s.id,muted:!v});z&&z.success&&(d(v),D(!z.data.muted))},J=(de=s.participants)==null?void 0:de.find(v=>v.userId==j);return e.jsxs(e.Fragment,{children:[e.jsxs(A,{style:{zIndex:"1070"},backdropClassName:"wb-channels-room-modal__backdrop",show:P,onHide:ne,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Are you sure?"})}),e.jsx(A.Body,{children:"Channel will be permanently deleted."}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:ne,children:"Cancel"}),e.jsx(T,{variant:"danger",onClick:W,children:"Delete"})]})]}),e.jsxs(A,{style:{zIndex:"1070"},backdropClassName:"wb-channels-room-modal__backdrop",show:S,onHide:X,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Are you sure?"})}),e.jsx(A.Body,{children:"You won't be able to join again unless you are reinvited."}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:X,children:"Cancel"}),e.jsx(T,{variant:"danger",onClick:ae,children:"Leave"})]})]}),e.jsxs(A,{style:{zIndex:"1070"},backdropClassName:"wb-channels-room-modal__backdrop",show:j!==null,onHide:H,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:J==null?void 0:J.userName})}),e.jsx(A.Body,{children:J&&e.jsxs(q.Group,{controlId:"participantRole",children:[e.jsx(q.Label,{children:"Role"}),e.jsxs(q.Select,{size:"sm",value:_||J.role,onChange:v=>G(v.target.value),disabled:!I,children:[e.jsx("option",{value:"Owner",children:"Owner"}),e.jsx("option",{value:"Admin",children:"Admin"}),e.jsx("option",{value:"Member",children:"Member"})]}),_==="Owner"&&I&&e.jsx("div",{className:"mt-2 text-sm text-warning",children:"By assigning this user as Owner, your role will be changed to Admin."})]})}),e.jsxs(A.Footer,{children:[e.jsx(T,{size:"sm",variant:"secondary",onClick:H,children:"Cancel"}),e.jsx(T,{size:"sm",variant:"danger",onClick:oe,children:"Remove"}),I&&e.jsx(T,{size:"sm",variant:"primary",onClick:pe,children:"Save"})]})]}),e.jsx(U.Container,{activeKey:m,onSelect:v=>u(v||"general"),children:e.jsxs(ds,{children:[e.jsx(Le,{sm:3,children:e.jsxs(V,{variant:"pills",className:"flex-column mb-2",children:[e.jsx(V.Item,{children:e.jsx(V.Link,{eventKey:"general",children:"General"})}),s.type==2&&e.jsx(V.Item,{children:e.jsx(V.Link,{eventKey:"members",children:"Members"})})]})}),e.jsx(Le,{sm:9,children:e.jsxs(U.Content,{children:[s.type==2&&e.jsxs(U.Pane,{eventKey:"members",children:[B&&e.jsxs("div",{className:"mb-3",children:[e.jsx(q.Label,{children:"Invite user"}),e.jsx(ks,{value:g,setValue:h,onSelect:v=>ve(v.id)}),e.jsx(we,{errors:N.errors,message:N.message})]}),B&&e.jsxs(e.Fragment,{children:[e.jsx("h5",{children:"Invites"}),e.jsxs(le,{children:[(re=s.invites)==null?void 0:re.map(v=>e.jsxs(le.Item,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"d-flex flex-column",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(ee,{avatarImage:v.invitedUserAvatar,size:36}),e.jsx(se,{userId:v.invitedUserId??"",userName:v.invitedUserName??"Unknown"})]}),e.jsxs("small",{className:"text-muted ms-5",children:["Invited by ",v.authorName]})]}),e.jsx(T,{variant:"outline-danger",size:"sm",onClick:()=>Z(v.id),children:"Cancel"})]},v.id)),((ue=s.invites)==null?void 0:ue.length)===0&&e.jsx(le.Item,{className:"text-muted fst-italic",children:"No invites"})]})]}),e.jsx("h5",{children:"Members"}),e.jsx(le,{children:(me=s.participants)==null?void 0:me.map(v=>e.jsxs(le.Item,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(ee,{avatarImage:v.userAvatar,size:32}),e.jsx(se,{userId:v.userId,userName:v.userName}),e.jsx(Ue,{bg:"secondary",children:v.role})]}),B&&v.role!="Owner"&&v.userId!==(c==null?void 0:c.id)&&e.jsx("div",{className:"d-flex align-items-center gap-2",children:e.jsx(T,{variant:"outline-primary",size:"sm",onClick:()=>{L(v.userId),G(v.role)},children:e.jsx(We,{})})})]},v.userId))})]}),e.jsxs(U.Pane,{eventKey:"general",children:[s.type==2&&I&&e.jsxs("div",{className:"mb-3",children:[e.jsx(q.Label,{children:"Channel Name"}),e.jsxs(us,{children:[e.jsx(q.Control,{size:"sm",value:C,onChange:v=>y(v.target.value)}),e.jsx(T,{size:"sm",onClick:ce,variant:"primary",disabled:C.trim().length<3,children:"Save"})]}),e.jsx(we,{errors:k.errors,message:k.message})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("span",{className:"me-3",children:"Notifications"}),e.jsx(Ts,{value:M,onChange:v=>je(v.target.checked)})]}),s.type==1||I?e.jsx("div",{children:e.jsx(T,{size:"sm",variant:"danger",onClick:()=>w(!0),children:"Delete Channel"})}):e.jsx("div",{children:e.jsx(T,{size:"sm",variant:"outline-danger",onClick:()=>b(!0),children:"Leave Channel"})})]})]})})]})})]})},Js=(s,a,r,t,i,l)=>{const{sendJsonRequest:d}=te(),[m,u]=n.useState([]),[g,h]=n.useState(!1),[C,y]=n.useState(""),[M,D]=n.useState(!1),{socket:c}=ye(),E=async(P,w)=>{h(!0),y("");const S=await d("/Channels/Messages","POST",{fromDate:P,count:s,channelId:a});S&&S.messages?(u(b=>w?S.messages:[...b,...S.messages]),D(S.messages.length===s)):y((S==null?void 0:S.error[0].message)??"Something went wrong"),h(!1)};n.useEffect(()=>{a&&E(null,!0)},[a]),n.useEffect(()=>{!a||r===null||E(r,!1)},[r]),n.useEffect(()=>{if(!c)return()=>{};const P=j=>{j.channelId===a&&(j.type==2?t({userId:j.userId,userName:j.userName,userAvatar:j.userAvatar,role:"Member"}):j.type==3&&i(j.userId),u(L=>[j,...L]))},w=j=>{l(j.lastActiveAt)},S=j=>{u(L=>L.map(_=>_.id==j.messageId?{..._,deleted:!0}:_))},b=j=>{u(L=>L.map(_=>_.id==j.messageId?{..._,content:j.content,attachments:j.attachments,updatedAt:j.updatedAt}:_))};return c.on("channels:new_message",P),c.on("channels:messages_seen",w),c.on("channels:message_deleted",S),c.on("channels:message_edited",b),()=>{c.off("channels:new_message",P),c.off("channels:messages_seen",w),c.off("channels:message_deleted",S),c.off("channels:message_edited",b)}},[c,a]);const N=n.useCallback(()=>{c&&c.emit("channels:messages_seen",{channelId:a})},[c,a]),p=n.useCallback((P,w)=>{c&&c.emit("channels:send_message",{channelId:a,content:P,repliedTo:w&&w.id})},[c,a]),k=n.useCallback(P=>{c&&c.emit("channels:delete_message",{channelId:a,messageId:P})},[c,a]),O=n.useCallback((P,w)=>{c&&c.emit("channels:edit_message",{channelId:a,messageId:P,content:w})},[c,a]);return{isLoading:g,error:C,results:m,hasNextPage:M,markMessagesSeen:N,sendMessage:p,deleteMessage:k,editMessage:O}},Q=8,Ks=({visible:s,onClose:a,onCopy:r,onEdit:t,onDelete:i,onReply:l,isOwn:d,anchorRef:m})=>{const u=n.useRef(null),[g,h]=n.useState({top:0,left:0}),C=()=>{if(!u.current||!m.current)return;const y=u.current,{offsetWidth:M,offsetHeight:D}=y,c=m.current.getBoundingClientRect();let E=c.bottom,N=c.left;E+D>window.innerHeight-Q&&(E=c.top-D),N+M>window.innerWidth-Q&&(N=c.right-M),E=Math.min(Math.max(Q,E),window.innerHeight-D-Q),N=Math.min(Math.max(Q,N),window.innerWidth-M-Q),h({top:E,left:N})};return n.useLayoutEffect(()=>{s&&C()},[s]),n.useEffect(()=>{if(!s)return;let y=!0;const M=setTimeout(()=>{y=!1},250),D=p=>{u.current&&!u.current.contains(p.target)&&a()},c=p=>{p.key==="Escape"&&a()},E=()=>C(),N=()=>{y?C():a()};return document.addEventListener("mousedown",D),document.addEventListener("keydown",c),window.addEventListener("resize",E),window.addEventListener("scroll",N,!0),()=>{clearTimeout(M),document.removeEventListener("mousedown",D),document.removeEventListener("keydown",c),window.removeEventListener("resize",E),window.removeEventListener("scroll",N,!0)}},[s,a]),s?e.jsxs("div",{ref:u,role:"menu",className:"position-fixed bg-white border rounded shadow-sm fs-6",style:{top:g.top,left:g.left,zIndex:2e3,minWidth:160},children:[e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none",onClick:r,children:[e.jsx(ms,{className:"me-1 text-muted"})," Copy text"]}),e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none",onClick:l,children:[e.jsx($e,{className:"me-1 text-muted"})," Reply to"]}),d&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none",onClick:t,children:[e.jsx(hs,{className:"me-1 text-muted"})," Edit"]}),e.jsxs("button",{type:"button",role:"menuitem",className:"w-100 text-start d-flex align-items-center px-2 py-1 btn btn-link text-decoration-none text-danger",onClick:i,children:[e.jsx(fs,{className:"me-1"})," Delete"]})]})]}):null},qs=5,Ys=({channelId:s,onExit:a})=>{const[r,t]=n.useState(null),[i,l]=n.useState(null),{userInfo:d}=Ee(),h=Js(50,s,i,o=>{t(f=>f?{...f,participants:[...f.participants,o],invites:f.invites.filter(R=>R.invitedUserId!=o.userId)}:null)},o=>{t(f=>f?{...f,participants:f.participants.filter(R=>R.userId!=o)}:null)},o=>{t(f=>f?{...f,lastActiveAt:o}:null)}),[C,y]=n.useState(""),M=n.useRef(null),[D,c]=n.useState(!1),{sendJsonRequest:E}=te(),N=n.useRef(null),[p,k]=n.useState(!1),[O,P]=n.useState(!1),[w,S]=n.useState(!1),[b,j]=n.useState(0),L=n.useRef(!0),_=n.useRef(null),[G,x]=n.useState(null),[I,B]=n.useState(null),ne=n.useRef(null),[X,H]=n.useState(null),[ve,oe]=n.useState(!0),[pe,ce]=n.useState(!1),[ae,W]=n.useState(null);n.useEffect(()=>{de(),l(null),P(!0),c(!1),oe(!0)},[s]),n.useEffect(()=>{r&&!r.lastActiveAt&&h.markMessagesSeen()},[r==null?void 0:r.id]),n.useEffect(()=>{const o=M.current;if(!o)return;o.rows=1;const f=parseInt(window.getComputedStyle(o).lineHeight,10),R=Math.ceil(o.scrollHeight/f)-1;o.rows=Math.min(R,qs)},[C]),n.useEffect(()=>{var o,f;I?(y(I.content),(o=M.current)==null||o.focus()):(y(""),(f=M.current)==null||f.blur())},[I]);const Z=n.useRef(),je=n.useCallback(o=>{h.isLoading||(Z.current&&Z.current.disconnect(),Z.current=new IntersectionObserver(f=>{f[0].isIntersecting&&h.hasNextPage&&l(()=>new Date(h.results[h.results.length-1].createdAt))}),o&&Z.current.observe(o))},[h.isLoading,h.hasNextPage,h.results.length]);n.useEffect(()=>{const o=N.current;if(!o)return;const f=()=>{const R=o.scrollTop,F=Math.abs(R)<5;L.current=F,S(!F),F&&b>0&&j(0),F&&h.results.length>0&&(r!=null&&r.lastActiveAt)&&new Date(r.lastActiveAt)<new Date(h.results[0].createdAt)&&(t(ie=>ie?{...ie,lastActiveAt:h.results[0].createdAt}:null),h.markMessagesSeen())};return f(),o.addEventListener("scroll",f),()=>o.removeEventListener("scroll",f)},[h.results.length,r==null?void 0:r.id,b]),n.useEffect(()=>{if(h.results.length>0){const o=new Date(h.results[0].createdAt);if(_.current&&o>_.current){const f=h.results.filter(R=>new Date(R.createdAt)>_.current).length;L.current?K("smooth"):j(R=>R+f)}_.current=o}},[h.results.length]),n.useEffect(()=>{h.results.length>0&&h.results[0].userId==(d==null?void 0:d.id)&&k((r==null?void 0:r.lastActiveAt)!=null&&new Date(r.lastActiveAt)<new Date(h.results[0].createdAt))},[h.results.length,r==null?void 0:r.id,d]),n.useEffect(()=>{p&&K("smooth"),k(!1)},[p]),n.useEffect(()=>{O&&!h.isLoading&&h.results.length>0&&(K("auto"),P(!1),oe(!1))},[O,h.isLoading,h.results]);const J=()=>/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent),K=(o="smooth")=>{setTimeout(()=>{const f=N.current;f&&f.scrollTo({top:0,behavior:o})},50)},de=async()=>{ce(!0);const o=await E("/Channels/GetChannel","POST",{channelId:s,includeParticipants:!0,includeInvites:!0});o&&o.channel&&t(o.channel),ce(!1)},re=async()=>{C.trim().length!==0&&(I?(h.editMessage(I.id,C),B(null)):h.sendMessage(C,ae),y(""),W(null))},ue=o=>{J()||o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),re())},me=()=>{c(o=>!o)},v=o=>{t(f=>f?{...f,participants:f.participants.filter(R=>R.userId!=o)}:null)},z=o=>{t(f=>f?{...f,invites:[...f.invites,o]}:null)},Ke=o=>{t(f=>f?{...f,invites:f.invites.filter(R=>R.id!=o)}:null)},qe=o=>{t(f=>f?{...f,title:o}:null)},Ye=(o,f)=>{t(R=>R?{...R,participants:R.participants.map(F=>F.userId==o?{...F,role:f}:F.userId==(d==null?void 0:d.id)&&f==="Owner"?{...F,role:"Admin"}:F)}:null)},Xe=o=>{t(f=>f?{...f,muted:!o}:null)},Ae=(o,f)=>{!f||o.type!==1||o.deleted||(x(o),ne.current=f)},Ce=()=>{H(null)},Ze=()=>{X&&h.deleteMessage(X),H(null),Ce()},Qe=()=>{B(null)},es=()=>{G&&navigator.clipboard.writeText(G.content),x(null)},ss=()=>{B(null),W(null),x(o=>(o&&H(o.id),null))},ts=()=>{H(null),W(null),x(o=>(o&&B(o),null))},ns=()=>{H(null),B(null),x(o=>{var f;return o&&(W(o),(f=M.current)==null||f.focus()),null})},as=o=>{y(f=>(f.trim().length==0||f.endsWith(`
`)?f:f+`
`)+o.join(`
`)+`
`)};let he;const fe=h.results.filter(o=>p||(r==null?void 0:r.lastActiveAt)&&new Date(r.lastActiveAt)>=new Date(o.createdAt));return e.jsxs("div",{className:"d-flex flex-column",style:{height:"100dvh"},children:[r!==null?e.jsxs(e.Fragment,{children:[e.jsxs(A,{show:X!==null,onHide:Ce,centered:!0,children:[e.jsx(A.Header,{closeButton:!0,children:e.jsx(A.Title,{children:"Are you sure?"})}),e.jsx(A.Body,{children:"Selected message will be deleted."}),e.jsxs(A.Footer,{children:[e.jsx(T,{variant:"secondary",onClick:Ce,children:"Cancel"}),e.jsx(T,{variant:"danger",onClick:Ze,children:"Delete"})]})]}),e.jsxs("div",{className:"d-flex align-items-center justify-content-between p-3 border-bottom z-3 bg-white",style:{height:"44px"},children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(T,{variant:"link",className:"text-secondary",onClick:a,children:e.jsx(xe,{})}),e.jsx("h5",{className:"mb-0",children:r.title})]}),e.jsx(T,{variant:"secondary",size:"sm",onClick:me,children:D?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"me-1"})," Settings"]}):e.jsxs(e.Fragment,{children:[e.jsx(xs,{className:"me-1"})," Settings"]})})]}),e.jsxs("div",{className:"d-flex flex-column flex-grow-1 overflow-hidden",children:[e.jsx("div",{className:"wb-channels-settings bg-light p-3 z-2 "+(D?"":" wb-channels-settings__closed"),children:e.jsx(Ws,{channel:r,onUserRemove:v,onUserInvite:z,onCancelInvite:Ke,onTitleChange:qe,onRoleChange:Ye,onToggleNotifications:Xe})}),e.jsx("div",{className:"d-flex flex-column-reverse flex-grow-1 overflow-y-auto p-3 ms-lg-5",ref:N,children:e.jsx($s,{component:null,children:fe.map((o,f)=>{const R=f<fe.length-1?fe[f+1]:null;let F=!1;if(!R)F=!0;else if(R.userId!==o.userId||R.type!==1)F=!0,he=new Date(R.createdAt).getTime();else{const ie=new Date(o.createdAt).getTime();f===0&&(he=ie);const Te=new Date(R.createdAt).getTime();Math.abs(Te-he)>2*60*1e3&&(F=!0,he=Te)}return e.jsx(Os,{timeout:300,classNames:ve?"":"wb-channels-message",children:e.jsx("div",{className:"mt-2",children:f===fe.length-1?e.jsx(Oe,{ref:je,message:o,showHeader:F||o.repliedTo!=null,onContextMenu:Ae}):e.jsx(Oe,{message:o,showHeader:F||o.repliedTo!=null,onContextMenu:Ae})})},o.id)})})}),e.jsxs("div",{className:"position-relative p-2 border-top",children:[I&&e.jsx("div",{className:"small",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"fw-bold text-info",children:[e.jsx(We,{})," Edit message"]}),e.jsx(T,{size:"sm",variant:"link",className:"text-muted",onClick:Qe,children:e.jsx(xe,{})})]})}),ae&&e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"flex-grow-1",style:{minWidth:0},children:e.jsx(Je,{message:ae})}),e.jsx(T,{size:"sm",variant:"link",className:"text-muted ms-2 p-0 flex-shrink-0",onClick:()=>W(null),children:e.jsx(xe,{})})]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[w&&e.jsxs(T,{size:"sm",variant:"secondary",className:"position-absolute end-0 me-3 mt-1 z-1",style:{top:"-50px"},onClick:()=>{K("smooth"),j(0)},children:[b>0&&e.jsx(Ue,{bg:"info",className:"me-2",children:b+" new message"+(b>1?"s":"")}),e.jsx(gs,{})]}),e.jsx(q.Control,{ref:M,as:"textarea",rows:1,placeholder:"Type your message...",value:C,onChange:o=>y(o.target.value),onKeyDown:ue,className:"me-2 border-0",maxLength:1024,style:{resize:"none",boxShadow:"none"}}),e.jsx(Rs,{onSubmit:as}),C.trim().length>0&&e.jsx(T,{variant:"primary",onClick:re,children:I?e.jsx(vs,{}):e.jsx(ps,{})})]})]})]})]}):e.jsx("div",{className:"flex-grow-1 d-flex flex-column justify-content-center align-items-center text-center",children:pe?e.jsx(be,{}):e.jsxs("div",{children:[e.jsx("h4",{children:"Channel not found"}),e.jsxs(T,{onClick:a,variant:"primary",children:[e.jsx(js,{}),"Back to Channels"]})]})}),e.jsx(Ks,{visible:G!==null,onClose:()=>x(null),onCopy:es,onEdit:ts,onDelete:ss,onReply:ns,isOwn:(G==null?void 0:G.userId)===(d==null?void 0:d.id),anchorRef:ne})]})},ze=()=>{const{channelId:s}=Cs(),a=Ns();ws("Channels | Webler Codes");const r=i=>{a(`/Channels/${i}`)},t=()=>{a("/Channels")};return e.jsxs(e.Fragment,{children:[e.jsx(A,{show:s!=null,onHide:t,fullscreen:!0,className:"p-0 m-0",contentClassName:"h-100",children:e.jsx(A.Body,{className:"p-0 m-0 d-flex flex-column",children:s&&e.jsx(Ys,{channelId:s,onExit:t})})}),e.jsx(bs,{fluid:!0,children:e.jsx("div",{className:"wb-channels-container",children:e.jsx(Ds,{onChannelSelect:r,currentChannelId:s??null,onExit:t})})})]})};const ot=()=>e.jsx(ys,{children:e.jsx(ge,{element:e.jsx(Es,{Header:e.jsx(Ms,{variant:"light",hideChannelsButton:!0}),Footer:null}),children:e.jsxs(ge,{element:e.jsx(Ss,{allowedRoles:Is}),children:[e.jsx(ge,{index:!0,element:e.jsx(ze,{})}),e.jsx(ge,{path:":channelId",element:e.jsx(ze,{})})]})})});export{ot as default};
