import{aQ as Me,r as n,aR as Ae,j as e,aS as Le,aT as Oe,aU as ze,W as ie,aV as $e,X as oe,aW as Be,aX as He,b as le,J as ce,u as D,a9 as Ue,v as De,P as Pe,c as We,av as Ge,D as Je,R as qe,B as L,m as Xe,aY as Ye,aa as Qe,ab as Ke}from"./index-9d7e4363.js";import{P as Ze}from"./UserSearch-1f319494.js";import{p as es,R as ss,P as ts}from"./ReactionsList-8f912bd1.js";import{M as B}from"./Modal-de9b5942.js";var Q=Math.pow(2,31)-1;function de(s,a,o){var r=o-Date.now();s.current=r<=Q?setTimeout(a,r):setTimeout(function(){return de(s,a,o)},Q)}function ns(){var s=Me(),a=n.useRef();return Ae(function(){return clearTimeout(a.current)}),n.useMemo(function(){var o=function(){return clearTimeout(a.current)};function r(u,i){i===void 0&&(i=0),s()&&(o(),i<=Q?a.current=setTimeout(u,i):de(a,u,Date.now()+i))}return{set:r,clear:o}},[])}const as={[Oe]:"showing",[ze]:"showing show"},ue=n.forwardRef((s,a)=>e.jsx(Le,{...s,ref:a,transitionClasses:as}));ue.displayName="ToastFade";const rs=ue,is=n.createContext({onClose(){}}),me=is,he=n.forwardRef(({bsPrefix:s,closeLabel:a="Close",closeVariant:o,closeButton:r=!0,className:u,children:i,...I},p)=>{s=ie(s,"toast-header");const d=n.useContext(me),S=$e(C=>{d==null||d.onClose==null||d.onClose(C)});return e.jsxs("div",{ref:p,...I,className:oe(s,u),children:[i,r&&e.jsx(Be,{"aria-label":a,variant:o,onClick:S,"data-dismiss":"toast"})]})});he.displayName="ToastHeader";const os=he,ls=He("toast-body"),fe=n.forwardRef(({bsPrefix:s,className:a,transition:o=rs,show:r=!0,animation:u=!0,delay:i=5e3,autohide:I=!1,onClose:p,bg:d,...S},C)=>{s=ie(s,"toast");const v=n.useRef(i),f=n.useRef(p);n.useEffect(()=>{v.current=i,f.current=p},[i,p]);const b=ns(),x=!!(I&&r),m=n.useCallback(()=>{x&&(f.current==null||f.current())},[x]);n.useEffect(()=>{b.set(m,v.current)},[b,m]);const V=n.useMemo(()=>({onClose:p}),[p]),F=!!(o&&u),g=e.jsx("div",{...S,ref:C,className:oe(s,a,d&&`bg-${d}`,!F&&(r?"show":"hide")),role:"alert","aria-live":"assertive","aria-atomic":"true"});return e.jsx(me.Provider,{value:V,children:F&&o?e.jsx(o,{in:r,unmountOnExit:!0,children:g}):g})});fe.displayName="Toast";const ae=Object.assign(fe,{Body:ls,Header:os}),re=({comment:s,repliesVisible:a,handleToggleReplies:o,handleReply:r,handleEdit:u,handleDelete:i,handleShowVotes:I,isHighlighted:p,onVote:d})=>{const{userInfo:S}=le(),C=ce(),{sendJsonRequest:v}=D(),f=async()=>{if(!S){C("/Users/Login");return}const b=s.isUpvoted?0:1,x=await v("/Discussion/VotePost","POST",{postId:s.id,vote:b});x.success&&x.vote===b?d(s.id,x.vote):d(s.id,0,x.error)};return e.jsxs("div",{className:"d-flex position-relative gap-2",children:[e.jsx("div",{className:"wb-comments__options",children:e.jsx("div",{className:"d-flex gap-2",children:S&&S.id===s.userId&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"wb-comments__options__item",onClick:u,children:e.jsx(Ue,{})}),e.jsx("span",{className:"wb-comments__options__item",onClick:i,children:e.jsx(De,{})})]})})}),e.jsx("div",{children:e.jsx(Pe,{size:32,avatarImage:s.userAvatar??null})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"rounded border p-2 mb-1",style:{background:p?"beige":"white"},children:[e.jsx("div",{children:e.jsx(We,{userId:s.userId,userName:s.userName})}),e.jsx("div",{className:"wb-comments__message mt-2",children:es(s.message)}),e.jsx("div",{className:"mt-2",children:s.attachments.map(b=>e.jsx("div",{className:"mt-1",children:e.jsx(Ze,{data:b})},b.id))})]}),e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"d-flex gap-2 align-items-center",children:[e.jsxs("div",{className:"small",children:[e.jsx("span",{className:"wb-icon-button"+(s.isUpvoted?" text-black":""),onClick:f,children:e.jsx(Ge,{})}),s.votes>0?e.jsx("span",{className:"ms-1",style:{cursor:"pointer"},onClick:I,children:s.votes}):e.jsx("span",{className:"ms-1",children:s.votes})]}),e.jsx("button",{className:"small wb-comments__footer__reply-btn",onClick:r,children:"Reply"}),s.parentId===null&&s.answers>0&&e.jsx(e.Fragment,{children:e.jsxs("button",{className:"small wb-comments__footer__replies "+(a?"text-secondary":"text-black"),onClick:o,children:[s.answers," replies"]})})]}),e.jsx("div",{children:e.jsx("div",{children:e.jsx("small",{className:"text-secondary",children:Je.format2(new Date(s.date),!0)})})})]})]})]})},cs=(s,a,o,r,u)=>{const[i,I]=n.useState({firstIndex:r&&r.length>0?r[0].index:0,lastIndex:r&&r.length>0?r[r.length-1].index:0,direction:"dont load"}),[p,d]=n.useState(r||[]),[S,C]=n.useState(!1),[v,f]=n.useState(r!==null&&r.length==u),{sendJsonRequest:b}=D();return n.useEffect(()=>{(async()=>{if(i.direction==="dont load"||!a)return;C(!0);const j=await b(`/${s.section}/GetComments`,"POST",{...s.params,parentId:o,findPostId:null,count:i.direction==="from start"?Math.min(i.firstIndex,u):u,index:i.direction==="from start"?Math.max(0,i.firstIndex-u):i.lastIndex,filter:2});j&&j.posts&&(d(R=>{const k=j.posts.filter(h=>!R.some(w=>w.id===h.id));return i.direction==="from start"?[...k,...R]:[...R,...k]}),i.direction==="from end"&&f(j.posts.length===u)),C(!1)})()},[i]),n.useEffect(()=>{a&&I(g=>({...g,direction:r!==null?"dont load":"from end"}))},[s,o,r,a]),{results:p,setState:I,loading:S,hasNextPage:v,createReply:g=>{d(j=>[g,...j])},editReply:(g,j)=>{d(R=>R.map(k=>k.id==g?j(k):k))},deleteReply:g=>{d(j=>{const R=[];let k=!1;for(let h of j)h.id===g?k=!0:R.push({...h,index:k?h.index-1:h.index});return R})},getFirstValidCommentIndex:()=>{const g=p.find(j=>j.index>=0);return g?g.index:0}}},ds=qe.forwardRef(({options:s,comment:a,defaultReplies:o,onDelete:r,onEdit:u,onReply:i,onShowVotes:I,highlightedCommentId:p,onVote:d},S)=>{const[C,v]=n.useState(o!==null),{results:f,setState:b,loading:x,hasNextPage:m,getFirstValidCommentIndex:V,createReply:F,editReply:g,deleteReply:j}=cs(s,C,a.id,o,10),R=n.useRef(),k=n.useCallback(l=>{x||(R.current&&R.current.disconnect(),R.current=new IntersectionObserver(N=>{N[0].isIntersecting&&m&&f.length>0&&b(O=>({...O,lastIndex:f[f.length-1].index+1,direction:"from end"}))}),l&&R.current.observe(l))},[x,m,f]);n.useEffect(()=>{a.answers==0&&v(!1)},[a.answers]);const h=()=>{b(l=>({...l,firstIndex:V(),direction:"from start"}))},w=()=>{v(!0),i(a.id,l=>{F(l)})},E=()=>{u(a)},_=()=>{r(a)},y=()=>{v(l=>!l)},M=l=>{u(l,g)},z=l=>{v(!0),i(a.id,N=>{F(N)},`[user id="${l.userId}"]${l.userName}[/user] `)},P=l=>{r(l,N=>{j(N)})},$=(l,N)=>{g(l,O=>({...O,votes:O.votes+2*N-1,isUpvoted:N==1}))};return e.jsxs("div",{className:"mb-3",ref:S,children:[e.jsx(re,{comment:a,repliesVisible:C,handleDelete:_,handleEdit:E,handleReply:w,handleToggleReplies:y,handleShowVotes:()=>I(a.id),isHighlighted:p===a.id,onVote:d}),C&&e.jsxs("div",{className:"ms-5 mt-2",children:[f.length>0&&V()>0&&e.jsx(L,{variant:"primary",size:"sm",className:"mb-2 w-100",onClick:h,disabled:x,children:"Load Previous"}),f.map((l,N)=>e.jsx("div",{className:"mb-2",ref:f.length-1==N?k:void 0,children:e.jsx(re,{comment:l,handleDelete:()=>P(l),handleEdit:()=>M(l),handleReply:()=>z(l),handleShowVotes:()=>I(l.id),isHighlighted:p===l.id,onVote:$})},l.id))]})]})}),us=(s,a,o,r,u)=>{const[i,I]=n.useState({firstIndex:0,lastIndex:0,direction:"dont load"}),[p,d]=n.useState([]),[S,C]=n.useState(!1),[v,f]=n.useState(!1),[b,x]=n.useState(!1),[m,V]=n.useState([]),{sendJsonRequest:F}=D();return n.useEffect(()=>{(async()=>{if(i.direction==="dont load")return;V([]),C(!0);const w=await F(`/${s.section}/GetComments`,"POST",{...s.params,parentId:null,findPostId:b?null:a,count:i.direction==="from start"?Math.min(i.firstIndex,r):r,index:i.direction==="from start"?Math.max(0,i.firstIndex-r):i.lastIndex,filter:o});w&&w.posts?(d(E=>{const _=w.posts.filter(y=>!E.some(M=>M.id===y.id));return i.direction==="from start"?[..._,...E]:[...E,..._]}),i.direction==="from end"&&f(w.posts.length===r),x(!0)):V(w.error),C(!1)})()},[i]),n.useEffect(()=>{d([]),I({firstIndex:0,lastIndex:0,direction:"from end"})},[s,o,u]),{results:p,setState:I,loading:S,createComment:h=>{d(w=>[h,...w])},editComment:(h,w)=>{d(E=>E.map(_=>_.id==h?w(_):_))},deleteComment:h=>{d(w=>{const E=[];let _=!1;for(let y of w)y.id===h?_=!0:E.push({...y,index:_?y.index-1:y.index});return E})},hasNextPage:v,getFirstValidCommentIndex:()=>{const h=p.find(w=>w.index>=0);return h?h.index:0},error:m}};const ps=({findPost:s,options:a,setCommentCount:o})=>{var te;const[r,u]=n.useState(!(s!=null&&s.isReply)),[i,I]=n.useState(s?2:1),[p,d]=n.useState(!1),[S,C]=n.useState(!1),[v,f]=n.useState(""),[b,x]=n.useState(!1),[m,V]=n.useState(null),[F,g]=n.useState(null),j=n.useRef(null),[R,k]=n.useState(),[h,w]=n.useState(),[E,_]=n.useState(),[y,M]=n.useState({success:!0}),[z,P]=n.useState((s==null?void 0:s.id)||null),$=n.useRef(null),l=n.useRef(null),{userInfo:N}=le(),{sendJsonRequest:O}=D(),{results:A,setState:K,loading:W,createComment:xe,editComment:H,deleteComment:pe,hasNextPage:Z,getFirstValidCommentIndex:ee,error:G}=us(a,s?s.id:null,i,10,r),[ge,se]=n.useState(!1),[ve,je]=n.useState({parentId:""}),we=ce();n.useEffect(()=>{if(z){const t=setTimeout(()=>{P(null)},3e3);return()=>clearTimeout(t)}},[z]),n.useEffect(()=>{G&&M({success:!1,errors:G})},[G]);const U=n.useRef(),Ce=n.useCallback(t=>{W||(U.current&&U.current.disconnect(),U.current=new IntersectionObserver(c=>{c[0].isIntersecting&&Z&&A.length>0&&K(T=>({...T,lastIndex:A[A.length-1].index+1,direction:"from end"}))}),t&&U.current.observe(t))},[W,Z,A]),Re=t=>{I(Number(t.target.value))},Ne=()=>{u(!0)},J=(t,c,T="")=>{N||we("/Users/Login"),f(T),V(t),g(c),C(!0),setTimeout(()=>{l.current&&l.current.focus()})},q=()=>{C(!1),f(""),V(null)},be=async()=>{if(!N)return;x(!0);const t=await O(`/${a.section}/CreateComment`,"POST",{...a.params,parentId:F,message:v});if(t&&t.post){const c={...t.post,index:-1,userName:N.name,userAvatar:N.avatarImage};F?(R==null||R(c),H(F,T=>({...T,answers:T.answers+1})),setTimeout(()=>{j.current&&j.current.scrollIntoView({behavior:"smooth",block:"start"})})):(xe(c),setTimeout(()=>{$.current&&$.current.scrollTo({top:0,behavior:"smooth"})})),o==null||o(T=>T+1),M({success:!0,message:F?"Reply posted successfully":"Comment posted successfully"}),q()}else M({success:!1,errors:t==null?void 0:t.error});x(!1)},ye=async()=>{if(m){x(!0);const t=await O(`/${a.section}/EditComment`,"PUT",{message:v,id:m.id});t&&t.success?(m.parentId?h==null||h(t.data.id,c=>({...c,message:t.data.message,attachments:t.data.attachments})):H(t.data.id,c=>({...c,message:t.data.message,attachments:t.data.attachments})),M({success:!0,message:m.parentId?"Reply edited successfully":"Comment edited successfully"}),q()):M({success:!1,errors:t==null?void 0:t.error}),x(!1)}},Ie=async()=>{if(m){x(!0);const t=await O(`/${a.section}/DeleteComment`,"DELETE",{id:m.id});t&&t.success?(m.parentId?(E==null||E(m.id),H(m.parentId,c=>({...c,answers:c.answers-1}))):pe(m.id),o==null||o(c=>c-m.answers-1),M({success:!0,message:m.parentId?"Reply deleted successfully":"Comment deleted successfully"})):M({success:!1,errors:t==null?void 0:t.error}),x(!1),X()}},X=()=>{d(!1),V(null)},Se=()=>{se(!1)},Te=()=>{K(t=>({...t,firstIndex:ee(),direction:"from start"}))},Fe=(t,c,T)=>{k(()=>c),J(null,t,T)},ke=(t,c)=>{w(()=>c),J(t,t.parentId,t.message)},Ee=(t,c)=>{_(()=>c),V(t),d(!0)},Ve=(t,c,T)=>{T?M({success:!1,errors:T}):H(t,ne=>({...ne,votes:ne.votes+2*c-1,isUpvoted:c==1}))},_e=t=>{je({parentId:t}),se(!0)};let Y=b||W;return e.jsxs(e.Fragment,{children:[e.jsxs(B,{style:{zIndex:1070},backdropClassName:"wb-reactions-modal__backdrop",size:"sm",show:p,onHide:X,centered:!0,children:[e.jsx(B.Header,{closeButton:!0,children:e.jsx(B.Title,{children:"Are you sure?"})}),e.jsx(B.Body,{children:"Your answer will be permanently deleted."}),e.jsxs(B.Footer,{children:[e.jsx(L,{variant:"secondary",onClick:X,children:"Cancel"}),e.jsx(L,{variant:"danger",onClick:Ie,children:"Delete"})]})]}),e.jsx(ss,{title:"Likes",options:ve,visible:ge,onClose:Se,showReactions:!0,countPerPage:10}),e.jsx("div",{className:"d-flex justify-content-between",children:r?e.jsx("div",{className:"col-6 col-sm-4",children:e.jsxs(Xe.Select,{size:"sm",value:i,onChange:Re,children:[e.jsx("option",{value:"1",children:"Most Popular"}),e.jsx("option",{value:"2",children:"Oldest"}),e.jsx("option",{value:"3",children:"Most recent"})]})}):e.jsxs(L,{onClick:Ne,variant:"link",size:"sm",children:[e.jsx(Ye,{}),"Back to all comments"]})}),e.jsxs("div",{className:"mt-1 pe-1 flex-grow-1 overflow-auto",ref:$,children:[A.length>0&&ee()>0&&r&&e.jsx(L,{variant:"primary",size:"sm",className:"mb-2 w-100",onClick:Te,disabled:Y,children:"Load Previous"}),(r?A:A.slice(0,1)).map((t,c)=>{let T=e.jsx(ds,{ref:c===A.length-1?Ce:void 0,options:a,comment:t,defaultReplies:s!=null&&s.isReply&&!r?A.slice(1):null,onDelete:Ee,onEdit:ke,onReply:Fe,onShowVotes:_e,highlightedCommentId:z,onVote:Ve});return t.id==F?e.jsx("div",{ref:j,children:T},t.id):e.jsx("div",{children:T},t.id)})]}),e.jsx(ae,{className:"position-absolute",style:{zIndex:"999",bottom:"68px",width:"90%"},bg:y.success?"success":"danger",onClose:()=>M(t=>({success:t.success})),show:y.errors&&y.errors.length>0||!!y.message,delay:2500,autohide:!0,children:e.jsx(ae.Body,{className:"text-white",children:e.jsx("b",{children:y.success?y.message:y.errors?(te=y.errors[0])==null?void 0:te.message:""})})}),e.jsxs("div",{className:"py-2 border-top",children:[e.jsx(L,{hidden:S,size:"sm",variant:"primary",className:"ms-2",onClick:()=>J(null,null),children:"Write comment"}),e.jsxs("div",{hidden:!S,children:[e.jsxs(Qe,{children:[e.jsx(Ke,{children:e.jsx("b",{children:N==null?void 0:N.name})}),e.jsx(ts,{ref:l,size:"sm",value:v,setValue:f,placeholder:"Write your comment here...",rows:5})]}),e.jsxs("div",{className:"d-flex justify-content-end mt-2",children:[e.jsx(L,{size:"sm",variant:"secondary",className:"ms-2",onClick:q,children:"Cancel"}),m===null?e.jsx(L,{size:"sm",className:"ms-2",variant:"primary",onClick:be,disabled:Y||v.length===0,children:F?"Post Reply":"Post Comment"}):e.jsx(L,{size:"sm",variant:"primary",className:"ms-2",onClick:ye,disabled:Y||v.length===0,children:"Save changes"})]})]})]})]})};export{ps as C,ae as T};
