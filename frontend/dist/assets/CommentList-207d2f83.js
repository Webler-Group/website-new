import{r as n,j as e,f as oe,d as ie,g as D,R as Me}from"./index-c193dc40.js";import{e as Ae,v as Le,h as Oe,y as ze}from"./index.esm-70a25315.js";import{P as Be}from"./PostAttachment-f38b6576.js";import{P as $e,D as He}from"./DateUtils-1d735d3b.js";import{p as Ue,P as De}from"./PostTextareaControl-56ef6c20.js";import{P as Pe}from"./ProfileAvatar-bb4fbb5b.js";import{B as L}from"./Button-b8db3fe4.js";import{R as Ge}from"./ReactionsList-03ae5412.js";import{M as $}from"./Modal-261a0993.js";import{F as qe,a as Je,b as We}from"./Form-19731f2f.js";import{u as le,c as ce}from"./ThemeProvider-ec2a0fef.js";import{u as Xe}from"./useWindow-822d8a97.js";import{u as Ye}from"./AbstractModalHeader-72c903dd.js";import{F as Ke,b as Qe,a as Ze,C as es}from"./CloseButton-710dc957.js";import{u as ss}from"./Anchor-22c8f756.js";import{c as ts}from"./createWithBsPrefix-6b62a92d.js";var K=Math.pow(2,31)-1;function de(s,a,i){var r=i-Date.now();s.current=r<=K?setTimeout(a,r):setTimeout(function(){return de(s,a,i)},K)}function ns(){var s=Xe(),a=n.useRef();return Ye(function(){return clearTimeout(a.current)}),n.useMemo(function(){var i=function(){return clearTimeout(a.current)};function r(u,o){o===void 0&&(o=0),s()&&(i(),o<=K?a.current=setTimeout(u,o):de(a,u,Date.now()+o))}return{set:r,clear:i}},[])}const as={[Qe]:"showing",[Ze]:"showing show"},ue=n.forwardRef((s,a)=>e.jsx(Ke,{...s,ref:a,transitionClasses:as}));ue.displayName="ToastFade";const rs=ue,os=n.createContext({onClose(){}}),me=os,fe=n.forwardRef(({bsPrefix:s,closeLabel:a="Close",closeVariant:i,closeButton:r=!0,className:u,children:o,...I},p)=>{s=le(s,"toast-header");const d=n.useContext(me),S=ss(C=>{d==null||d.onClose==null||d.onClose(C)});return e.jsxs("div",{ref:p,...I,className:ce(s,u),children:[o,r&&e.jsx(es,{"aria-label":a,variant:i,onClick:S,"data-dismiss":"toast"})]})});fe.displayName="ToastHeader";const is=fe,ls=ts("toast-body"),he=n.forwardRef(({bsPrefix:s,className:a,transition:i=rs,show:r=!0,animation:u=!0,delay:o=5e3,autohide:I=!1,onClose:p,bg:d,...S},C)=>{s=le(s,"toast");const v=n.useRef(o),h=n.useRef(p);n.useEffect(()=>{v.current=o,h.current=p},[o,p]);const N=ns(),x=!!(I&&r),m=n.useCallback(()=>{x&&(h.current==null||h.current())},[x]);n.useEffect(()=>{N.set(m,v.current)},[N,m]);const V=n.useMemo(()=>({onClose:p}),[p]),F=!!(i&&u),g=e.jsx("div",{...S,ref:C,className:ce(s,a,d&&`bg-${d}`,!F&&(r?"show":"hide")),role:"alert","aria-live":"assertive","aria-atomic":"true"});return e.jsx(me.Provider,{value:V,children:F&&i?e.jsx(i,{in:r,unmountOnExit:!0,children:g}):g})});he.displayName="Toast";const ae=Object.assign(he,{Body:ls,Header:is}),re=({comment:s,repliesVisible:a,handleToggleReplies:i,handleReply:r,handleEdit:u,handleDelete:o,handleShowVotes:I,isHighlighted:p,onVote:d})=>{const{userInfo:S}=oe(),C=ie(),{sendJsonRequest:v}=D(),h=async()=>{if(!S){C("/Users/Login");return}const N=s.isUpvoted?0:1,x=await v("/Discussion/VotePost","POST",{postId:s.id,vote:N});x.success&&x.vote===N?d(s.id,x.vote):d(s.id,0,x.error)};return e.jsxs("div",{className:"d-flex position-relative gap-2",children:[e.jsx("div",{className:"wb-user-comment__options",children:e.jsx("div",{className:"d-flex gap-2",children:S&&S.id===s.userId&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"wb-user-comment__options__item",onClick:u,children:e.jsx(Ae,{})}),e.jsx("span",{className:"wb-user-comment__options__item",onClick:o,children:e.jsx(Le,{})})]})})}),e.jsx("div",{children:e.jsx("div",{className:"wb-p-follow-item__avatar",children:e.jsx(Pe,{size:32,avatarImage:s.userAvatar??null})})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"rounded border p-2 mb-1",style:{background:p?"beige":"white"},children:[e.jsx("div",{children:e.jsx($e,{userId:s.userId,userName:s.userName})}),e.jsx("div",{className:"wb-playground-comments__message mt-2",children:Ue(s.message)}),e.jsx("div",{className:"mt-2",children:s.attachments.map(N=>e.jsx("div",{className:"mt-1",children:e.jsx(Be,{data:N})},N.id))})]}),e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"d-flex gap-2 align-items-center",children:[e.jsxs("div",{className:"small",children:[e.jsx("span",{className:"wb-discuss-voting__button"+(s.isUpvoted?" text-black":""),onClick:h,children:e.jsx(Oe,{})}),s.votes>0?e.jsx("span",{className:"ms-1 wb-playground-comments__button",onClick:I,children:s.votes}):e.jsx("span",{className:"ms-1",children:s.votes})]}),e.jsx("button",{className:"small wb-user-comment-footer__reply",onClick:r,children:"Reply"}),s.parentId===null&&s.answers>0&&e.jsx(e.Fragment,{children:e.jsxs("button",{className:"small wb-user-comment-footer__replies "+(a?"text-secondary":"text-black"),onClick:i,children:[s.answers," replies"]})})]}),e.jsx("div",{children:e.jsx("div",{children:e.jsx("small",{className:"text-secondary",children:He.format2(new Date(s.date),!0)})})})]})]})]})},cs=(s,a,i,r,u)=>{const[o,I]=n.useState({firstIndex:r&&r.length>0?r[0].index:0,lastIndex:r&&r.length>0?r[r.length-1].index:0,direction:"dont load"}),[p,d]=n.useState(r||[]),[S,C]=n.useState(!1),[v,h]=n.useState(r!==null&&r.length==u),{sendJsonRequest:N}=D();return n.useEffect(()=>{(async()=>{if(o.direction==="dont load"||!a)return;C(!0);const j=await N(`/${s.section}/GetComments`,"POST",{...s.params,parentId:i,findPostId:null,count:o.direction==="from start"?Math.min(o.firstIndex,u):u,index:o.direction==="from start"?Math.max(0,o.firstIndex-u):o.lastIndex,filter:2});j&&j.posts&&(d(R=>{const k=j.posts.filter(f=>!R.some(w=>w.id===f.id));return o.direction==="from start"?[...k,...R]:[...R,...k]}),o.direction==="from end"&&h(j.posts.length===u)),C(!1)})()},[o]),n.useEffect(()=>{a&&I(g=>({...g,direction:r!==null?"dont load":"from end"}))},[s,i,r,a]),{results:p,setState:I,loading:S,hasNextPage:v,createReply:g=>{d(j=>[g,...j])},editReply:(g,j)=>{d(R=>R.map(k=>k.id==g?j(k):k))},deleteReply:g=>{d(j=>{const R=[];let k=!1;for(let f of j)f.id===g?k=!0:R.push({...f,index:k?f.index-1:f.index});return R})},getFirstValidCommentIndex:()=>{const g=p.find(j=>j.index>=0);return g?g.index:0}}},ds=Me.forwardRef(({options:s,comment:a,defaultReplies:i,onDelete:r,onEdit:u,onReply:o,onShowVotes:I,highlightedCommentId:p,onVote:d},S)=>{const[C,v]=n.useState(i!==null),{results:h,setState:N,loading:x,hasNextPage:m,getFirstValidCommentIndex:V,createReply:F,editReply:g,deleteReply:j}=cs(s,C,a.id,i,10),R=n.useRef(),k=n.useCallback(l=>{x||(R.current&&R.current.disconnect(),R.current=new IntersectionObserver(b=>{b[0].isIntersecting&&m&&h.length>0&&N(O=>({...O,lastIndex:h[h.length-1].index+1,direction:"from end"}))}),l&&R.current.observe(l))},[x,m,h]);n.useEffect(()=>{a.answers==0&&v(!1)},[a.answers]);const f=()=>{N(l=>({...l,firstIndex:V(),direction:"from start"}))},w=()=>{v(!0),o(a.id,l=>{F(l)})},E=()=>{u(a)},_=()=>{r(a)},y=()=>{v(l=>!l)},M=l=>{u(l,g)},z=l=>{v(!0),o(a.id,b=>{F(b)},`[user id="${l.userId}"]${l.userName}[/user] `)},P=l=>{r(l,b=>{j(b)})},B=(l,b)=>{g(l,O=>({...O,votes:O.votes+2*b-1,isUpvoted:b==1}))};return e.jsxs("div",{className:"mb-3",ref:S,children:[e.jsx(re,{comment:a,repliesVisible:C,handleDelete:_,handleEdit:E,handleReply:w,handleToggleReplies:y,handleShowVotes:()=>I(a.id),isHighlighted:p===a.id,onVote:d}),C&&e.jsxs("div",{className:"ms-5 mt-2",children:[h.length>0&&V()>0&&e.jsx(L,{variant:"primary",size:"sm",className:"mb-2 w-100",onClick:f,disabled:x,children:"Load Previous"}),h.map((l,b)=>e.jsx("div",{className:"mb-2",ref:h.length-1==b?k:void 0,children:e.jsx(re,{comment:l,handleDelete:()=>P(l),handleEdit:()=>M(l),handleReply:()=>z(l),handleShowVotes:()=>I(l.id),isHighlighted:p===l.id,onVote:B})},l.id))]})]})}),us=(s,a,i,r,u)=>{const[o,I]=n.useState({firstIndex:0,lastIndex:0,direction:"dont load"}),[p,d]=n.useState([]),[S,C]=n.useState(!1),[v,h]=n.useState(!1),[N,x]=n.useState(!1),[m,V]=n.useState([]),{sendJsonRequest:F}=D();return n.useEffect(()=>{(async()=>{if(o.direction==="dont load")return;V([]),C(!0);const w=await F(`/${s.section}/GetComments`,"POST",{...s.params,parentId:null,findPostId:N?null:a,count:o.direction==="from start"?Math.min(o.firstIndex,r):r,index:o.direction==="from start"?Math.max(0,o.firstIndex-r):o.lastIndex,filter:i});w&&w.posts?(d(E=>{const _=w.posts.filter(y=>!E.some(M=>M.id===y.id));return o.direction==="from start"?[..._,...E]:[...E,..._]}),o.direction==="from end"&&h(w.posts.length===r),x(!0)):V(w.error),C(!1)})()},[o]),n.useEffect(()=>{d([]),I({firstIndex:0,lastIndex:0,direction:"from end"})},[s,i,u]),{results:p,setState:I,loading:S,createComment:f=>{d(w=>[f,...w])},editComment:(f,w)=>{d(E=>E.map(_=>_.id==f?w(_):_))},deleteComment:f=>{d(w=>{const E=[];let _=!1;for(let y of w)y.id===f?_=!0:E.push({...y,index:_?y.index-1:y.index});return E})},hasNextPage:v,getFirstValidCommentIndex:()=>{const f=p.find(w=>w.index>=0);return f?f.index:0},error:m}},Ts=({findPost:s,options:a,setCommentCount:i})=>{var te;const[r,u]=n.useState(!(s!=null&&s.isReply)),[o,I]=n.useState(s?2:1),[p,d]=n.useState(!1),[S,C]=n.useState(!1),[v,h]=n.useState(""),[N,x]=n.useState(!1),[m,V]=n.useState(null),[F,g]=n.useState(null),j=n.useRef(null),[R,k]=n.useState(),[f,w]=n.useState(),[E,_]=n.useState(),[y,M]=n.useState({success:!0}),[z,P]=n.useState((s==null?void 0:s.id)||null),B=n.useRef(null),l=n.useRef(null),{userInfo:b}=oe(),{sendJsonRequest:O}=D(),{results:A,setState:Q,loading:G,createComment:xe,editComment:H,deleteComment:pe,hasNextPage:Z,getFirstValidCommentIndex:ee,error:q}=us(a,s?s.id:null,o,10,r),[ge,se]=n.useState(!1),[ve,je]=n.useState({parentId:""}),we=ie();n.useEffect(()=>{if(z){const t=setTimeout(()=>{P(null)},3e3);return()=>clearTimeout(t)}},[z]),n.useEffect(()=>{q&&M({success:!1,errors:q})},[q]);const U=n.useRef(),Ce=n.useCallback(t=>{G||(U.current&&U.current.disconnect(),U.current=new IntersectionObserver(c=>{c[0].isIntersecting&&Z&&A.length>0&&Q(T=>({...T,lastIndex:A[A.length-1].index+1,direction:"from end"}))}),t&&U.current.observe(t))},[G,Z,A]),Re=t=>{I(Number(t.target.value))},be=()=>{u(!0)},J=(t,c,T="")=>{b||we("/Users/Login"),h(T),V(t),g(c),C(!0),setTimeout(()=>{l.current&&l.current.focus()})},W=()=>{C(!1),h(""),V(null)},Ne=async()=>{if(!b)return;x(!0);const t=await O(`/${a.section}/CreateComment`,"POST",{...a.params,parentId:F,message:v});if(t&&t.post){const c={...t.post,index:-1,userName:b.name,userAvatar:b.avatarImage};F?(R==null||R(c),H(F,T=>({...T,answers:T.answers+1})),setTimeout(()=>{j.current&&j.current.scrollIntoView({behavior:"smooth",block:"start"})})):(xe(c),setTimeout(()=>{B.current&&B.current.scrollTo({top:0,behavior:"smooth"})})),i==null||i(T=>T+1),M({success:!0,message:F?"Reply posted successfully":"Comment posted successfully"}),W()}else M({success:!1,errors:t==null?void 0:t.error});x(!1)},ye=async()=>{if(m){x(!0);const t=await O(`/${a.section}/EditComment`,"PUT",{message:v,id:m.id});t&&t.success?(m.parentId?f==null||f(t.data.id,c=>({...c,message:t.data.message,attachments:t.data.attachments})):H(t.data.id,c=>({...c,message:t.data.message,attachments:t.data.attachments})),M({success:!0,message:m.parentId?"Reply edited successfully":"Comment edited successfully"}),W()):M({success:!1,errors:t==null?void 0:t.error}),x(!1)}},Ie=async()=>{if(m){x(!0);const t=await O(`/${a.section}/DeleteComment`,"DELETE",{id:m.id});t&&t.success?(m.parentId?(E==null||E(m.id),H(m.parentId,c=>({...c,answers:c.answers-1}))):pe(m.id),i==null||i(c=>c-m.answers-1),M({success:!0,message:m.parentId?"Reply deleted successfully":"Comment deleted successfully"})):M({success:!1,errors:t==null?void 0:t.error}),x(!1),X()}},X=()=>{d(!1),V(null)},Se=()=>{se(!1)},Te=()=>{Q(t=>({...t,firstIndex:ee(),direction:"from start"}))},Fe=(t,c,T)=>{k(()=>c),J(null,t,T)},ke=(t,c)=>{w(()=>c),J(t,t.parentId,t.message)},Ee=(t,c)=>{_(()=>c),V(t),d(!0)},Ve=(t,c,T)=>{T?M({success:!1,errors:T}):H(t,ne=>({...ne,votes:ne.votes+2*c-1,isUpvoted:c==1}))},_e=t=>{je({parentId:t}),se(!0)};let Y=N||G;return e.jsxs(e.Fragment,{children:[e.jsxs($,{style:{zIndex:1070},backdropClassName:"wb-reactions-modal__backdrop",size:"sm",show:p,onHide:X,centered:!0,children:[e.jsx($.Header,{closeButton:!0,children:e.jsx($.Title,{children:"Are you sure?"})}),e.jsx($.Body,{children:"Your answer will be permanently deleted."}),e.jsxs($.Footer,{children:[e.jsx(L,{variant:"secondary",onClick:X,children:"Cancel"}),e.jsx(L,{variant:"danger",onClick:Ie,children:"Delete"})]})]}),e.jsx(Ge,{title:"Likes",options:ve,visible:ge,onClose:Se,showReactions:!0,countPerPage:10}),e.jsx("div",{className:"d-flex justify-content-between",children:r?e.jsx("div",{className:"col-6 col-sm-4",children:e.jsxs(qe.Select,{size:"sm",value:o,onChange:Re,children:[e.jsx("option",{value:"1",children:"Most Popular"}),e.jsx("option",{value:"2",children:"Oldest"}),e.jsx("option",{value:"3",children:"Most recent"})]})}):e.jsxs(L,{onClick:be,variant:"link",size:"sm",children:[e.jsx(ze,{}),"Back to all comments"]})}),e.jsxs("div",{className:"mt-1 pe-1 flex-grow-1 overflow-auto",ref:B,children:[A.length>0&&ee()>0&&r&&e.jsx(L,{variant:"primary",size:"sm",className:"mb-2 w-100",onClick:Te,disabled:Y,children:"Load Previous"}),(r?A:A.slice(0,1)).map((t,c)=>{let T=e.jsx(ds,{ref:c===A.length-1?Ce:void 0,options:a,comment:t,defaultReplies:s!=null&&s.isReply&&!r?A.slice(1):null,onDelete:Ee,onEdit:ke,onReply:Fe,onShowVotes:_e,highlightedCommentId:z,onVote:Ve});return t.id==F?e.jsx("div",{ref:j,children:T},t.id):e.jsx("div",{children:T},t.id)})]}),e.jsx(ae,{className:"position-absolute",style:{zIndex:"999",bottom:"68px",width:"90%"},bg:y.success?"success":"danger",onClose:()=>M(t=>({success:t.success})),show:y.errors&&y.errors.length>0||!!y.message,delay:2500,autohide:!0,children:e.jsx(ae.Body,{className:"text-white",children:e.jsx("b",{children:y.success?y.message:y.errors?(te=y.errors[0])==null?void 0:te.message:""})})}),e.jsxs("div",{className:"py-2 border-top",children:[e.jsx(L,{hidden:S,size:"sm",variant:"primary",className:"ms-2",onClick:()=>J(null,null),children:"Write comment"}),e.jsxs("div",{hidden:!S,children:[e.jsxs(Je,{children:[e.jsx(We,{children:e.jsx("b",{children:b==null?void 0:b.name})}),e.jsx(De,{ref:l,size:"sm",value:v,setValue:h,placeholder:"Write your comment here...",rows:5})]}),e.jsxs("div",{className:"d-flex justify-content-end mt-2",children:[e.jsx(L,{size:"sm",variant:"secondary",className:"ms-2",onClick:W,children:"Cancel"}),m===null?e.jsx(L,{size:"sm",className:"ms-2",variant:"primary",onClick:Ne,disabled:Y||v.length===0,children:F?"Post Reply":"Post Comment"}):e.jsx(L,{size:"sm",variant:"primary",className:"ms-2",onClick:ye,disabled:Y||v.length===0,children:"Save changes"})]})]})]})]})};export{Ts as C,ae as T};
